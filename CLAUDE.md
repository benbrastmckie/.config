# Worktree Task: optimize_claude

## Task Metadata
- **Type**: feature
- **Branch**: feature/optimize_claude
- **Created**: 2025-10-09 16:45
- **Worktree**: ../.config-feature-optimize_claude
- **Session ID**: optimize_claude-1760053547

## Objective
[Describe the main goal for this worktree]

## Current Status
- [ ] Planning
- [ ] Implementation
- [ ] Testing
- [ ] Documentation
- [ ] Review

## Claude Context
Tell Claude: "I'm working on optimize_claude in the feature/optimize_claude worktree. The goal is to..."

## Task Notes
[Add worktree-specific context, links, or decisions]


---

# Project Configuration (Inherited from Main Worktree)

# Project Configuration Index

This CLAUDE.md serves as the central configuration and standards index for this project.

## Project Standards and Guidelines

### Core Documentation
- [Claude Code Documentation](.claude/docs/README.md) - Complete index of patterns, guides, workflows, and reference documentation for working with .claude/ system
- [Neovim Configuration Guidelines](nvim/CLAUDE.md) - Coding standards, style guide, and architecture documentation for Neovim configuration
- [Code Standards](nvim/docs/CODE_STANDARDS.md) - Lua coding conventions, module structure, and development process
- [Documentation Standards](nvim/docs/DOCUMENTATION_STANDARDS.md) - Documentation structure, style guide, and content standards

<!-- SECTION: directory_protocols -->
### Directory Protocols

[Used by: /research, /plan, /implement, /list-plans, /list-reports, /list-summaries]

The specifications directory uses a topic-based structure (`specs/{NNN_topic}/`) with artifact subdirectories (plans/, reports/, summaries/, debug/). Topic names are generated by a Haiku LLM agent that analyzes user prompts and creates semantic directory names (e.g., `867_jwt_token_expiration_fix/`). Plans use progressive organization (Level 0 → Level 1 → Level 2) and support phase dependencies for wave-based parallel execution.

Key concepts:
- **Topic-based structure**: All artifacts for a feature in one numbered directory
- **LLM-based naming**: Haiku agent generates semantic names from user descriptions, falls back to `no_name` on failure
- **Plan levels**: Single file → Phase expansion → Stage expansion (on-demand)
- **Phase dependencies**: Enable parallel execution of independent phases (40-60% time savings)
- **Artifact lifecycle**: Debug reports committed, others gitignored

See [Directory Protocols](.claude/docs/concepts/directory-protocols.md) for complete structure, examples, and dependency syntax. See [Topic Naming with LLM](.claude/docs/guides/development/topic-naming-with-llm.md) for naming system details and troubleshooting.
<!-- END_SECTION: directory_protocols -->

<!-- SECTION: testing_protocols -->
## Testing Protocols
[Used by: /test, /test-all, /implement]

See [Testing Protocols](.claude/docs/reference/standards/testing-protocols.md) for complete test discovery, patterns, coverage requirements, and isolation standards.
<!-- END_SECTION: testing_protocols -->

<!-- SECTION: code_standards -->
## Code Standards
[Used by: /implement, /refactor, /plan]

See [Code Standards](.claude/docs/reference/standards/code-standards.md) for complete coding conventions, language-specific standards, architectural requirements, and link conventions.

**Quick Reference - Bash Sourcing**:
- All bash blocks MUST follow three-tier sourcing pattern (enforced by linter and pre-commit hooks)
- Tier 1 libraries (state-persistence.sh, workflow-state-machine.sh, error-handling.sh) require fail-fast handlers
- See [Mandatory Bash Block Sourcing Pattern](.claude/docs/reference/standards/code-standards.md#mandatory-bash-block-sourcing-pattern)
<!-- END_SECTION: code_standards -->

<!-- SECTION: code_quality_enforcement -->
## Code Quality Enforcement
[Used by: all commands, pre-commit hooks, CI validation]

Standards are enforced automatically via pre-commit hooks and unified validation scripts. Violations block commits.

**Quick Reference**:
- Pre-commit hook runs on all staged `.claude/` files
- ERROR-level violations (sourcing, suppression, conditionals) block commits
- WARNING-level issues (README, links) are informational only
- Bypass with `git commit --no-verify` (document justification in commit message)

**Validation Commands**:
```bash
# Run all validators
bash .claude/scripts/validate-all-standards.sh --all

# Run specific validator categories
bash .claude/scripts/validate-all-standards.sh --sourcing      # Library sourcing
bash .claude/scripts/validate-all-standards.sh --suppression   # Error suppression
bash .claude/scripts/validate-all-standards.sh --conditionals  # Bash conditionals
bash .claude/scripts/validate-all-standards.sh --readme        # README structure
bash .claude/scripts/validate-all-standards.sh --links         # Link validity

# Staged files only (pre-commit mode)
bash .claude/scripts/validate-all-standards.sh --staged
```

**Enforcement Tools**:
| Tool | Checks | Severity |
|------|--------|----------|
| check-library-sourcing.sh | Three-tier sourcing, fail-fast handlers | ERROR |
| lint_error_suppression.sh | State persistence suppression, deprecated paths | ERROR |
| lint_bash_conditionals.sh | Preprocessing-unsafe conditionals | ERROR |
| validate-readmes.sh | README structure | WARNING |
| validate-links-quick.sh | Internal link validity | WARNING |

See [Enforcement Mechanisms Reference](.claude/docs/reference/standards/enforcement-mechanisms.md) for complete enforcement details, pre-commit hook installation, and adding new validators.
<!-- END_SECTION: code_quality_enforcement -->

<!-- SECTION: output_formatting -->
## Output Formatting Standards
[Used by: /implement, /build, all commands and agents]

See [Output Formatting Standards](.claude/docs/reference/standards/output-formatting.md) for output suppression patterns, block consolidation rules, comment standards (WHAT not WHY), and console summary format.

**Quick Reference**:
- Suppress library sourcing with `2>/dev/null` while preserving error handling
- Target 2-3 bash blocks per command (Setup/Execute/Cleanup)
- Single summary line per block for interim output (not final completion summaries)
- Console summaries use 4-section format (Summary/Phases/Artifacts/Next Steps) with emoji markers
- Comments describe WHAT code does, not WHY it was designed that way
<!-- END_SECTION: output_formatting -->

<!-- SECTION: error_logging -->
## Error Logging Standards
[Used by: all commands, all agents, /implement, /build, /debug, /errors, /repair]

All commands and agents must integrate centralized error logging for queryable error tracking and cross-workflow debugging.

**Quick Reference**:
1. Source error-handling library: `source "$CLAUDE_LIB/core/error-handling.sh" 2>/dev/null || { echo "Error: Cannot load error-handling library"; exit 1; }`
2. Initialize error log: `ensure_error_log_exists`
3. Set workflow metadata: `COMMAND_NAME="/command"`, `WORKFLOW_ID="workflow_$(date +%s)"`, `USER_ARGS="$*"`
4. Log errors: `log_command_error "$error_type" "$error_message" "$error_details"`
5. Parse subagent errors: `parse_subagent_error "$agent_output" "$agent_name"`

**Error Types**: `state_error`, `validation_error`, `agent_error`, `parse_error`, `file_error`, `timeout_error`, `execution_error`, `dependency_error`

**Error Consumption Workflow**:
1. **Query errors**: `/errors [--command CMD] [--since TIME] [--type TYPE]` to view logged errors
2. **Analyze patterns**: `/repair [--since TIME] [--type TYPE]` to group errors and create fix plan
3. **Implement fixes**: `/build [plan-file]` to execute repair plan

**Quick Commands**:
- View recent errors: `/errors --since 1h --summary`
- Analyze command failures: `/repair --command /build --complexity 2`
- Debug specific error type: `/errors --type state_error --limit 10`

See [Error Handling Pattern](.claude/docs/concepts/patterns/error-handling.md) for complete integration requirements, agent error return protocol, and troubleshooting workflows. See [Errors Command Guide](.claude/docs/guides/commands/errors-command-guide.md) and [Repair Command Guide](.claude/docs/guides/commands/repair-command-guide.md) for error management workflow details.
<!-- END_SECTION: error_logging -->

<!-- SECTION: directory_organization -->
## Directory Organization Standards
[Used by: /implement, /plan, /refactor, all development commands]

See [Directory Organization](.claude/docs/concepts/directory-organization.md) for complete directory structure, file placement rules, decision matrix, and anti-patterns.

**Quick Summary**: `.claude/` contains scripts/ (standalone tools), lib/ (sourced functions), commands/ (slash commands), agents/ (AI assistants), skills/ (model-invoked capabilities), docs/ (documentation), and tests/ (test suites).
<!-- END_SECTION: directory_organization -->

<!-- SECTION: development_philosophy -->
## Development Philosophy
[Used by: /refactor, /implement, /plan, /document]

See [Writing Standards](.claude/docs/concepts/writing-standards.md) for complete development philosophy, clean-break approach, and documentation standards.
<!-- END_SECTION: development_philosophy -->

<!-- SECTION: adaptive_planning -->
## Adaptive Planning
[Used by: /implement]

See [Adaptive Planning Guide](.claude/docs/workflows/adaptive-planning-guide.md) for intelligent plan revision capabilities, automatic triggers, and loop prevention.
<!-- END_SECTION: adaptive_planning -->

<!-- SECTION: adaptive_planning_config -->
## Adaptive Planning Configuration
[Used by: /plan, /expand, /implement, /revise]

See [Adaptive Planning Configuration](.claude/docs/reference/standards/adaptive-planning.md) for complexity thresholds, threshold adjustment guidelines, and configuration ranges.
<!-- END_SECTION: adaptive_planning_config -->

<!-- SECTION: development_workflow -->
## Development Workflow
[Used by: /implement, /plan, /build]

See [Development Workflow](.claude/docs/concepts/development-workflow.md) for complete workflow documentation with spec updater details.
<!-- END_SECTION: development_workflow -->

<!-- SECTION: hierarchical_agent_architecture -->
## Hierarchical Agent Architecture
[Used by: /build, /implement, /plan, /debug]

See [Hierarchical Agent Architecture Overview](.claude/docs/concepts/hierarchical-agents-overview.md) for complete patterns, utilities, templates, and troubleshooting. Documentation is split into focused modules:
- [Coordination](.claude/docs/concepts/hierarchical-agents-coordination.md) - Multi-agent coordination patterns
- [Communication](.claude/docs/concepts/hierarchical-agents-communication.md) - Agent communication protocols
- [Patterns](.claude/docs/concepts/hierarchical-agents-patterns.md) - Design patterns and best practices
<!-- END_SECTION: hierarchical_agent_architecture -->

<!-- SECTION: skills_architecture -->
## Skills Architecture
[Used by: all commands, all agents]

Skills are model-invoked autonomous capabilities that Claude automatically uses when relevant needs are detected. Unlike commands (user-invoked) or agents (task delegation), skills enable autonomous composition and progressive discovery.

**Skills vs Commands vs Agents**:

| Aspect | Skills | Commands | Agents |
|--------|--------|----------|--------|
| Invocation | Autonomous (model-invoked) | Explicit (`/cmd`) | Task delegation |
| Scope | Single focused capability | Quick shortcuts | Complex orchestration |
| Discovery | Automatic | Manual | Manual delegation |
| Composition | Auto-composition | Manual chaining | Coordinates skills |

**Available Skills**:
- `document-converter` - Bidirectional document conversion (Markdown, DOCX, PDF)

**Integration Patterns**:
1. **Autonomous**: Claude detects need and loads skill automatically
2. **Command Delegation**: Commands check availability via STEP 0, delegate via STEP 3.5
3. **Agent Auto-Loading**: Agents use `skills:` frontmatter field for auto-loading

**Skill Availability Check** (for commands):
```bash
SKILL_AVAILABLE=false
if [ -d ".claude/skills/<skill-name>" ] && [ -f ".claude/skills/<skill-name>/SKILL.md" ]; then
  SKILL_AVAILABLE=true
fi
```

See [Skills README](.claude/skills/README.md) for complete skills guide, and [Skills Authoring Standards](.claude/docs/reference/standards/skills-authoring.md) for compliance requirements.
<!-- END_SECTION: skills_architecture -->

<!-- SECTION: state_based_orchestration -->
## State-Based Orchestration Architecture
[Used by: /build, custom orchestrators]

See [State-Based Orchestration Overview](.claude/docs/architecture/state-based-orchestration-overview.md) for complete architecture, migration guide, and performance metrics.
<!-- END_SECTION: state_based_orchestration -->

<!-- SECTION: configuration_portability -->
## Configuration Portability and Command Discovery
[Used by: all commands, project setup, troubleshooting]

See [Duplicate Commands Troubleshooting](.claude/docs/troubleshooting/duplicate-commands.md) for command/agent/hook discovery hierarchy and configuration portability.
<!-- END_SECTION: configuration_portability -->

<!-- SECTION: project_commands -->
## Project-Specific Commands
[Used by: all commands, /help]

See [Command Reference](.claude/docs/reference/standards/command-reference.md) for complete catalog of slash commands with syntax and examples.
<!-- END_SECTION: project_commands -->

<!-- SECTION: quick_reference -->
## Quick Reference
[Used by: all commands]

See [Decision Trees](.claude/docs/reference/decision-trees/README.md) for decision flowcharts, and [Reference Documentation](.claude/docs/reference/README.md) for command/agent references and navigation links.
<!-- END_SECTION: quick_reference -->

<!-- SECTION: documentation_policy -->
## Documentation Policy
[Used by: /document, /plan]

### README Requirements

See [Documentation Standards](.claude/docs/reference/standards/documentation-standards.md) for complete README.md structure requirements, directory classification, and template selection guide.

**Directory Classification Quick Reference**:
- **Active Development** (commands/, agents/, lib/, docs/, tests/, scripts/): README.md required at all levels
- **Utility** (data/, backups/): Root README.md only, documents purpose and lifecycle
- **Temporary** (tmp/): README.md not required (ephemeral content)
- **Archive** (archive/): Timestamped manifests only, no root README
- **Topic-Based** (specs/): Root README.md only, individual topics self-documenting

**Standard README Sections** (for directories requiring README):
- **Purpose**: Clear explanation of directory role
- **Module Documentation**: Documentation for each file/module (active directories only)
- **Usage Examples**: Code examples where applicable
- **Navigation Links**: Links to parent and subdirectory READMEs

### Documentation Format
- Use clear, concise language
- Include code examples with syntax highlighting
- Use Unicode box-drawing for diagrams (see nvim/CLAUDE.md)
- No emojis in file content (UTF-8 encoding issues)
- Follow CommonMark specification
- No historical commentary (see Development Philosophy → Documentation Standards)

### Documentation Updates
- Update documentation with code changes
- Keep examples current with implementation
- Document breaking changes prominently
- Remove any historical markers when updating existing docs
<!-- END_SECTION: documentation_policy -->

<!-- SECTION: standards_discovery -->
## Standards Discovery
[Used by: all commands]

### Discovery Method
Commands should discover standards by:
1. Searching upward from current directory for CLAUDE.md
2. Checking for subdirectory-specific CLAUDE.md files
3. Merging/overriding: subdirectory standards extend parent standards

### Subdirectory Standards
- Subdirectory CLAUDE.md files can override parent standards
- Always check most specific (deepest) CLAUDE.md first
- Fall back to parent standards for missing sections

### Fallback Behavior
When CLAUDE.md not found or incomplete:
- Use sensible language-specific defaults
- Suggest creating/updating CLAUDE.md with `/setup`
- Continue with graceful degradation
<!-- END_SECTION: standards_discovery -->

## Notes
This CLAUDE.md was automatically configured with the `/setup` command.
For updates or improvements, run `/setup` again or edit manually following the established patterns.

Standards sections are marked with `[Used by: commands]` metadata for discoverability.


