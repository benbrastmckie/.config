# Task Standards

## Purpose

Standards for creating, formatting, and managing tasks within the .opencode system. These standards ensure consistency across .claude/specs/TODO.md, IMPLEMENTATION_STATUS.md, and state tracking.

## Core Principles

1.  **Unique IDs**: Every task MUST have a unique ID derived from `state.json`.
2.  **Atomic**: Tasks should be actionable units of work.
3.  **Tracked**: Status and priority must be explicitly tracked using the standard markers.
4.  **Linked**: Tasks must link to relevant artifacts (reports, plans, summaries).
5.  **No emojis**: Task titles, descriptions, and artifacts must not include emojis.

## General Standards

### ID Generation

**Do**:
-   Retrieve Task IDs from `.claude/specs/state.json`.
-   Use the `next_project_number` field.
-   Increment `next_project_number` in `state.json` immediately after use.

**Don't**:
-   Guess the next number by reading `.claude/specs/TODO.md`.
-   Reuse IDs from archived or deleted tasks.

### Formatting Standards

#### Header
-   Format: `### {Task ID}. {Task Title}`
-   Example: `### 90. Implement User Login`

#### Metadata

**Required Fields**:
- **Description**: Clear 2-3 sentence description of the task (50-500 chars, auto-generated by description-clarifier or user-provided)
- **Language**: Task language (lean|markdown|general|python|shell|json|meta, auto-detected by description-clarifier or user-provided)
- **Priority**: Task priority (Low|Medium|High, auto-detected by description-clarifier or user-provided)
- **Effort**: Effort estimate (TBD or time estimate, auto-detected by description-clarifier or user-provided)
- **Status**: Task status ([NOT STARTED]|[IN PROGRESS]|[BLOCKED]|[ABANDONED]|[COMPLETED])

**Optional Fields**:
- **Files Affected**: TBD (override if you know which files)
- **Dependencies**: None (override if task depends on others)
- **Blocking**: None (override if task blocks others)
- **Acceptance Criteria**: Generic checklist (override for specific criteria)
- **Impact**: Generic statement (override for specific impact)

**When to Override Defaults**:

Override Priority when:
- Task is urgent or blocking critical work → High
- Task is nice-to-have or low impact → Low

Override Type when:
- Task involves Lean code → lean
- Task involves meta work (agents, commands, context) → meta
- Task involves specific language → specify language (python, shell, etc.)

Override Effort when:
- You have a better estimate based on task complexity
- Task is known to be quick (<1 hour) or long (>4 hours)

Override Files Affected when:
- You know which files will be modified
- Task is file-specific (e.g., "Fix bug in Foo.lean")

Override Acceptance Criteria when:
- Task has specific, measurable success criteria
- Generic checklist is not sufficient

Override Impact when:
- Task has significant impact on project
- Generic statement doesn't capture importance

#### Content
-   **Files Affected**: List of file paths.
-   **Description**: Clear description of the task.
-   **Acceptance Criteria**: Checkbox list of requirements.
-   **Impact**: Statement of impact.

### Placement

#### .claude/specs/TODO.md
-   Insert under the appropriate Priority section (High, Medium, Low).
-   Reorganization: /todo may regroup pending tasks by kind (feature, documentation, maintenance, research) while preserving numbering and metadata. Completed tasks move to the "Completed" section. Reorganization must not create or modify project directories or artifacts.
-   Maintain lazy directory creation: no directories are created during TODO reordering.

#### IMPLEMENTATION_STATUS.md
-   Add reference: `**Planned Work**: Task {Task ID}: {Task Title}`

## Command Integration

- `/task` **must** use description-clarifier to research and clarify rough task descriptions, then delegate to task-creator for atomic task creation. description-clarifier generates clear 2-3 sentence descriptions and detects metadata (language, priority, effort). task-creator enforces task standards (Description field mandatory, Language field mandatory, metadata format, required fields) and performs atomic TODO.md + state.json updates. Direct file manipulation is forbidden. Users can skip clarification with --skip-clarification flag if providing complete metadata.
- `/implement` **must** reuse the plan link attached in .claude/specs/TODO.md when present and update that plan in place with status markers. When no plan is linked, `/implement` executes directly (no failure) while preserving lazy directory creation (no project roots/subdirs unless an artifact is written) and numbering/state sync; guidance to use `/plan {task}` remains recommended for complex work.
- `/implement`, `/review`, and `/todo` **must** keep IMPLEMENTATION_STATUS.md, SORRY_REGISTRY.md, and TACTIC_REGISTRY.md in sync when they change task/plan/implementation status or sorry/tactic counts.
- `/implement` must emit an implementation summary artifact (standard naming) whenever task execution writes implementation artifacts; status-only paths do not emit summaries. Maintain lazy directory creation.
- `/review`, `/todo`, and `/implement` must capture/populate the `Type` metadata for every task they create or modify; backfill missing Type when encountered.
- `/implement` uses the TODO task `Type` field as the authoritative routing signal. Plan metadata is secondary. If `Type` is missing, warn and default to general unless the user explicitly supplies `--type {type}` (explicit flag wins over metadata when they disagree).
- Commands mirror status markers (`[NOT STARTED]`, `[IN PROGRESS]`, `[BLOCKED]`, `[ABANDONED]`, `[COMPLETED]`) and timestamps between plan files and TODO/state, without altering numbering rules.
- **Lean routing and MCP validation**:
  - Lean research requests **must** use the Lean research subagent; Lean implementation requests **must** use the Lean implementation subagent, selected from the TODO `Type` field (or explicit flag override) rather than heuristics.
  - Validate Lean MCP server availability against `.mcp.json` before dispatch; fail with a clear error if required servers are missing/unreachable or if the command is absent/returns non-zero during a health ping.
  - Default required Lean server: `lean-lsp` (stdio via `uvx lean-lsp-mcp`); planned servers (`lean-explore`, `loogle`, `lean-search`) should raise a "planned/not configured" warning instead of proceeding silently.
  - When validation fails, surface remediation steps (install command, set env like `LEAN_PROJECT_PATH`, supply API keys) and do **not** create project directories or artifacts.

## /task Flag Usage Patterns

The `/task` command supports unified task lifecycle management through flags:

### Task Creation (No Flag)

**Standard Usage**:
```bash
/task "Implement feature X"
/task "Fix bug in module Y" --priority High
/task "Add documentation" --priority Medium --effort "2 hours" --language markdown
```

**Inline Division**:
```bash
/task "Refactor system: update commands, fix agents, improve docs" --divide
# Creates 3 tasks: one for each natural division
```

**Standards**:
- Description is mandatory (non-empty)
- Language auto-detected from keywords or specified via --language flag
- Priority defaults to Medium (Low|Medium|High)
- Effort defaults to TBD
- Creates task entries ONLY (never implements)
- Delegates to task-creator for atomic TODO.md + state.json updates

### Task Recovery (--recover)

**Usage**:
```bash
/task --recover 343                    # Recover single task
/task --recover 343-345                # Recover range
/task --recover 337, 343-345, 350      # Recover list
```

**Standards**:
- Supports range syntax: "343-345" expands to [343, 344, 345]
- Supports list syntax: "337, 343-345" expands to [337, 343, 344, 345]
- All tasks must exist in archive/state.json
- All tasks reset to [NOT STARTED] status
- Atomic operation: all tasks recovered or none
- Updates TODO.md, state.json, archive/state.json
- Moves directories from archive/ to specs/ (if exist, non-critical)

### Task Division (--divide)

**Usage**:
```bash
/task --divide 326                     # Divide task 326
/task --divide 326 "Focus on UI, backend, tests"  # With prompt
```

**Standards**:
- Operates on single task only (no bulk support)
- Task must exist in active_projects
- Task status must allow division (not COMPLETED or ABANDONED)
- Task must have no existing dependencies
- Creates 1-5 subtasks based on analysis
- Parent task updated with dependencies to subtasks
- Rollback on failure: delete created subtasks, restore state
- Delegates to task-divider for analysis, task-creator for subtask creation

### Task Synchronization (--sync)

**Usage**:
```bash
/task --sync                           # Sync all tasks
/task --sync 343-345                   # Sync range
/task --sync 337, 343-345              # Sync list
```

**Standards**:
- Default behavior: sync ALL tasks when no ranges specified
- Supports range/list syntax for selective sync
- Git blame conflict resolution: latest commit wins
- For each field that differs:
  1. Run git blame on TODO.md and state.json
  2. Extract commit timestamps
  3. Use value from file with latest commit
  4. Log conflict resolution details
- Atomic operation: both files updated or neither
- Updates TODO.md and state.json only

**Git Blame Conflict Resolution**:
- Compare timestamps for each differing field
- Latest commit wins (most recent change)
- Tie-breaker: state.json wins (source of truth)
- Log format: "Task 343: status from state.json (2026-01-07) > TODO.md (2026-01-06)"

### Task Abandonment (--abandon)

**Usage**:
```bash
/task --abandon 343-345                # Abandon range
/task --abandon 337, 343-345, 350      # Abandon list
```

**Standards**:
- Supports range/list syntax
- All tasks must exist in active_projects
- Atomic operation: all tasks abandoned or none
- Updates TODO.md, state.json, archive/state.json
- Moves directories from specs/ to archive/ (if exist, non-critical)
- Tasks can be recovered later with --recover

### Bulk Operation Standards

**Range Syntax**:
- Single number: `343`
- Range: `343-345` (inclusive, expands to 343, 344, 345)
- List: `337, 343-345, 350` (comma-separated, expands to 337, 343, 344, 345, 350)
- Validation: All numbers must be positive integers
- Deduplication: Duplicate numbers removed automatically

**Error Reporting**:
- Validate all tasks before processing (all-or-nothing)
- Report all validation errors together (not one at a time)
- Clear error messages: "Task 343 not found in archive"
- Suggest recovery steps: "Use /task --recover to unarchive tasks"

**Atomic Guarantees**:
- Two-phase commit: prepare updates, then commit atomically
- All files updated or none (TODO.md, state.json, archive/state.json)
- Rollback on failure: remove temp files, rely on git for recovery
- No partial updates: either all tasks processed or none

## Quality Checklist

-   [ ] Task ID is unique and retrieved from `state.json`.
-   [ ] Title is clear and descriptive (max 200 chars).
-   [ ] Description is clear and actionable (50-500 chars, 2-3 sentences).
-   [ ] Metadata (Description, Language, Effort, Status, Priority) is complete.
-   [ ] Language field reflects the primary language for the work (e.g., `lean`, `markdown`, `python`, `shell`, `json`, `meta`, `general`).
-   [ ] Dependencies are correctly listed.
-   [ ] Acceptance criteria are testable (if provided).
-   [ ] No emojis are present.
-   [ ] Metadata format uses `- **Field**:` pattern (not `*Field**:` or other variants).
-   [ ] All required fields present (Description, Language, Effort, Priority, Status).

## Troubleshooting

### Missing Description Field

**Problem**: Task is missing the Description field.

**Impact**: 
- Prevents understanding of task purpose and scope
- Breaks automation workflows that depend on Description field
- Violates task standards (Description is MANDATORY per quality checklist)

**Solution**:
1. Add Description field to task metadata in TODO.md:
   ```markdown
   **Description**: {2-3 sentence description of the task}
   ```
2. Ensure description is 50-500 characters
3. Ensure description is clear and actionable
4. Place Description field after metadata fields (Effort, Status, Priority, Language)

**Prevention**:
- Use /task command to create tasks (enforces Description field via description-clarifier)
- Avoid manual editing of TODO.md
- If manual editing required, follow task standards exactly

### Missing Language Field

**Problem**: Task is missing the Language field.

**Impact**: 
- Prevents proper routing to specialized agents (lean-research-agent, lean-implementation-agent, meta subagents)
- Breaks automation workflows that depend on Language field
- Violates task standards (Language is MANDATORY per quality checklist)

**Solution**:
1. Identify the primary language for the task:
   - Lean code tasks → `- **Language**: lean`
   - Documentation tasks → `- **Language**: markdown`
   - General tasks → `- **Language**: general`
   - Python tasks → `- **Language**: python`
   - Shell scripts → `- **Language**: shell`
   - Meta work (agents, commands, context) → `- **Language**: meta`
   - JSON/YAML/TOML tasks → `- **Language**: json`
2. Add Language field to task metadata in TODO.md
3. Ensure Language field is on its own line with correct formatting

**Prevention**:
- Use /task command to create tasks (enforces Language field via description-clarifier)
- Avoid manual editing of TODO.md
- If manual editing required, follow task standards exactly

### Incorrect Metadata Format

**Problem**: Task uses `*Field**:` instead of `- **Field**:` format.

**Impact**:
- Breaks parsing by automation tools
- Violates task standards
- Makes tasks harder to read and maintain

**Solution**:
1. Find all metadata fields using incorrect format (e.g., `*Effort**:`, `*Status**:`)
2. Replace with correct format: `- **Effort**:`, `- **Status**:`
3. Ensure each field is on its own line
4. Verify formatting matches task standards

**Example Fix**:
```markdown
BEFORE (incorrect):
*Effort**: 2 hours
*Status**: [NOT STARTED]
*Language**: lean

AFTER (correct):
- **Effort**: 2 hours
- **Status**: [NOT STARTED]
- **Language**: lean
```

**Prevention**:
- Use /task command to create tasks (enforces correct format)
- Use /review command to create tasks (validates format)
- Avoid manual editing of TODO.md

### Validation Errors from /task Command

**Problem**: /task command rejects task creation with validation error.

**Common Errors**:

1. "Type field is required but could not be detected"
   - Solution: Add `--type lean` (or markdown/general/meta) flag to /task command
   - Example: `/task "Fix bug in Foo.lean" --type lean`

2. "Metadata format must use `- **Field**:` pattern"
   - Solution: This error should not occur with /task command (internal validation)
   - If it occurs: Report as bug in /task command implementation

3. "Required field missing: {field_name}"
   - Solution: This error should not occur with /task command (auto-populates defaults)
   - If it occurs: Report as bug in /task command implementation

**Prevention**:
- Always use /task command for task creation
- Provide --type flag if type detection might fail
- Review task standards before creating tasks

### Validation Errors from /review Command

**Problem**: /review command reports non-compliant tasks after creation.

**Common Violations**:

1. "Task {number} missing required Type field"
   - Solution: Manually add Type field to task in TODO.md
   - Follow format: `- **Type**: {lean|markdown|general|meta}`

2. "Task {number} has incorrect metadata format"
   - Solution: Fix metadata format to use `- **Field**:` pattern
   - Replace `*Field**:` with `- **Field**:`

3. "Task {number} missing required field: {field_name}"
   - Solution: Add missing field to task in TODO.md
   - Follow task standards for field format

**Prevention**:
- Ensure /task command validation is working correctly
- Report validation failures to system maintainers
- Manually verify created tasks comply with standards

## Maintenance

### Archival
-   Completed tasks should be archived when the project is finished.
-   Update `state.json` to move project from `active_projects` to `completed_projects` (and eventually `archive/state.json`).
