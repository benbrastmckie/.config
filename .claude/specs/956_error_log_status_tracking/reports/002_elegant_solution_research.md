# Elegant Solution Research Report

## Date
2025-11-29

## Research Question
How to implement error log status updates elegantly, scoped only to repair-generated plans without modifying /build?

## Executive Summary

The user's feedback is correct: adding logic to `/build` to detect repair plans adds unnecessary complexity and affects all plan implementations. The elegant solution is to:

1. **Enhance the /repair command's prompt to plan-architect** to include a mandatory "Error Status Update" phase in repair plans
2. **No changes to /build** - it continues to work generically for all plans
3. **No changes to plan-architect** - it already handles any phase content we include

This approach keeps the error log lifecycle concern entirely within the `/repair` workflow where it belongs.

## Current Architecture

### How /repair Creates Plans

```
/repair command
    ↓
Invokes repair-analyst (creates error analysis reports)
    ↓
Invokes plan-architect with prompt containing:
    - Feature Description: ${ERROR_DESCRIPTION}
    - Output Path: ${PLAN_PATH}
    - Research Reports: ${REPORT_PATHS_JSON}
    - Workflow Type: research-and-plan
    - Operation Mode: new plan creation
    ↓
plan-architect creates plan at PLAN_PATH
```

### Key Insight

The `/repair` command already provides **workflow-specific context** to plan-architect. We can simply add additional instructions that tell plan-architect to include an error status update phase when the workflow type is "repair".

## Proposed Solution

### Single Change: Enhance /repair's Task Prompt to plan-architect

**Location**: `/home/benjamin/.config/.claude/commands/repair.md`, lines 769-788

**Current Prompt** (repair.md:772-786):
```
prompt: "
    Read and follow ALL behavioral guidelines from:
    ${CLAUDE_PROJECT_DIR}/.claude/agents/plan-architect.md

    You are creating an implementation plan for: repair workflow

    **Workflow-Specific Context**:
    - Feature Description: ${ERROR_DESCRIPTION}
    - Output Path: ${PLAN_PATH}
    - Research Reports: ${REPORT_PATHS_JSON}
    - Workflow Type: research-and-plan
    - Operation Mode: new plan creation

    Execute planning according to behavioral guidelines and return completion signal:
    PLAN_CREATED: ${PLAN_PATH}
  "
```

**Enhanced Prompt** (add after Operation Mode line):
```
prompt: "
    Read and follow ALL behavioral guidelines from:
    ${CLAUDE_PROJECT_DIR}/.claude/agents/plan-architect.md

    You are creating an implementation plan for: repair workflow

    **Workflow-Specific Context**:
    - Feature Description: ${ERROR_DESCRIPTION}
    - Output Path: ${PLAN_PATH}
    - Research Reports: ${REPORT_PATHS_JSON}
    - Workflow Type: research-and-plan
    - Operation Mode: new plan creation

    **REPAIR-SPECIFIC REQUIREMENT**:
    Since this is a repair plan addressing logged errors, you MUST include a final phase
    titled 'Update Error Log Status' as the last phase with these tasks:
    - Verify all fixes are working (tests pass, no new errors)
    - Update error log entries to RESOLVED status using:
      ```bash
      mark_errors_resolved_for_plan \"${PLAN_PATH}\"
      ```
    - Verify no FIX_PLANNED errors remain for this plan

    This phase should depend on all previous phases.

    Execute planning according to behavioral guidelines and return completion signal:
    PLAN_CREATED: ${PLAN_PATH}
  "
```

## Why This Is Elegant

1. **Single Point of Change**: Only `/repair` command needs modification
2. **No /build Changes**: Build continues to execute any plan generically
3. **No plan-architect Changes**: It already processes any phase content we provide
4. **Self-Contained**: Error log lifecycle stays within repair workflow
5. **Explicit Documentation**: Plans generated by repair will clearly show the error update phase
6. **User Visibility**: Users see the error status update requirement in the plan

## Helper Function Still Needed

The `mark_errors_resolved_for_plan()` function should still be added to error-handling.sh to provide a clean API for the phase to use. But this is just a convenience function, not a /build modification.

## Files Requiring Changes

| File | Change Required | Reason |
|------|-----------------|--------|
| `.claude/commands/repair.md` | Add repair-specific instruction to plan-architect prompt | Include error status update phase in repair plans |
| `.claude/lib/core/error-handling.sh` | Add `mark_errors_resolved_for_plan()` | Helper function for phase to use |

## Files NOT Requiring Changes

| File | Why No Change Needed |
|------|---------------------|
| `.claude/commands/build.md` | No repair detection needed - plans include update phase explicitly |
| `.claude/agents/plan-architect.md` | Already handles any phase content in prompts |

## Implementation Impact

- **Regular /plan commands**: Unaffected (don't receive repair-specific prompt)
- **Regular /build commands**: Unaffected (execute whatever phases are in plan)
- **Repair workflow**: Plans will now include error status update phase
- **Error log lifecycle**: Completed when repair plan is implemented

## Verification

After implementation:
1. Run `/repair --command /debug` to create a repair plan
2. Inspect the generated plan for "Update Error Log Status" phase
3. Run `/build [plan-path]` to implement
4. Verify errors transition from FIX_PLANNED to RESOLVED
