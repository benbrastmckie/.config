# Implementation Plan: External Script Solution for /coordinate Command

## Metadata
- **Date**: 2025-11-04
- **Feature**: Move /coordinate Phase 0 bash block to external script
- **Type**: Bug Fix (Architectural)
- **Complexity**: 4/10
- **Estimated Time**: 2-3 hours
- **Estimated Phases**: 4
- **Standards File**: /home/benjamin/.config/CLAUDE.md
- **Research Reports**:
  - `../reports/001_coordinate_bash_history_expansion_fixes/REVISED_FINDINGS.md`
  - `../QUICK_SUMMARY.md`
  - `../reports/001_coordinate_bash_history_expansion_fixes/OVERVIEW.md`

## Overview

The /coordinate command currently fails with bash code transformation errors when Claude AI extracts the 403-line Phase 0 bash block from coordinate.md. The errors show `${\!varname}` (with backslash), indicating code transformation during markdown processing, not bash history expansion issues.

This plan implements the external script solution, which bypasses markdown extraction/transformation by moving Phase 0 initialization to a standalone shell script.

### Root Cause
When Claude AI processes the large (403-line) bash block in coordinate.md:
1. Extracts bash code from markdown
2. Escapes special characters including `!`
3. Passes transformed code to Bash tool
4. Bash receives `${\\!varname}` and fails with "bad substitution"

### Solution Approach
Move Phase 0 initialization to external script at `.claude/lib/orchestration/coordinate-phase0.sh`, eliminating markdown processing step entirely.

## Success Criteria
- [x] Phase 0 bash code moved to external script
- [x] coordinate.md updated to invoke external script
- [x] All indirect variable references (`${!varname}`) work correctly
- [x] /coordinate command executes without transformation errors
- [x] Phase 0 completion message displayed correctly
- [x] All workflow scopes (research-only, research-and-plan, etc.) supported
- [x] No regression in functionality or performance

## Technical Design

### Architecture Change

**Before** (Problematic):
```
coordinate.md
â”œâ”€ Phase 0: 403-line inline bash block
â”‚  â”œâ”€ Project detection
â”‚  â”œâ”€ Library sourcing (with ${!array[@]} patterns)
â”‚  â””â”€ Path calculation
â””â”€ Phase 1-7: Subsequent phases
```

**After** (Fixed):
```
coordinate.md
â”œâ”€ Phase 0: Invokes external script
â”‚  â””â”€ bash .claude/lib/orchestration/coordinate-phase0.sh "$1"
â””â”€ Phase 1-7: Subsequent phases

.claude/lib/orchestration/
â””â”€ coordinate-phase0.sh (403 lines)
   â”œâ”€ Project detection
   â”œâ”€ Library sourcing (${!array[@]} works)
   â””â”€ Path calculation
```

### File Structure
```
.claude/
â”œâ”€ lib/
â”‚  â””â”€ orchestration/           # New directory
â”‚     â””â”€ coordinate-phase0.sh  # New file
â””â”€ commands/
   â””â”€ coordinate.md            # Modified: lines 522-927 replaced
```

### Script Interface

**Input**: `$1` = Workflow description (e.g., "research authentication patterns")

**Output** (via exports):
- `WORKFLOW_SCOPE` - Detected scope (research-only, research-and-plan, etc.)
- `TOPIC_PATH` - Absolute path to topic directory
- `TOPIC_DIR` - Same as TOPIC_PATH (compatibility)
- `REPORT_DIR` - Path to reports subdirectory
- `PLAN_DIR` - Path to plans subdirectory
- `PHASES_TO_EXECUTE` - Comma-separated phase numbers
- `SKIP_PHASES` - Comma-separated phases to skip

**Exit Codes**:
- `0` - Success
- `1` - Initialization error (library sourcing, directory creation, etc.)

## Implementation Phases

### Phase 1: Create Directory Structure and Extract Script
**Objective**: Create orchestration directory and extract Phase 0 bash code
**Complexity**: Low
**Estimated Time**: 15-20 minutes

Tasks:
- [ ] Create `.claude/lib/orchestration/` directory: `coordinate-phase0.sh:1`
  ```bash
  mkdir -p /home/benjamin/.config/.claude/lib/orchestration
  ```
- [ ] Extract Phase 0 bash block from coordinate.md (lines 525-926): `coordinate-phase0.sh:1-402`
  ```bash
  # Extract bash code (excludes opening ```bash and closing ```)
  sed -n '525,926p' /home/benjamin/.config/.claude/commands/coordinate.md > \
    /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh
  ```
- [ ] Add shebang and header to script: `coordinate-phase0.sh:1-10`
  ```bash
  # Prepend shebang and documentation header
  cat > /tmp/header.txt <<'EOF'
  #!/usr/bin/env bash
  # coordinate-phase0.sh - Phase 0 initialization for /coordinate command
  #
  # Purpose: Pre-calculate artifact paths and initialize workflow state
  # Usage: bash coordinate-phase0.sh "<workflow-description>"
  # Exports: WORKFLOW_SCOPE, TOPIC_PATH, REPORT_DIR, PLAN_DIR, PHASES_TO_EXECUTE

  set -euo pipefail  # Exit on error, undefined variables, pipe failures

  EOF

  cat /tmp/header.txt /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh > /tmp/temp.sh
  mv /tmp/temp.sh /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh
  ```
- [ ] Make script executable: `coordinate-phase0.sh:chmod`
  ```bash
  chmod +x /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh
  ```
- [ ] Verify script syntax: `coordinate-phase0.sh:verify`
  ```bash
  bash -n /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh
  ```

Testing:
```bash
# Verify directory created
test -d /home/benjamin/.config/.claude/lib/orchestration && echo "âœ“ Directory exists"

# Verify script exists and is executable
test -x /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh && echo "âœ“ Script executable"

# Verify script has valid bash syntax
bash -n /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh && echo "âœ“ Syntax valid"

# Verify script has shebang
head -1 /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh | grep -q '^#!/' && echo "âœ“ Shebang present"

# Count lines (should be ~412: 10 header + 402 original)
wc -l /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh
```

Expected: All checks pass, line count â‰ˆ412

---

### Phase 2: Update Script for Standalone Execution
**Objective**: Ensure script works as standalone executable with proper argument handling
**Complexity**: Medium
**Estimated Time**: 30-40 minutes

Tasks:
- [ ] Update argument parsing to use `$1` instead of coordinate.md's `"$1"`: `coordinate-phase0.sh:15-20`
  ```bash
  # After the header, ensure argument is captured correctly
  # Find line: WORKFLOW_DESCRIPTION="$1"
  # Verify it's using positional parameter correctly
  ```
- [ ] Add argument validation: `coordinate-phase0.sh:21-30`
  ```bash
  # Add after WORKFLOW_DESCRIPTION="$1"
  if [ -z "${WORKFLOW_DESCRIPTION:-}" ]; then
    echo "ERROR: Workflow description required" >&2
    echo "Usage: $0 \"<workflow description>\"" >&2
    echo "Example: $0 \"research authentication patterns\"" >&2
    exit 1
  fi
  ```
- [ ] Verify all environment variable exports are present: `coordinate-phase0.sh:exports`
  ```bash
  # Ensure these exports exist at end of script:
  # export WORKFLOW_SCOPE PHASES_TO_EXECUTE SKIP_PHASES
  # export TOPIC_PATH TOPIC_DIR REPORT_DIR PLAN_DIR
  grep -q "export WORKFLOW_SCOPE" /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh
  grep -q "export TOPIC_PATH" /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh
  ```
- [ ] Ensure script exits with proper codes: `coordinate-phase0.sh:exit-handling`
  ```bash
  # Verify set -e is present (already added in Phase 1)
  # Verify explicit exit 1 calls on errors
  grep -c "exit 1" /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh
  ```
- [ ] Test script standalone execution: `coordinate-phase0.sh:test`
  ```bash
  # Test with valid workflow description
  bash /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh \
    "research test workflow"
  ```

Testing:
```bash
# Test 1: Missing argument (should fail with usage message)
bash /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh 2>&1 | grep -q "ERROR" && echo "âœ“ Argument validation works"

# Test 2: Valid research-only workflow
OUTPUT=$(bash /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh "research authentication patterns" 2>&1)
echo "$OUTPUT" | grep -q "Phase 0: Initialization started" && echo "âœ“ Script executes"
echo "$OUTPUT" | grep -q "Workflow scope detected: research-only" && echo "âœ“ Scope detection works"

# Test 3: Verify exports (run in subshell to capture exports)
bash -c '
  source /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh "research test" 2>&1 >/dev/null
  test -n "$WORKFLOW_SCOPE" && echo "âœ“ WORKFLOW_SCOPE exported"
  test -n "$TOPIC_PATH" && echo "âœ“ TOPIC_PATH exported"
  test -n "$PHASES_TO_EXECUTE" && echo "âœ“ PHASES_TO_EXECUTE exported"
'

# Test 4: Verify indirect variable references work (the critical test)
bash -c '
  source /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh "research and plan test feature" 2>&1 | \
    grep -q "bad substitution" && echo "âœ— FAIL: Transformation still occurring" || echo "âœ“ No transformation errors"
'
```

Expected: All tests pass, especially Test 4 (no transformation errors)

---

### Phase 3: Update coordinate.md to Use External Script
**Objective**: Replace inline Phase 0 bash block with external script invocation
**Complexity**: Low
**Estimated Time**: 15-20 minutes

Tasks:
- [ ] Read coordinate.md lines 508-927 (entire Phase 0 section): `coordinate.md:508-927`
- [ ] Create backup of coordinate.md: `coordinate.md:backup`
  ```bash
  cp /home/benjamin/.config/.claude/commands/coordinate.md \
     /home/benjamin/.config/.claude/commands/coordinate.md.backup-$(date +%Y%m%d-%H%M%S)
  ```
- [ ] Identify exact line numbers for replacement:
  - Phase 0 section starts: Line 508 (`## Phase 0: Project Location and Path Pre-Calculation`)
  - Bash block starts: Line 524 (` ```bash`)
  - Bash block ends: Line 927 (` ``` `)
  - Section ends: Line 927
- [ ] Replace lines 522-927 with new external script invocation: `coordinate.md:522-927`
  ```markdown
  ### Implementation

  **EXECUTE NOW**: USE the Bash tool to execute Phase 0 initialization:

  ```bash
  # Execute Phase 0 initialization from external script
  # This bypasses markdown transformation issues with large bash blocks
  bash /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh "$1"
  ```

  **VERIFICATION CHECKPOINT**:
  ```bash
  # Verify Phase 0 completed successfully
  test -n "$WORKFLOW_SCOPE" || { echo "âœ— WORKFLOW_SCOPE not set"; exit 1; }
  test -n "$TOPIC_PATH" || { echo "âœ— TOPIC_PATH not set"; exit 1; }
  test -d "$TOPIC_PATH" || { echo "âœ— Topic directory not created"; exit 1; }

  echo "âœ“ Phase 0 verification passed"
  echo "  Workflow scope: $WORKFLOW_SCOPE"
  echo "  Topic directory: $TOPIC_PATH"
  ```
  ```
- [ ] Update Phase 0 section header documentation: `coordinate.md:510-520`
  ```markdown
  **Objective**: Initialize workflow state and calculate artifact paths.

  **Pattern**: External script invocation â†’ Environment variable exports â†’ Verification

  **Optimization**: Uses external script to avoid markdown transformation issues. Phase 0 logic lives in `.claude/lib/orchestration/coordinate-phase0.sh` for better testability and to prevent bash code escaping when extracted from markdown.

  **Critical**: ALL exports from Phase 0 script MUST be verified before Phase 1 begins.
  ```

Testing:
```bash
# Test 1: Verify backup created
ls -la /home/benjamin/.config/.claude/commands/coordinate.md.backup-* | tail -1

# Test 2: Verify coordinate.md was modified
NEW_SIZE=$(wc -l < /home/benjamin/.config/.claude/commands/coordinate.md)
OLD_SIZE=$(wc -l < /home/benjamin/.config/.claude/commands/coordinate.md.backup-*)
echo "Old size: $OLD_SIZE, New size: $NEW_SIZE (should be ~400 lines smaller)"

# Test 3: Verify new bash block references external script
grep -q "coordinate-phase0.sh" /home/benjamin/.config/.claude/commands/coordinate.md && \
  echo "âœ“ References external script"

# Test 4: Verify old bash block content removed
! grep -q "STEP 0.1: Project Directory Detection" /home/benjamin/.config/.claude/commands/coordinate.md && \
  echo "âœ“ Old inline bash block removed"

# Test 5: Verify verification checkpoint added
grep -q "VERIFICATION CHECKPOINT" /home/benjamin/.config/.claude/commands/coordinate.md && \
  echo "âœ“ Verification checkpoint present"
```

Expected: coordinate.md ~400 lines smaller, references external script

---

### Phase 4: Integration Testing and Validation
**Objective**: Test complete /coordinate workflow with external script
**Complexity**: Medium
**Estimated Time**: 45-60 minutes

Tasks:
- [ ] Test research-only workflow: `/coordinate:research-only`
  ```bash
  # This should be tested via actual /coordinate command invocation
  # Expected: Phase 0 completes, 2 research agents invoked
  ```
- [ ] Test research-and-plan workflow: `/coordinate:research-and-plan`
  ```bash
  # Expected: Phase 0 completes, research + plan agents invoked
  ```
- [ ] Test full-implementation workflow detection: `/coordinate:full-implementation`
  ```bash
  # Expected: Phase 0 completes, detects full-implementation scope
  ```
- [ ] Test debug-only workflow detection: `/coordinate:debug-only`
  ```bash
  # Expected: Phase 0 completes, detects debug-only scope
  ```
- [ ] Verify no bash transformation errors occur: `/coordinate:errors`
  ```bash
  # Check console output for:
  # - NO "!: command not found" errors
  # - NO "bad substitution" errors
  # - Phase 0 completion message present
  ```
- [ ] Verify all indirect variable references work: `coordinate-phase0.sh:indirect-refs`
  ```bash
  # Specifically verify the 9 instances work:
  # - context-pruning.sh line 55: ${!output_var_name}
  # - context-pruning.sh lines 150-326: ${!CACHE[@]} patterns
  # - workflow-initialization.sh lines 289, 317: ${!var_name}
  ```
- [ ] Performance regression test: `/coordinate:performance`
  ```bash
  # Measure Phase 0 execution time
  # Expected: Similar or better than inline version (should be faster due to no markdown parsing)
  ```
- [ ] Error handling test: `coordinate-phase0.sh:error-handling`
  ```bash
  # Test with invalid library paths
  # Test with missing CLAUDE_PROJECT_DIR
  # Expected: Clear error messages, exit code 1
  ```

Testing:
```bash
# Test Suite - Run all tests

echo "=== Test 1: Research-only workflow ==="
# USER ACTION REQUIRED: Run via Claude Code
# /coordinate "research authentication patterns"
# Expected output:
#   Phase 0: Initialization started
#   âœ“ Libraries loaded (3 for research-only)
#   âœ“ Workflow scope detected: research-only
#   Phase 0 complete

echo "=== Test 2: Research-and-plan workflow ==="
# USER ACTION REQUIRED: Run via Claude Code
# /coordinate "research authentication to create implementation plan"
# Expected output:
#   Phase 0: Initialization started
#   âœ“ Libraries loaded (5 for research-and-plan)
#   âœ“ Workflow scope detected: research-and-plan
#   Phase 0 complete

echo "=== Test 3: No transformation errors ==="
# After running above tests, verify console output contains:
# - NO "bash: line XX: !: command not found"
# - NO "environment: line XX: ${\!varname}: bad substitution"
# - Must see: "Phase 0: Initialization started" and "Phase 0 complete"

echo "=== Test 4: Indirect variable references ==="
# Verify the critical functions work by checking Phase 0 execution:
bash -x /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh \
  "research test" 2>&1 | grep -q "bad substitution" && \
  echo "âœ— FAIL: Indirect references broken" || \
  echo "âœ“ PASS: Indirect references work"

echo "=== Test 5: Performance check ==="
# Measure Phase 0 execution time
time bash /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh \
  "research performance test" >/dev/null 2>&1
# Expected: <500ms (should be faster than inline version)

echo "=== Test 6: Error handling ==="
# Test missing argument
bash /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh 2>&1 | \
  grep -q "ERROR: Workflow description required" && \
  echo "âœ“ PASS: Argument validation works"

# Test with corrupted LIB_DIR
LIB_DIR_BACKUP="$LIB_DIR"
export LIB_DIR="/nonexistent/path"
bash /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh \
  "test" 2>&1 | grep -q "ERROR" && \
  echo "âœ“ PASS: Error handling works"
export LIB_DIR="$LIB_DIR_BACKUP"

echo ""
echo "=== Test Suite Complete ==="
echo "If all tests passed, implementation is successful."
```

Expected:
- All workflow types complete Phase 0 without errors
- No bash transformation errors in console output
- Performance similar or better than inline version
- Clear error messages for invalid inputs

---

## Testing Strategy

### Unit Testing
Each phase has specific tests validating:
- File creation and permissions
- Script syntax and executability
- Argument validation
- Export variable presence
- Error handling

### Integration Testing
Phase 4 validates complete workflows:
- All 4 workflow scopes (research-only, research-and-plan, full-implementation, debug-only)
- Real /coordinate command invocations
- Agent delegation (Phase 1+ behavior)
- Cross-phase data flow via exported variables

### Regression Testing
Ensure no functionality loss:
- Workflow scope detection accuracy
- Library conditional loading
- Path pre-calculation
- Performance (target: â‰¤500ms for Phase 0)

### Critical Path Testing
The primary fix validation:
1. No `!: command not found` errors
2. No `bad substitution` errors
3. All indirect variable references work: `${!varname}`, `${!array[@]}`
4. Phase 0 completion message appears

## Documentation Requirements

### Files to Update
- [ ] `.claude/commands/coordinate.md` - Phase 0 section header (updated in Phase 3)
- [ ] `.claude/lib/orchestration/README.md` - Create documentation for orchestration scripts
- [ ] `CLAUDE.md` - Add orchestration scripts standards (if needed)
- [ ] `.gitignore` - Ensure `.backup-*` files ignored

### Orchestration Scripts Standards
Create `.claude/lib/orchestration/README.md`:

```markdown
# Orchestration Scripts

This directory contains standalone shell scripts for orchestration commands that require large, complex bash blocks.

## Purpose

Moving orchestration logic to external scripts prevents bash code transformation issues when Claude AI extracts code from markdown files.

## Structure

- `coordinate-phase0.sh` - Phase 0 initialization for /coordinate command
- (Future scripts as needed)

## Standards

- **Shebang**: `#!/usr/bin/env bash`
- **Error handling**: `set -euo pipefail`
- **Interface**: Accept arguments via `$1`, `$2`, etc.
- **Exports**: Use `export` for variables needed by calling command
- **Exit codes**: 0 for success, 1 for errors
- **Documentation**: Header comment with purpose, usage, exports

## Testing

Scripts must be testable independently:
```bash
bash /path/to/script.sh "argument" 2>&1
```
```

### Git Commit Messages
Following project conventions from CLAUDE.md:

**Phase 1**:
```
feat(coordinate): create orchestration directory and extract Phase 0 script

Extract 402-line Phase 0 bash block from coordinate.md to external script
at .claude/lib/orchestration/coordinate-phase0.sh. This prevents bash code
transformation issues when Claude AI processes large markdown bash blocks.

Fixes transformation errors: "!: command not found" and "bad substitution"

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

**Phase 2**:
```
feat(coordinate): make Phase 0 script standalone executable

Add argument validation, error handling, and proper exports to
coordinate-phase0.sh for standalone execution. Ensures script can be
invoked independently and passes all necessary state via environment
variables.

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

**Phase 3**:
```
refactor(coordinate): replace inline Phase 0 with external script invocation

Replace 403-line inline bash block in coordinate.md with invocation of
.claude/lib/orchestration/coordinate-phase0.sh. Reduces coordinate.md
by ~400 lines and eliminates markdown transformation issues.

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

**Phase 4**:
```
test(coordinate): validate external script solution across all workflow types

Verify Phase 0 external script works for research-only, research-and-plan,
full-implementation, and debug-only workflows. Confirms no bash
transformation errors and all indirect variable references work correctly.

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

## Dependencies

### Prerequisites
- Bash 4.3+ (for nameref support if needed in future)
- Git (for CLAUDE_PROJECT_DIR detection)
- Existing library files in `.claude/lib/`:
  - `library-sourcing.sh`
  - `workflow-detection.sh`
  - `unified-logger.sh`
  - `unified-location-detection.sh`
  - `metadata-extraction.sh`
  - `checkpoint-utils.sh`
  - `context-pruning.sh` (contains indirect references)
  - `workflow-initialization.sh` (contains indirect references)

### External Dependencies
None - self-contained solution using project libraries

## Risk Assessment

### High Risk âŒ
None identified

### Medium Risk âš ï¸
- **Coordinate.md editing**: Replacing 400+ lines requires careful verification
  - **Mitigation**: Create backup before editing, verify with diff
- **Environment variable propagation**: External script exports must reach Phase 1+
  - **Mitigation**: Add verification checkpoint, test exports in Phase 2

### Low Risk âœ…
- **Directory creation**: Standard operation
- **Script extraction**: Automated with sed, testable
- **Performance**: External script likely faster (no markdown parsing)

## Rollback Plan

If implementation fails:

1. **Restore coordinate.md from backup**:
   ```bash
   cp /home/benjamin/.config/.claude/commands/coordinate.md.backup-YYYYMMDD-HHMMSS \
      /home/benjamin/.config/.claude/commands/coordinate.md
   ```

2. **Remove external script** (optional):
   ```bash
   rm /home/benjamin/.config/.claude/lib/orchestration/coordinate-phase0.sh
   ```

3. **Verify restore**:
   ```bash
   wc -l /home/benjamin/.config/.claude/commands/coordinate.md
   # Should show original line count (~2900 lines)
   ```

4. **Investigate failure**:
   - Check Phase 4 test outputs
   - Review error messages
   - Verify library sourcing still works
   - Check git diff for unexpected changes

## Notes

### Why This Solution Works
The bash code transformation happens when Claude AI extracts bash blocks from markdown files. By moving the code to an external `.sh` file:
1. No markdown extraction step
2. No code transformation/escaping
3. Bash receives correct `${!varname}` syntax
4. All indirect variable references work

### Alternative Solutions Rejected
- **Solution 2 (Nameref refactoring)**: Treats symptom, not cause. 9-14 hours effort.
- **Solution 4 (Bash invocation flags)**: Bash already configured optimally. Not applicable.
- **Heredoc pattern**: Might still be processed by markdown parser. Not tested.

### Future Considerations
If other commands experience similar issues:
1. Check bash block size (>200 lines might trigger transformation)
2. Consider moving to external scripts in `.claude/lib/orchestration/`
3. Document transformation threshold if identified
4. Report to Anthropic as potential bug

### Performance Impact
Expected: **Neutral to Positive**
- Eliminates markdown parsing overhead
- Direct script execution is faster
- No subprocess overhead (script is sourced, not executed in subshell)
- Conditional library loading still works (optimization preserved)

### Maintenance
External scripts require:
- Shebang and error handling (`set -euo pipefail`)
- Clear documentation (purpose, usage, exports)
- Unit testing (independent of /coordinate command)
- Version control (track changes to orchestration scripts)

## Success Metrics

Implementation successful when:
1. âœ… Phase 0 executes without transformation errors
2. âœ… All 4 workflow types complete successfully
3. âœ… No `!: command not found` or `bad substitution` errors
4. âœ… All indirect variable references work (9 instances across 2 libraries)
5. âœ… Phase 0 performance â‰¤500ms (similar or better than inline version)
6. âœ… User's original /coordinate command works: `"research the plan..."`
7. âœ… All tests in Phase 4 pass

## References

- **Diagnostic Report**: `.claude/specs/coordinate_diagnostic_report.md`
- **Revised Findings**: `../reports/001_coordinate_bash_history_expansion_fixes/REVISED_FINDINGS.md`
- **Quick Summary**: `../QUICK_SUMMARY.md`
- **Console Outputs**: `.claude/specs/coordinate_output.md`
- **Original Hypothesis**: `../reports/001_coordinate_bash_history_expansion_fixes/OVERVIEW.md` (history expansion - incorrect)
- **coordinate.md**: `.claude/commands/coordinate.md` (lines 522-927 affected)
- **Affected Libraries**:
  - `.claude/lib/context-pruning.sh` (line 55, 150-326)
  - `.claude/lib/workflow-initialization.sh` (lines 289, 317)
