# /revise Errors Repair Plan

## Metadata
- **Date**: 2025-12-01
- **Feature**: Fix /revise command errors from error log analysis
- **Scope**: Verify error resolution, mark errors as resolved
- **Estimated Phases**: 2
- **Estimated Hours**: 2
- **Standards File**: /home/benjamin/.config/CLAUDE.md
- **Status**: [COMPLETE]
- **Complexity**: Low
- **Structure Level**: 0
- **Complexity Score**: 15.0
- **Research Reports**:
  - [/home/benjamin/.config/.claude/specs/002_repair_revise_20251201_110920/reports/001-revise-errors-repair.md](../reports/001-revise-errors-repair.md)

## Overview

This repair plan addresses 3 logged errors from /revise command executions on 2025-11-21. The research analysis reveals that **all errors have already been resolved** through code changes made between 2025-11-21 and 2025-12-01. The most recent workflow output (2025-12-01) shows successful /revise execution with NO runtime errors.

The primary tasks are:
1. **Verify error resolution** through integration testing with multiple /revise executions
2. **Mark historical errors as resolved** in the error log to reflect current code state

## Research Summary

Research analysis of 3 /revise errors (exit codes 127 and 1) from 2025-11-21 reveals:

**Pattern 1: Function Not Found (exit code 127)** - 2 errors (67%)
- Function `save_completed_states_to_state` calls removed from revise.md
- Comments added: "Removed: save_completed_states_to_state does not exist in library"
- Function DOES exist in workflow-state-machine.sh but calls were cleaned up

**Pattern 2: Sed Parsing Error (exit code 1)** - 1 error (33%)
- Line 157 sed pattern with unescaped variable no longer in codebase
- Code refactored to use safer string manipulation

**Evidence of Resolution**:
- Most recent workflow output (2025-12-01) shows NO errors
- Current code at error line numbers differs from error context
- 10 days between errors and most recent successful execution

**Recommendation**: Verify fix persistence through integration testing, then mark errors as resolved.

## Success Criteria
- [ ] Integration tests confirm /revise command executes without errors across multiple test cases
- [ ] No new /revise errors logged during verification testing
- [ ] Historical error log entries updated from FIX_PLANNED to RESOLVED status
- [ ] Error log query confirms no remaining FIX_PLANNED errors for this plan

## Technical Design

**Approach**: Verification and error log cleanup only (no code changes needed)

**Error Resolution Strategy**:
1. **Already Fixed**: Code changes between 2025-11-21 and 2025-12-01 resolved root causes
2. **Verification Method**: Run /revise with different inputs to confirm no error recurrence
3. **Error Log Update**: Mark historical errors as RESOLVED using error-handling.sh functions

**Integration Test Coverage**:
- Simple revision with minimal prompt
- Complex revision with multi-phase changes
- Edge case: revision with special characters in plan path
- Error log check after each test

**Error Log Status Transition**:
- Current: `status: "FIX_PLANNED"` (from repair plan 941 or earlier)
- Target: `status: "RESOLVED"`
- Method: `mark_errors_resolved_for_plan()` function from error-handling.sh

## Implementation Phases

### Phase 1: Verify Error Resolution [COMPLETE]
dependencies: []

**Objective**: Confirm /revise command executes successfully without triggering historical errors

**Complexity**: Low

Tasks:
- [x] Execute Test 1: Simple revision with existing plan
  ```bash
  # Use a test plan from specs/ directory
  /revise "test revision 1" .claude/specs/001_repair_research_20251201_102422/plans/001-repair-research-20251201-102422-plan.md --complexity 1
  ```
- [x] Execute Test 2: Complex revision with multi-phase prompt
  ```bash
  /revise "research and revise the plan to add new testing phase and update documentation requirements" .claude/specs/001_repair_research_20251201_102422/plans/001-repair-research-20251201-102422-plan.md --complexity 2
  ```
- [x] Execute Test 3: Check error log for new /revise errors after tests
  ```bash
  source .claude/lib/core/error-handling.sh
  NEW_ERRORS=$(query_errors --command /revise --since 5m | jq '. | length')
  echo "New /revise errors in last 5 minutes: $NEW_ERRORS"
  [ "$NEW_ERRORS" -eq 0 ] && echo "✓ No new errors" || echo "✗ Found new errors"
  ```
- [x] Verify most recent workflow output still shows success
  ```bash
  tail -100 .claude/output/revise-output.md | grep -E "(ERROR|exit code)" || echo "✓ No errors in recent output"
  ```

Testing:
```bash
# Validation: All test commands above must complete without exit code 127 or sed errors
# Success criteria: No new /revise errors in error log after test execution
grep '"command_name":"/revise"' .claude/data/logs/errors.jsonl | tail -5
```

**Expected Duration**: 1 hour

### Phase 2: Update Error Log Status [COMPLETE]
dependencies: [1]

**Objective**: Update error log entries from FIX_PLANNED to RESOLVED

Tasks:
- [x] Verify all fixes are working (tests pass, no new errors generated)
- [x] Update error log entries to RESOLVED status:
  ```bash
  source .claude/lib/core/error-handling.sh
  RESOLVED_COUNT=$(mark_errors_resolved_for_plan "/home/benjamin/.config/.claude/specs/002_repair_revise_20251201_110920/plans/001-repair-revise-20251201-110920-plan.md")
  echo "Resolved $RESOLVED_COUNT error log entries"
  ```
- [x] Verify no FIX_PLANNED errors remain for this plan:
  ```bash
  REMAINING=$(query_errors --status FIX_PLANNED | jq -r '.repair_plan_path' | grep -c "$(basename "$(dirname "$(dirname "/home/benjamin/.config/.claude/specs/002_repair_revise_20251201_110920/plans/001-repair-revise-20251201-110920-plan.md")")" )" || echo "0")
  [ "$REMAINING" -eq 0 ] && echo "All errors resolved" || echo "WARNING: $REMAINING errors still FIX_PLANNED"
  ```
- [x] Query resolved errors to confirm status update
  ```bash
  source .claude/lib/core/error-handling.sh
  RESOLVED_ERRORS=$(query_errors --command /revise --status RESOLVED | jq '. | length')
  echo "Total /revise errors marked RESOLVED: $RESOLVED_ERRORS"
  ```
- [x] Document verification results in plan summary
  ```bash
  echo "=== Error Resolution Summary ===" >> .claude/specs/002_repair_revise_20251201_110920/summaries/001-verification-summary.md
  echo "- Errors resolved: $RESOLVED_COUNT" >> .claude/specs/002_repair_revise_20251201_110920/summaries/001-verification-summary.md
  echo "- Resolution date: $(date)" >> .claude/specs/002_repair_revise_20251201_110920/summaries/001-verification-summary.md
  ```

Testing:
```bash
# Verify error log entries updated correctly
source .claude/lib/core/error-handling.sh
FIXED_COUNT=$(query_errors --command /revise --status RESOLVED | jq -r 'select(.repair_plan_path | contains("002_repair_revise_20251201_110920")) | .timestamp' | wc -l)
echo "Errors marked RESOLVED for this plan: $FIXED_COUNT"
[ "$FIXED_COUNT" -ge 3 ] && echo "✓ All 3 errors marked RESOLVED" || echo "✗ Not all errors updated"
```

**Expected Duration**: 1 hour

## Testing Strategy

**Test Approach**: Integration testing only (no unit tests needed for verification-only plan)

**Test Phases**:
1. **Phase 1 Testing**: Execute /revise with different complexity levels and inputs
   - Verify no exit code 127 errors (function not found)
   - Verify no exit code 1 errors (sed parsing failures)
   - Check error log for new entries after each test
2. **Phase 2 Testing**: Verify error log status updates
   - Query errors by status to confirm RESOLVED transition
   - Validate no FIX_PLANNED errors remain for this plan

**Coverage Requirements** (from CLAUDE.md):
- Integration tests for /revise command execution
- Error log query validation
- Status transition verification

**Test Discovery** (from CLAUDE.md):
- Manual test execution (no automated test files needed for verification plan)
- Error log queries use error-handling.sh functions

## Documentation Requirements

**Updates Required**:
- Create verification summary in specs/002_repair_revise_20251201_110920/summaries/
- Document error resolution in summary file (Phase 2, Task 4)

**Format** (from CLAUDE.md):
- Summary includes: error count resolved, resolution date, verification method
- No new documentation files needed (use existing summary pattern)

## Dependencies

**External Dependencies**:
- error-handling.sh library (mark_errors_resolved_for_plan, query_errors functions)
- workflow-state-machine.sh library (for /revise command execution)
- Existing plan file for testing: .claude/specs/001_repair_research_20251201_102422/plans/001-repair-research-20251201-102422-plan.md

**Prerequisites**:
- Error log exists at .claude/data/logs/errors.jsonl
- Test plan file exists and is readable
- Error handling library sourced correctly in bash blocks
