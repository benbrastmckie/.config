# Commands Creating Spec Directories Research Report

## Metadata
- **Date**: 2025-11-20
- **Agent**: research-specialist
- **Topic**: Commands that create new project directories in .claude/specs/
- **Report Type**: codebase analysis
- **Workflow**: research-and-revise

## Executive Summary

Three primary commands create new topic directories in `.claude/specs/`: `/plan`, `/research`, and `/debug`. All three commands use a shared infrastructure pattern centered on `initialize_workflow_paths()` from `workflow-initialization.sh`, which orchestrates topic number allocation, directory naming, and structure creation. The `/revise` command is unique—it reuses existing topic directories rather than creating new ones. All directory creation flows through two core utilities: `create_topic_structure()` creates the topic root directory only (lazy creation pattern), and `sanitize_topic_name()` generates directory names from user descriptions.

## Findings

### Section 1: Commands That Create Spec Directories

#### 1.1 Primary Directory-Creating Commands

**Command: `/plan` (research-and-plan workflow)**

- **Location**: `/home/benjamin/.config/.claude/commands/plan.md:222`
- **Workflow Type**: research-and-plan
- **Terminal State**: plan (after planning phase complete)
- **Directory Creation Pattern**:
  ```bash
  # Block 1, Lines 222-234
  if ! initialize_workflow_paths "$FEATURE_DESCRIPTION" "research-and-plan" "$RESEARCH_COMPLEXITY" ""; then
    log_command_error ...
    exit 1
  fi

  SPECS_DIR="$TOPIC_PATH"
  RESEARCH_DIR="${TOPIC_PATH}/reports"
  PLANS_DIR="${TOPIC_PATH}/plans"
  mkdir -p "$RESEARCH_DIR"
  mkdir -p "$PLANS_DIR"
  ```

- **Subdirectories Created**:
  - `{NNN_topic}/` - Topic root (created by `initialize_workflow_paths`)
  - `{NNN_topic}/reports/` - Research reports
  - `{NNN_topic}/plans/` - Implementation plans
  - `{NNN_topic}/prompts/` - Archived prompt files (if `--file` flag used)

- **Naming Convention**: `{NNN}_{sanitized_topic_name}`
  - NNN: 3-digit sequential number (001, 002, etc.)
  - sanitized_topic_name: Generated by `sanitize_topic_name()` from `$FEATURE_DESCRIPTION`

**Command: `/research` (research-only workflow)**

- **Location**: `/home/benjamin/.config/.claude/commands/research.md:205`
- **Workflow Type**: research-only
- **Terminal State**: research (after research phase complete)
- **Directory Creation Pattern**:
  ```bash
  # Block 1, Lines 205-220
  if ! initialize_workflow_paths "$WORKFLOW_DESCRIPTION" "research-only" "$RESEARCH_COMPLEXITY" ""; then
    log_command_error ...
    exit 1
  fi

  RESEARCH_DIR="${TOPIC_PATH}/reports"
  mkdir -p "$RESEARCH_DIR"
  ```

- **Subdirectories Created**:
  - `{NNN_topic}/` - Topic root (created by `initialize_workflow_paths`)
  - `{NNN_topic}/reports/` - Research reports only
  - `{NNN_topic}/prompts/` - Archived prompt files (if `--file` flag used)

- **Naming Convention**: Same as `/plan` - `{NNN}_{sanitized_topic_name}`

**Command: `/debug` (debug-only workflow)**

- **Location**: `/home/benjamin/.config/.claude/commands/debug.md:411`
- **Workflow Type**: debug-only
- **Terminal State**: debug (after debug analysis complete)
- **Directory Creation Pattern**:
  ```bash
  # Part 3, Lines 411-426
  if ! initialize_workflow_paths "$ISSUE_DESCRIPTION" "debug-only" "$RESEARCH_COMPLEXITY" "$CLASSIFICATION_JSON"; then
    echo "ERROR: Failed to initialize workflow paths"
    exit 1
  fi

  SPECS_DIR="$TOPIC_PATH"
  RESEARCH_DIR="${TOPIC_PATH}/reports"
  DEBUG_DIR="${TOPIC_PATH}/debug"

  mkdir -p "$RESEARCH_DIR"
  mkdir -p "$DEBUG_DIR"
  ```

- **Subdirectories Created**:
  - `{NNN_topic}/` - Topic root (created by `initialize_workflow_paths`)
  - `{NNN_topic}/reports/` - Research reports (root cause analysis)
  - `{NNN_topic}/debug/` - Debug artifacts and analysis
  - `{NNN_topic}/plans/` - Debug strategy plan
  - `{NNN_topic}/prompts/` - Archived prompt files (if `--file` flag used)

- **Naming Convention**: Same as `/plan` and `/research` - `{NNN}_{sanitized_topic_name}`

#### 1.2 Command That DOES NOT Create New Directories

**Command: `/revise` (research-and-revise workflow)**

- **Location**: `/home/benjamin/.config/.claude/commands/revise.md:492-530`
- **Workflow Type**: research-and-revise
- **Behavior**: **Reuses existing topic directory** from the plan being revised
- **Key Pattern**:
  ```bash
  # Part 3, Lines 492-530 (workflow-initialization.sh)
  if [ "${workflow_scope:-}" = "research-and-revise" ]; then
    # Extract topic directory from existing plan path
    topic_path=$(dirname $(dirname "$EXISTING_PLAN_PATH"))

    # Validate it exists (defensive check)
    if [ ! -d "$topic_path" ]; then
      echo "ERROR: Existing topic directory not found"
      exit 1
    fi
  ```

- **Subdirectories Used** (not created):
  - `{existing_topic}/reports/` - Adds new research reports to existing directory
  - `{existing_topic}/plans/` - Revises existing plan (creates backup)
  - `{existing_topic}/plans/backups/` - Stores backup of original plan

- **Naming Convention**: Uses existing topic directory name (no new directory created)

### Section 2: Infrastructure Analysis

#### 2.1 Core Function: `initialize_workflow_paths()`

**Location**: `/home/benjamin/.config/.claude/lib/workflow/workflow-initialization.sh:364-794`

**Purpose**: Consolidated Phase 0 initialization for all workflow commands

**Function Signature**:
```bash
initialize_workflow_paths "$WORKFLOW_DESCRIPTION" "$WORKFLOW_SCOPE" "$RESEARCH_COMPLEXITY" "$CLASSIFICATION_RESULT"
```

**Parameters**:
1. `$1 - WORKFLOW_DESCRIPTION`: User's workflow description (e.g., "implement auth")
2. `$2 - WORKFLOW_SCOPE`: Workflow type (research-only, research-and-plan, research-and-revise, full-implementation, debug-only)
3. `$3 - RESEARCH_COMPLEXITY`: Number of research subtopics (1-4, default: 2)
4. `$4 - CLASSIFICATION_RESULT`: JSON classification result with research_topics array (optional, for filename slugs)

**Exports** (25 variables total):
- `LOCATION` / `PROJECT_ROOT` - Project root directory
- `SPECS_ROOT` - Specs directory path (.claude/specs or specs/)
- `TOPIC_NUM` - Topic number (e.g., "042")
- `TOPIC_NAME` - Sanitized topic name (e.g., "implement_auth")
- `TOPIC_PATH` - Full topic directory path
- `RESEARCH_SUBDIR` - Research reports subdirectory
- `PLAN_PATH` - Implementation plan path
- `DEBUG_REPORT` - Debug analysis report path
- `SUMMARY_PATH` - Implementation summary path
- Plus 15+ other tracking variables

**Three-Step Pattern** (lines 389-589):

**STEP 1: Scope Detection** (lines 392-401)
- Validates workflow scope against allowed values
- No directory creation, only validation

**STEP 2: Path Pre-Calculation** (lines 407-753)
- Detects project root via `$CLAUDE_PROJECT_DIR`
- Determines specs directory (checks `CLAUDE_SPECS_ROOT` override, then `.claude/specs`, then `specs/`)
- Generates topic name via `sanitize_topic_name()` or `validate_topic_directory_slug()` (if LLM classification available)
- Allocates topic number via `get_or_create_topic_number()` (idempotent)
- Constructs full topic path: `${specs_root}/${topic_num}_${topic_name}`
- **Special case for research-and-revise**: Extracts existing topic path from `$EXISTING_PLAN_PATH` (lines 492-530)

**STEP 3: Directory Structure Creation** (lines 542-589)
- Calls `create_topic_structure()` to create topic root directory ONLY
- Lazy creation pattern: subdirectories created by individual commands as needed
- **Skip creation for research-and-revise**: Directory already exists (lines 543-553)

#### 2.2 Topic Structure Creation: `create_topic_structure()`

**Location**: `/home/benjamin/.config/.claude/lib/plan/topic-utils.sh` (referenced at workflow-initialization.sh:554)

**Behavior**: Creates ONLY the topic root directory
- **Pattern**: `mkdir -p "$topic_path"`
- **Verification**: Checks directory exists after creation
- **No subdirectory creation**: Subdirectories (reports/, plans/, debug/, etc.) created by individual commands

**Why Lazy Creation?**
- Reduces I/O operations during Phase 0 initialization
- Commands only create subdirectories they actually use
- `/research` doesn't need plans/ directory
- `/plan` doesn't need debug/ directory

#### 2.3 Topic Naming: `sanitize_topic_name()`

**Location**: `/home/benjamin/.config/.claude/lib/plan/topic-utils.sh:142-200`

**Algorithm** (8-step process):
1. **Extract path components** (last 2-3 meaningful segments from paths)
2. **Remove full paths** from description
3. **Convert to lowercase**
4. **Remove filler prefixes** ("carefully research", "analyze the", etc.)
5. **Remove stopwords** (40+ common English words: the, a, an, and, or, etc.)
6. **Combine path components** with cleaned description
7. **Clean up formatting** (multiple underscores, leading/trailing)
8. **Intelligent truncation** (preserve whole words, max 50 chars)

**Examples**:
- "Research the /home/user/nvim/docs directory" → "nvim_docs_directory"
- "fix the token refresh bug" → "fix_token_refresh_bug"
- "research authentication patterns to create implementation plan" → "authentication_patterns_create_implementation"

**Current Limitations** (relevant to plan 001):
- No artifact reference stripping (e.g., "001_", ".md", "reports_")
- No planning-context stopwords (e.g., "create", "plan", "research", "implement")
- Length limit: 50 characters (plan 001 proposes reducing to 35)
- No file extension removal
- No common basename filtering (README, claude, output, etc.)

#### 2.4 Topic Number Allocation: `get_or_create_topic_number()`

**Location**: `/home/benjamin/.config/.claude/lib/plan/topic-utils.sh:107-122`

**Behavior**: Idempotent topic number allocation
- Checks for existing topic with exact name match
- Reuses existing topic number if found (prevents duplicate topics)
- Allocates next sequential number if no match

**Pattern**:
```bash
# Check for existing topic with exact name match
existing=$(ls -1d "${specs_root}"/[0-9][0-9][0-9]_"${topic_name}" 2>/dev/null | head -1 || echo "")

if [ -n "$existing" ]; then
  # Return existing topic number
  basename "$existing" | sed 's/^\([0-9][0-9][0-9]\)_.*/\1/'
else
  # Get next sequential number
  get_next_topic_number "$specs_root"
fi
```

### Section 3: Directory Structure Standards

#### 3.1 Standard Topic Directory Structure

Based on analysis of all three commands, the standard topic directory structure is:

```
.claude/specs/
└── {NNN}_{topic_name}/          # Topic root (created by initialize_workflow_paths)
    ├── reports/                 # Research reports (created by /plan, /research, /debug)
    │   └── 001_*.md             # Numbered research reports
    ├── plans/                   # Implementation plans (created by /plan, /debug)
    │   ├── 001_*_plan.md        # Primary plan
    │   └── backups/             # Plan revision backups (created by /revise)
    │       └── 001_*_YYYYMMDD_HHMMSS.md
    ├── debug/                   # Debug artifacts (created by /debug only)
    │   └── 001_debug_analysis.md
    ├── prompts/                 # Archived prompt files (created if --file flag used)
    │   └── {original_filename}
    ├── summaries/               # Implementation summaries (created by /build)
    │   └── {NNN}_{topic_name}_summary.md
    └── artifacts/               # Implementation artifacts (created by /build)
        └── (various files)
```

#### 3.2 Naming Convention Analysis

**Current Pattern**: `{NNN}_{sanitized_topic_name}`

**Components**:
1. **NNN**: 3-digit sequential number
   - Allocated by `get_or_create_topic_number()`
   - Idempotent: reuses existing if topic name matches
   - Format: 001, 002, 003, etc.

2. **sanitized_topic_name**: Generated from user input
   - Processed by `sanitize_topic_name()` (8-step algorithm)
   - Max length: 50 characters (current), 35 proposed in plan 001
   - Format: snake_case (lowercase, underscores)

**Naming Violations Found** (from plan 001 research):
- 27 of 69 spec directories (39%) contain naming violations
- Common issues:
  - Artifact references: 32% (e.g., "001_", "reports_", ".md")
  - Excessive length: 32% (>50 chars)
  - Verbose meta-words: 30% (e.g., "carefully", "detailed")

### Section 4: Gap Analysis - Commands NOT in Current Plan

**Finding**: The existing plan (`001_infrastructure_to_improve_the_names_that_plan.md`) mentions commands generically but does NOT explicitly list which commands create directories or analyze their patterns.

**Current Plan Coverage**:
- ✓ Mentions "commands use `sanitize_topic_name()`" (line 40)
- ✓ References `/plan`, `/research`, `/debug` as workflow commands
- ✗ Does NOT document which commands create new directories vs. reuse existing
- ✗ Does NOT document subdirectory patterns by command
- ✗ Does NOT document `/revise` special behavior (reuses existing)
- ✗ Does NOT document `initialize_workflow_paths()` as the single point of creation

**Gap**: Plan focuses on `sanitize_topic_name()` enhancement but doesn't document the complete directory creation workflow.

## Recommendations

### Recommendation 1: Document Directory Creation Commands in Plan

**Add a new section to plan 001**: "Commands Creating Spec Directories"

Include:
- Table listing `/plan`, `/research`, `/debug` with their subdirectory patterns
- Explicit note that `/revise` reuses existing directories (does NOT create new)
- Reference to `initialize_workflow_paths()` as single creation point
- Diagram showing workflow → `initialize_workflow_paths()` → `create_topic_structure()` → `sanitize_topic_name()` flow

**Rationale**: Helps future maintainers understand which commands are affected by naming changes.

### Recommendation 2: Add Integration Testing for All Directory-Creating Commands

**Current plan Phase 5**: Only tests `sanitize_topic_name()` function directly

**Enhancement**: Add integration tests for actual directory creation:
```bash
# Test /plan creates correct structure
/plan "test feature implementation"
# Verify: .claude/specs/NNN_test_feature_implementation/ exists
# Verify: reports/ and plans/ subdirectories exist

# Test /research creates minimal structure
/research "authentication patterns"
# Verify: .claude/specs/NNN_authentication_patterns/ exists
# Verify: only reports/ subdirectory exists (no plans/)

# Test /debug creates debug-specific structure
/debug "timeout errors in production"
# Verify: .claude/specs/NNN_timeout_errors_production/ exists
# Verify: reports/, plans/, and debug/ subdirectories exist

# Test /revise reuses existing directory
/revise "revise plan at .claude/specs/001_test/plans/001_plan.md with new insights"
# Verify: NO new directory created
# Verify: new report added to 001_test/reports/
```

**Rationale**: Function-level tests don't catch integration issues where commands might bypass `sanitize_topic_name()` or use different naming patterns.

### Recommendation 3: Validate `/revise` Doesn't Break With Naming Changes

**Risk**: `/revise` extracts topic directory from existing plan path
- Current pattern: `dirname $(dirname "$EXISTING_PLAN_PATH")`
- Depends on path format: `/path/to/specs/NNN_topic/plans/NNN_plan.md`

**Test Case**: Verify `/revise` works correctly with enhanced naming:
```bash
# Create plan with enhanced naming (shorter, no artifacts)
/plan "user authentication system"
# Result: .claude/specs/NNN_user_authentication/ (not "user_authentication_system")

# Verify /revise can extract topic correctly
/revise "revise plan at .claude/specs/NNN_user_authentication/plans/001_plan.md based on security review"
# Should extract topic_path = .claude/specs/NNN_user_authentication
# Should add reports to existing reports/ directory
```

**Rationale**: Naming changes shouldn't break existing workflows, especially `/revise` which depends on path parsing.

### Recommendation 4: Add Monitoring for Subdirectory Creation Patterns

**Observation**: Each command creates subdirectories ad-hoc with `mkdir -p`
- `/plan` creates `reports/` and `plans/`
- `/research` creates only `reports/`
- `/debug` creates `reports/`, `plans/`, and `debug/`

**Enhancement**: Centralize subdirectory creation in `create_topic_structure()` with lazy creation flags:
```bash
create_topic_structure "$topic_path" --subdirs "reports,plans"  # /plan
create_topic_structure "$topic_path" --subdirs "reports"         # /research
create_topic_structure "$topic_path" --subdirs "reports,plans,debug"  # /debug
```

**Rationale**: Makes subdirectory patterns explicit and easier to track across commands. Current ad-hoc pattern is scattered across 3 command files.

### Recommendation 5: Document `initialize_workflow_paths()` as Single Enhancement Point

**Current plan Phase 1**: Enhances `sanitize_topic_name()` function

**Additional documentation needed**: `initialize_workflow_paths()` is the ONLY function that:
1. Calls `sanitize_topic_name()` (line 459)
2. Calls `create_topic_structure()` (line 554)
3. Exports `TOPIC_PATH` to all commands

**Implication**: Changes to `sanitize_topic_name()` automatically affect ALL directory-creating commands without needing command-specific updates.

**Add to plan**: "Single Point of Enhancement" section explaining this flow.

**Rationale**: Clarifies why enhancing one function fixes all commands (reduces testing scope).

## References

### Commands (Primary Sources)
- `/home/benjamin/.config/.claude/commands/plan.md` (lines 1-727)
  - Line 222: `initialize_workflow_paths()` call
  - Lines 236-240: Subdirectory creation (reports/, plans/)
- `/home/benjamin/.config/.claude/commands/research.md` (lines 1-479)
  - Line 205: `initialize_workflow_paths()` call
  - Line 219: Subdirectory creation (reports/ only)
- `/home/benjamin/.config/.claude/commands/debug.md` (lines 1-1039)
  - Line 411: `initialize_workflow_paths()` call
  - Lines 420-426: Subdirectory creation (reports/, debug/)
- `/home/benjamin/.config/.claude/commands/revise.md` (lines 1-812)
  - Lines 492-530: Special handling for existing directories
  - No new directory creation

### Infrastructure Libraries
- `/home/benjamin/.config/.claude/lib/workflow/workflow-initialization.sh` (lines 1-935)
  - Lines 364-794: `initialize_workflow_paths()` function
  - Lines 392-401: STEP 1 - Scope Detection
  - Lines 407-753: STEP 2 - Path Pre-Calculation
  - Lines 542-589: STEP 3 - Directory Structure Creation
  - Lines 492-530: research-and-revise special case
- `/home/benjamin/.config/.claude/lib/plan/topic-utils.sh` (lines 1-200+)
  - Lines 107-122: `get_or_create_topic_number()` function
  - Lines 142-200: `sanitize_topic_name()` function
  - Lines 30-77: `extract_significant_words()` helper

### Existing Plan
- `/home/benjamin/.config/.claude/specs/862_infrastructure_to_improve_the_names_that_will_be/plans/001_infrastructure_to_improve_the_names_that_plan.md`
  - Lines 1-708: Complete plan for naming infrastructure improvements
  - Line 40: References commands using `sanitize_topic_name()`
  - Lines 95-134: Enhancement 1 (artifact stripping) - directly applicable
  - Lines 136-152: Enhancement 2 (extended stopwords) - directly applicable
  - Lines 154-171: Enhancement 3 (reduced length limit) - directly applicable
