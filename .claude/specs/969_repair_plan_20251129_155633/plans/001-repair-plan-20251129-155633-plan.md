# /plan Command Error Repair Plan

## Metadata
- **Date**: 2025-11-29
- **Feature**: Repair /plan command errors identified in error log analysis
- **Scope**: Fix exit code 127 errors, library sourcing issues, environment bootstrap failures, agent failures, state machine errors, and test environment pollution
- **Estimated Phases**: 6
- **Estimated Hours**: 16
- **Standards File**: /home/benjamin/.config/CLAUDE.md
- **Status**: [COMPLETE]
- **Research Reports**:
  - [Error Analysis Report](/home/benjamin/.config/.claude/specs/969_repair_plan_20251129_155633/reports/001_error_analysis.md)
  - [Plan Revision Research](/home/benjamin/.config/.claude/specs/969_repair_plan_20251129_155633/reports/002-plan-revision-research.md)
- **Structure Level**: 0
- **Complexity Score**: 92.0

## Overview

This repair plan addresses 25 logged errors from the /plan command over an 8-day period (2025-11-21 to 2025-11-29). The errors fall into five main categories: bash execution failures (40%), agent failures (44%), validation issues (12%), state machine errors (12%), and test environment pollution (28%). The plan systematically addresses each root cause identified in the error analysis, prioritizing high-impact/low-effort fixes first.

Key improvements include:
- Removing hardcoded `/etc/bashrc` sourcing that causes exit code 127 errors
- Enforcing three-tier library sourcing pattern to prevent function unavailability
- Improving topic naming agent error handling and fallback naming
- Separating test environment errors from production error logs
- Adding state machine workflow reset logic for restart scenarios

## Research Summary

The error analysis report and plan revision research identified six distinct error patterns affecting the /plan command:

1. **Exit Code 127 - Command Not Found** (32% of errors): Hardcoded sourcing of `/etc/bashrc` fails on systems where the file doesn't exist or is inaccessible. This causes immediate command failure during initialization.

2. **Environment Bootstrap Failure** (CRITICAL - identified in revision research): Block 1c fails with "Failed to restore WORKFLOW_ID from Block 1a" error because CLAUDE_PROJECT_DIR is not initialized before attempting to source libraries or restore state. This is a bootstrapping problem where library source paths depend on CLAUDE_PROJECT_DIR being set, but the variable is not initialized as the first action in each bash block.

3. **Topic Naming Agent Failures** (16% of errors): The topic-naming-agent subagent fails to create output files due to timeouts or execution issues, falling back to generic "no_name" directory structure. This degrades user experience and makes spec directories harder to navigate.

4. **Test Environment Validation Failures** (28% of errors): Unit tests intentionally use non-existent files to test error detection, but these expected test failures are logged to the production error log, inflating error counts and making real issues harder to identify.

5. **Workflow State Initialization Failures** (12% of errors): The `append_workflow_state` function is not available (exit code 127) because state-persistence.sh is not sourced correctly before use. This violates the three-tier sourcing pattern from Code Standards.

6. **State Machine Lifecycle Management** (12% of errors): The workflow state machine cannot transition from "complete" state back to "plan" state, preventing workflow restart scenarios after completion.

**Recommended Approach**: Address issues in priority order (high-impact first), with defensive coding patterns to prevent future regressions. The environment bootstrap issue (pattern #2) is the most critical as it prevents any bash block from executing successfully if CLAUDE_PROJECT_DIR is not set. Phase 2 now includes comprehensive environment bootstrap standardization to ensure CLAUDE_PROJECT_DIR initialization occurs before all library sourcing and state operations.

## Success Criteria

- [ ] All exit code 127 errors eliminated (hardcoded paths removed)
- [ ] CLAUDE_PROJECT_DIR initialization occurs as first action in all bash blocks
- [ ] No "Failed to restore WORKFLOW_ID" errors due to missing CLAUDE_PROJECT_DIR
- [ ] Three-tier library sourcing pattern enforced across all /plan bash blocks
- [ ] Environment bootstrap order validated: CLAUDE_PROJECT_DIR â†’ library sourcing â†’ state restoration
- [ ] Topic naming agent has retry logic and improved fallback naming
- [ ] Test environment errors logged separately from production errors
- [ ] State machine supports workflow restart scenarios (complete â†’ plan transition)
- [ ] All validation scripts pass with no sourcing violations
- [ ] Error count for /plan command reduced by at least 80% over 7-day test period
- [ ] No new errors introduced by repair implementation

## Technical Design

### Architecture Overview

The /plan command uses a multi-block bash structure with state persistence across blocks and Task-based agent invocation. Current architecture has five critical failure points:

1. **Block 1a Initialization**: Hardcoded `/etc/bashrc` sourcing and incomplete library sourcing
2. **Block 1b Topic Naming**: Brittle agent validation with no retry logic
3. **Block 1c Topic Path Init**: Missing CLAUDE_PROJECT_DIR initialization before state restoration, incorrect library sourcing order (state-persistence before error-handling)
4. **Blocks 2-3 State Restoration**: Incomplete library sourcing in subsequent blocks
5. **All Blocks Environment Bootstrap**: CLAUDE_PROJECT_DIR not initialized as first action, causing path construction failures

### Proposed Design Changes

**1. Environment Bootstrap Standardization** (CRITICAL)
- Initialize CLAUDE_PROJECT_DIR as FIRST action in every bash block using git-based detection
- Standard pattern: `CLAUDE_PROJECT_DIR="$(git rev-parse --show-toplevel)"`
- Validate CLAUDE_PROJECT_DIR is set before any library sourcing or state operations
- Fail fast with clear error message if not in git repository
- Add early error buffering before library sourcing to capture bootstrap failures

**2. Library Sourcing Standardization**
- Enforce three-tier pattern in ALL bash blocks (currently only Block 1a partially compliant)
- Standard order: error-handling.sh â†’ state-persistence.sh â†’ workflow-state-machine.sh
- Use `_source_with_diagnostics` wrapper for fail-fast behavior
- Pre-flight function validation after sourcing to catch missing functions early
- PREREQUISITE: CLAUDE_PROJECT_DIR must be initialized before sourcing

**3. Environment Initialization**
- Remove hardcoded `/etc/bashrc` sourcing entirely (not essential for /plan functionality)
- Use portable bash initialization that checks file existence before sourcing
- Initialization order: CLAUDE_PROJECT_DIR â†’ library sourcing â†’ state restoration

**4. Agent Error Handling**
- Implement retry logic for topic-naming-agent (3 attempts with exponential backoff)
- Enhance fallback naming to extract keywords from user prompt instead of "no_name"
- Add detailed error diagnostics to identify agent failure modes (timeout, path issues, execution errors)

**5. Test Environment Separation**
- Add `CLAUDE_TEST_MODE` environment variable detection in error-handling.sh
- Route test errors to separate log file (errors-test.jsonl) when in test mode
- Update test scripts to set `CLAUDE_TEST_MODE=1`

**6. State Machine Enhancement**
- Add state cleanup logic at /plan command start to detect and reset stale state
- Allow "complete" â†’ "plan" transition for workflow restart scenarios
- Add defensive state validation with auto-correction for invalid states

### Component Interactions

```
/plan command
  â”œâ”€ Block 1a: Initialization
  â”‚   â”œâ”€ CLAUDE_PROJECT_DIR initialization (FIRST) âœ“
  â”‚   â”œâ”€ Remove /etc/bashrc sourcing âœ“
  â”‚   â”œâ”€ Three-tier library sourcing âœ“
  â”‚   â””â”€ Pre-flight function validation âœ“
  â”œâ”€ Block 1b: Topic Naming
  â”‚   â”œâ”€ CLAUDE_PROJECT_DIR initialization (FIRST) âœ“
  â”‚   â”œâ”€ Agent with retry logic âœ“
  â”‚   â””â”€ Enhanced fallback naming âœ“
  â”œâ”€ Block 1c: Topic Path Init
  â”‚   â”œâ”€ CLAUDE_PROJECT_DIR initialization (FIRST) âœ“
  â”‚   â”œâ”€ Fix library sourcing order âœ“
  â”‚   â”œâ”€ State restoration (after libs) âœ“
  â”‚   â””â”€ Pre-flight function validation âœ“
  â”œâ”€ Block 2: Research Verification
  â”‚   â”œâ”€ CLAUDE_PROJECT_DIR initialization (FIRST) âœ“
  â”‚   â””â”€ Three-tier sourcing âœ“
  â””â”€ Block 3: Plan Verification
      â”œâ”€ CLAUDE_PROJECT_DIR initialization (FIRST) âœ“
      â””â”€ Three-tier sourcing âœ“

error-handling.sh
  â””â”€ Test mode detection âœ“

workflow-state-machine.sh
  â””â”€ State cleanup/reset logic âœ“

Initialization Order (CRITICAL):
  1. CLAUDE_PROJECT_DIR (git rev-parse)
  2. Library sourcing (using CLAUDE_PROJECT_DIR paths)
  3. State restoration (using CLAUDE_PROJECT_DIR paths)
```

## Implementation Phases

### Phase 1: Remove Hardcoded /etc/bashrc Sourcing [COMPLETE]
dependencies: []

**Objective**: Eliminate exit code 127 errors caused by hardcoded `/etc/bashrc` sourcing

**Complexity**: Low

Tasks:
- [x] Search for all instances of `/etc/bashrc` sourcing in /plan command (file: .claude/commands/plan.md)
- [x] Remove or comment out hardcoded `/etc/bashrc` sourcing lines
- [x] Verify no essential functionality depends on /etc/bashrc being sourced
- [x] Test /plan command on system without /etc/bashrc to verify fix
- [x] Document removal in commit message with rationale

Testing:
```bash
# Run /plan command and verify no exit code 127 errors related to /etc/bashrc
/plan "test feature description" 2>&1 | grep -i "etc/bashrc" && echo "FAIL: Still sourcing /etc/bashrc" || echo "PASS: No /etc/bashrc sourcing"

# Check error log for exit code 127 errors in last 5 minutes
/errors --since 5m --type execution_error | jq -r '.[] | select(.details.exit_code == 127)' | wc -l
# Expected: 0
```

**Expected Duration**: 1 hour

---

### Phase 2: Enforce Three-Tier Library Sourcing Pattern and Environment Bootstrap [COMPLETE]
dependencies: ["Phase 1"]

**Objective**: Ensure all bash blocks in /plan command follow three-tier sourcing pattern and proper environment initialization order to prevent function unavailability errors and state restoration failures

**Complexity**: Medium

Tasks:
- [x] Audit all bash blocks in /plan command for initialization order and library sourcing (file: .claude/commands/plan.md)
- [x] Add CLAUDE_PROJECT_DIR initialization as FIRST action in all bash blocks (Blocks 1a, 1b, 1c, 2, 3)
- [x] Use git-based detection pattern: `git rev-parse --show-toplevel` for CLAUDE_PROJECT_DIR
- [x] Add validation that CLAUDE_PROJECT_DIR is set before attempting library sourcing
- [x] Update Block 1a sourcing order: error-handling.sh â†’ state-persistence.sh â†’ workflow-state-machine.sh
- [x] Fix Block 1c sourcing order (currently state-persistence before error-handling)
- [x] Add `_source_with_diagnostics` wrapper for all Tier 1 library sourcing
- [x] Add pre-flight function validation after sourcing in all blocks
- [x] Verify required functions available before use: `append_workflow_state`, `save_completed_states_to_state`, `validate_workflow_id`
- [x] Add validate_state_restoration() checks after load_workflow_state in Blocks 1c, 2, 3
- [x] Use log_early_error() for CLAUDE_PROJECT_DIR initialization failures in all blocks
- [x] Export COMMAND_NAME and USER_ARGS in Block 1a for state persistence
- [x] Document initialization order dependency chain: CLAUDE_PROJECT_DIR â†’ library sourcing â†’ state restoration
- [x] Verify no code paths assume CLAUDE_PROJECT_DIR is inherited from previous blocks
- [x] Add early error buffering before library sourcing (bash stderr redirection to temp file)
- [x] Ensure initialization errors are parseable by /errors command even without error-handling.sh
- [x] Run validation script to verify compliance (script: .claude/scripts/validate-all-standards.sh --sourcing)
- [x] Document sourcing pattern and environment bootstrap in inline comments
- [x] Update /plan command completion message to use console summary format (Summary/Artifacts/Next Steps)
- [x] Include in console summary: ðŸ“Š Reports, ðŸ“„ Plan, actionable next steps (/build command)

Testing:
```bash
# Run library sourcing validation script
bash /home/benjamin/.config/.claude/scripts/validate-all-standards.sh --sourcing --file .claude/commands/plan.md
# Expected: All ERROR-level violations resolved

# Verify CLAUDE_PROJECT_DIR is initialized before library sourcing in all blocks
grep -A 10 "^#.*Block.*bash" .claude/commands/plan.md | grep -B 5 "source.*CLAUDE_PROJECT_DIR" | grep -q "CLAUDE_PROJECT_DIR=.*git rev-parse" && echo "PASS: CLAUDE_PROJECT_DIR initialized first" || echo "FAIL: CLAUDE_PROJECT_DIR not initialized before sourcing"

# Test state restoration without CLAUDE_PROJECT_DIR (should fail gracefully)
(unset CLAUDE_PROJECT_DIR; /plan "test feature" 2>&1 | grep -q "ERROR:.*CLAUDE_PROJECT_DIR\|Not in a git repository") && echo "PASS: Graceful failure" || echo "FAIL: No error handling"

# Test state restoration validation with missing COMMAND_NAME
(unset COMMAND_NAME; /plan "test feature" 2>&1 | grep -q "State restoration failed") && echo "PASS: validate_state_restoration working" || echo "FAIL: No state validation"

# Run /plan command and check for function unavailability errors
/plan "test feature" 2>&1 | grep -i "command not found\|function not available\|Failed to restore WORKFLOW_ID" && echo "FAIL: Functions still missing or state restoration failed" || echo "PASS: All functions available and state restored"

# Check error log for exit code 127 errors related to append_workflow_state
/errors --since 1h --type execution_error | jq -r '.[] | select(.details.command | contains("append_workflow_state"))' | wc -l
# Expected: 0

# Check error log for exit code 1 errors related to state restoration
/errors --since 1h --type execution_error | jq -r '.[] | select(.message | contains("Failed to restore"))' | wc -l
# Expected: 0

# Validate console summary format compliance
/plan "test feature" 2>&1 | grep -E "Summary:|Artifacts:|Next Steps:" && echo "PASS: Console summary format correct" || echo "FAIL: Missing console summary sections"
```

**Expected Duration**: 5 hours

---

### Phase 3: Improve Topic Naming Agent Error Handling [COMPLETE]
dependencies: ["Phase 2"]

**Objective**: Add retry logic and enhanced fallback naming to reduce topic naming agent failures

**Complexity**: Medium

Tasks:
- [x] Review existing `validate_agent_output_with_retry` implementation (file: .claude/lib/core/error-handling.sh)
- [x] Verify retry logic is correctly invoked in Block 1b (currently has 3 retries with 10s timeout)
- [x] Implement enhanced fallback naming function that extracts keywords from user prompt (file: .claude/lib/plan/topic-utils.sh)
- [x] Update Block 1c to use enhanced fallback naming instead of "no_name_error"
- [x] Add agent stderr/stdout capture and logging for diagnostics
- [x] Test fallback naming with various user prompts to ensure quality
- [x] Document fallback naming algorithm in code comments

Testing:
```bash
# Test agent retry logic by simulating timeout
CLAUDE_TEST_MODE=1 /plan "test feature" 2>&1 | grep -i "retry\|attempt" && echo "PASS: Retry logic active" || echo "FAIL: No retry detected"

# Test enhanced fallback naming
TOPIC_NAME=$(bash -c 'source .claude/lib/plan/topic-utils.sh; extract_topic_keywords "implement JWT authentication with refresh tokens"')
echo "$TOPIC_NAME" | grep -q "jwt_auth\|authentication" && echo "PASS: Keywords extracted" || echo "FAIL: Generic fallback used"

# Check error log for topic naming agent failures
/errors --since 1d --type agent_error | jq -r '.[] | select(.source == "bash_block_1c")' | wc -l
# Expected: Reduced by 50% or more compared to pre-fix baseline
```

**Expected Duration**: 4 hours

---

### Phase 4: Separate Test Environment Errors from Production Log [COMPLETE]
dependencies: ["Phase 2"]

**Objective**: Prevent test environment errors from polluting production error logs

**Complexity**: Low

Tasks:
- [x] Add `CLAUDE_TEST_MODE` environment variable detection in error-handling.sh (file: .claude/lib/core/error-handling.sh)
- [x] Update `log_command_error` function to route to errors-test.jsonl when `CLAUDE_TEST_MODE=1`
- [x] Update `ensure_error_log_exists` to create both errors.jsonl and errors-test.jsonl
- [x] Update all test scripts to set `CLAUDE_TEST_MODE=1` before running tests (directory: .claude/tests/)
- [x] Verify test errors are logged to separate file
- [x] Update /errors command to query errors-test.jsonl when `--test` flag provided
- [x] Document test mode in error logging documentation

Testing:
```bash
# Test that CLAUDE_TEST_MODE routes errors correctly
CLAUDE_TEST_MODE=1 bash -c 'source .claude/lib/core/error-handling.sh; ensure_error_log_exists; log_command_error "/test" "test_123" "args" "test_error" "Test error message" "test_source" "{}"'
# Verify error logged to errors-test.jsonl, not errors.jsonl
test -f ~/.claude/data/logs/errors-test.jsonl && echo "PASS: Test log created" || echo "FAIL: Test log missing"
grep -q "test_error" ~/.claude/data/logs/errors.jsonl && echo "FAIL: Error in production log" || echo "PASS: Production log clean"

# Run unit tests and verify errors go to test log
CLAUDE_TEST_MODE=1 bash .claude/tests/test_plan_validation.sh
ERROR_COUNT=$(jq -r 'select(.workflow_id == "test_123")' ~/.claude/data/logs/errors.jsonl 2>/dev/null | wc -l)
[ "$ERROR_COUNT" -eq 0 ] && echo "PASS: No test errors in production log" || echo "FAIL: Test errors leaked to production"
```

**Expected Duration**: 2 hours

---

### Phase 5: Add State Machine Workflow Reset Logic [COMPLETE]
dependencies: ["Phase 2"]

**Objective**: Enable /plan command to restart workflows after completion

**Complexity**: Medium

Tasks:
- [x] Review current state machine transition rules (file: .claude/lib/workflow/workflow-state-machine.sh)
- [x] Add state cleanup function to detect and reset stale "complete" state
- [x] Implement "complete" â†’ "plan" transition in state machine (Option A: cleanup, or Option B: explicit transition)
- [x] Add defensive state validation in /plan Block 1a to auto-correct invalid states
- [x] Update state machine documentation to describe reset behavior
- [x] Test workflow restart scenarios (complete â†’ plan transition)
- [x] Verify idempotent state transition standard is maintained

Testing:
```bash
# Test state machine reset logic
# 1. Run /plan command to completion
/plan "test feature for state reset"

# 2. Verify state is "complete"
WORKFLOW_ID=$(cat ~/.claude/tmp/plan_state_id.txt)
STATE_FILE=~/.claude/tmp/workflow_${WORKFLOW_ID}.sh
grep -q "CURRENT_STATE=complete" "$STATE_FILE" && echo "State is complete" || echo "ERROR: State not complete"

# 3. Run /plan command again to test reset
/plan "another test feature" 2>&1 | grep -i "state transition.*failed" && echo "FAIL: Reset failed" || echo "PASS: Reset successful"

# Check error log for state machine transition errors
/errors --since 1h --type state_error | jq -r '.[] | select(.message | contains("No valid transitions"))' | wc -l
# Expected: 0
```

**Expected Duration**: 3 hours

---

### Phase 6: Update Error Log Status [COMPLETE]
dependencies: ["Phase 1", "Phase 2", "Phase 3", "Phase 4", "Phase 5"]

**Objective**: Update error log entries from FIX_PLANNED to RESOLVED

**Complexity**: Low

Tasks:
- [x] Verify all fixes are working (tests pass, no new errors generated)
- [x] Update error log entries to RESOLVED status:
  ```bash
  source .claude/lib/core/error-handling.sh
  RESOLVED_COUNT=$(mark_errors_resolved_for_plan "/home/benjamin/.config/.claude/specs/969_repair_plan_20251129_155633/plans/001-repair-plan-20251129-155633-plan.md")
  echo "Resolved $RESOLVED_COUNT error log entries"
  ```
- [x] Verify no FIX_PLANNED errors remain for this plan:
  ```bash
  REMAINING=$(query_errors --status FIX_PLANNED | jq -r '.repair_plan_path' | grep -c "969_repair_plan_20251129_155633" || echo "0")
  [ "$REMAINING" -eq 0 ] && echo "All errors resolved" || echo "WARNING: $REMAINING errors still FIX_PLANNED"
  ```
- [x] Run comprehensive validation to ensure no regressions
- [x] Document resolution in plan summary

Testing:
```bash
# Verify error log status updates
query_errors --status RESOLVED | jq -r 'select(.repair_plan_path | contains("969_repair_plan_20251129_155633"))' | jq -s 'length'
# Expected: 25 (all errors from this repair plan)

# Verify no FIX_PLANNED errors remain
query_errors --status FIX_PLANNED | jq -r 'select(.repair_plan_path | contains("969_repair_plan_20251129_155633"))' | jq -s 'length'
# Expected: 0

# Run 7-day validation to measure error reduction
# Wait 7 days after deployment, then check error count
/errors --command /plan --since 7d --summary
# Expected: Error count reduced by â‰¥80% compared to pre-fix baseline (25 errors over 8 days = 3.1 errors/day â†’ <0.6 errors/day)
```

**Expected Duration**: 1 hour

---

## Execution Waves

Based on phase dependencies, the implementation can be organized into these execution waves:

**Wave 1**: Phase 1 (no dependencies)
- Remove hardcoded /etc/bashrc sourcing

**Wave 2**: Phase 2 (depends on Phase 1)
- Enforce three-tier library sourcing and environment bootstrap

**Wave 3**: Phase 3, Phase 4, Phase 5 (all depend on Phase 2)
- Phase 3: Improve topic naming agent error handling
- Phase 4: Separate test environment errors from production log
- Phase 5: Add state machine workflow reset logic

**Wave 4**: Phase 6 (depends on Phases 1-5)
- Update error log status

**Parallel Execution Opportunities**:
- Wave 3 can run Phases 3, 4, and 5 in parallel (all three only depend on Phase 2)
- Estimated time savings: ~56% for Wave 3 (9 hours sequential â†’ 4 hours parallel, assuming Phase 3 is longest at 4 hours)

**Total Sequential Duration**: 16 hours
**Optimal Parallel Duration**: ~11 hours (31% reduction)

---

## Testing Strategy

### Unit Testing
- Test library sourcing compliance using validation script
- Test enhanced fallback naming function with various user prompts
- Test state machine reset logic with workflow restart scenarios
- Test error log routing with CLAUDE_TEST_MODE flag

### Integration Testing
- Run /plan command end-to-end on multiple systems (with and without /etc/bashrc)
- Verify all bash blocks execute without function unavailability errors
- Test topic naming agent with intentional timeouts to trigger retry logic
- Verify test environment errors are isolated from production logs

### Regression Testing
- Run existing /plan command test suite to ensure no functionality broken
- Verify all error types from error analysis are eliminated
- Check for new error patterns introduced by fixes
- Validate error log integrity after status updates

### Performance Testing
- Measure /plan command execution time before and after fixes
- Verify retry logic doesn't introduce excessive delays
- Check state file I/O performance with bulk append operations

### Validation Commands
```bash
# Comprehensive validation script
bash /home/benjamin/.config/.claude/scripts/validate-all-standards.sh --sourcing --file .claude/commands/plan.md

# Error log analysis
/errors --command /plan --since 7d --summary

# State machine validation
bash /home/benjamin/.config/.claude/tests/test_state_machine.sh

# Library sourcing check
grep -r "source.*state-persistence" .claude/commands/plan.md | grep -v "_source_with_diagnostics" && echo "WARNING: Direct sourcing found" || echo "PASS: All sourcing uses wrapper"
```

## Documentation Requirements

### Code Documentation
- [ ] Update inline comments in /plan command to explain sourcing pattern
- [ ] Document enhanced fallback naming algorithm in topic-utils.sh
- [ ] Add JSDoc-style comments for new error-handling functions
- [ ] Document state machine reset behavior in workflow-state-machine.sh

### User-Facing Documentation
- [ ] Update /plan command guide with troubleshooting section for common errors
- [ ] Document CLAUDE_TEST_MODE usage in testing documentation
- [ ] Add section on workflow restart scenarios to command reference
- [ ] Update error logging documentation with test mode details

### Standards Updates
- [ ] Verify Code Standards reflect three-tier sourcing pattern (already documented)
- [ ] Add test environment error isolation to Testing Protocols
- [ ] Document state machine lifecycle in State-Based Orchestration docs

## Dependencies

### External Dependencies
- jq (JSON parsing for error log manipulation)
- grep (pattern matching for validation)
- bash â‰¥4.0 (for modern bash features)

### Internal Dependencies
- error-handling.sh (version â‰¥1.0.0 with test mode support)
- state-persistence.sh (version â‰¥1.5.0 with bulk append)
- workflow-state-machine.sh (version â‰¥2.0.0 with reset logic)
- topic-utils.sh (new functions for enhanced fallback naming)

### Library Requirements
- All libraries must be sourced using three-tier pattern
- Library versions must meet minimum requirements from frontmatter

### Standards Compliance
- Follow Code Standards for bash sourcing pattern
- Follow Testing Protocols for test environment separation
- Follow Error Logging Standards for centralized error tracking
- Follow Clean-Break Development Standard for refactoring approach

## Risk Assessment

### High-Risk Changes
- **State machine modification**: Incorrect transition logic could break all workflows
  - Mitigation: Extensive unit testing, staged rollout, easy rollback plan
- **Library sourcing order**: Wrong order could cause cascading failures
  - Mitigation: Pre-flight function validation, validation script enforcement

### Medium-Risk Changes
- **Agent retry logic**: Could introduce timeout delays or infinite loops
  - Mitigation: Timeout limits, retry count limits, circuit breaker pattern
- **Test mode routing**: Could accidentally log production errors to test log
  - Mitigation: Explicit environment variable checks, clear documentation

### Low-Risk Changes
- **Removing /etc/bashrc sourcing**: No essential functionality depends on it
  - Mitigation: Verify on multiple systems before deployment
- **Enhanced fallback naming**: Falls back to existing behavior on failure
  - Mitigation: Quality testing with diverse user prompts

### Rollback Plan
If critical issues arise during deployment:
1. Revert git commit containing changes
2. Re-run validation scripts to verify rollback
3. Monitor error logs for 24 hours post-rollback
4. Document issues encountered for future fix attempts

## Performance Considerations

### Expected Performance Impact
- **Retry logic**: May add up to 30 seconds (3 retries Ã— 10s timeout) in worst case
  - Acceptable tradeoff for improved reliability
- **Pre-flight validation**: Adds ~50ms per bash block for function checks
  - Negligible impact on overall command execution time
- **Enhanced fallback naming**: Adds ~100ms for keyword extraction
  - Only invoked when agent fails, minimal overall impact

### Optimization Opportunities
- Bulk state append operations reduce I/O overhead (already implemented)
- Parallel agent execution could reduce overall command latency (future enhancement)
- Caching topic naming results for identical prompts (future enhancement)

## Completion Checklist

Before marking this plan as complete, verify:
- [ ] All 25 logged errors eliminated or resolved
- [ ] Three-tier sourcing pattern enforced and validated
- [ ] Topic naming agent has retry logic and enhanced fallback
- [ ] Test environment errors separated from production logs
- [ ] State machine supports workflow restart scenarios
- [ ] All tests pass (unit, integration, regression)
- [ ] Documentation updated with changes
- [ ] Error log entries marked RESOLVED
- [ ] 7-day validation shows â‰¥80% error reduction
- [ ] No new error patterns introduced
