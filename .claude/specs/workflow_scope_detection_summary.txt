WORKFLOW SCOPE DETECTION ANALYSIS - EXECUTIVE SUMMARY
=====================================================

IMPLEMENTATION FILE
-------------------
Location: /home/benjamin/.config/.claude/lib/workflow-scope-detection.sh
Function: detect_workflow_scope($workflow_description)
Returns: One of {research-only, research-and-plan, research-and-revise, full-implementation, debug-only}

REGEX PATTERNS USED (9 PATTERNS IN 5-TIER PRIORITY)
----------------------------------------------------

PRIORITY 1 (Highest Specificity - Revision patterns)
------
Pattern 1a (Line 42):
  ^(revise|update|modify).*(plan|implementation).*(accommodate|based on|using|to|for)
  Anchor: YES (^)  |  Scope: research-and-revise
  Examples: "Revise /path/plans/001.md to accommodate changes" ✓

Pattern 1b (Line 54):
  (research|analyze).*(and |then |to ).*(revise|update.*plan|modify.*plan)
  Anchor: NO (✗ ISSUE) |  Scope: research-and-revise
  Examples: "research patterns and revise the plan" ✓
  Issue: Missing ^ anchor allows matching in unwanted contexts

PRIORITY 2 (Plan Path Detection)
------
Pattern 2 (Line 60):
  (^|[[:space:]])(\.|/)?(.*/)?specs/[0-9]+_[^/]+/plans/[^[:space:]]+\.md
  Anchor: YES (^|space)  |  Scope: full-implementation
  Examples: "implement specs/661_auth/plans/001.md" ✓

PRIORITY 3 (Research-Only with Action Check)
------
Pattern 3a (Line 68):
  ^research.*
  Anchor: YES (^)  |  Scope: research-only (if no action keywords)
  Examples: "research authentication patterns" ✓

Pattern 3b (Line 69 - nested):
  (plan|implement|fix|debug|create|add|build)
  Check: If action keyword found → returns research-and-plan instead

PRIORITY 4 (Explicit Keywords)
------
Pattern 4a (Line 79):
  (^|[[:space:]])(implement|execute)
  Anchor: YES (word boundary)  |  Scope: full-implementation

Pattern 4b (Line 83):
  (plan|create.*plan|design)
  Anchor: NO  |  Scope: research-and-plan

Pattern 4c (Line 85):
  (fix|debug|troubleshoot)
  Anchor: NO  |  Scope: debug-only

Pattern 4d (Line 87):
  (build|add|create).*feature
  Anchor: NO  |  Scope: full-implementation

PRIORITY 5 (Default Fallback)
------
Returns: research-and-plan


FAILURE MODES IDENTIFIED
------------------------

FAILURE MODE 1: Pattern 1b Missing Start Anchor (MEDIUM SEVERITY)
  Location: Line 54
  Issue: Pattern allows matching discussion of workflow types
  Example: "research how to use research-and-revise pattern"
           Could match if "and" + "revise" appear naturally
  Likelihood: LOW (protected by elif chain, nested checks)
  Status: DOCUMENTED in code comments (lines 25-40)

FAILURE MODE 2: Greedy Match Behavior (LOW SEVERITY)
  Location: Line 42
  Issue: .* matches can consume legitimate keywords
  Example: "Revise the implementation plan" - implementation consumed by first .*
  Why OK: Pattern checks for (plan|implementation) AFTER greedy match
  Status: FIXED and tested in commit 1984391a

FAILURE MODE 3: Keyword Proximity (LOW SEVERITY)
  Location: Lines 83-88
  Issue: Keywords match anywhere, no word boundary checking
  Impact: Minimal - keywords far apart unlikely in natural language
  Status: MITIGATED by elif chain (first match wins)

FAILURE MODE 4: "implement" vs "implement feature" (MEDIUM SEVERITY)
  Location: Lines 79 vs 87
  Issue: Two patterns could match same input
  Impact: NONE - both return full-implementation
  Status: No conflict since results identical

FAILURE MODE 5: Research + Conflicting Keywords (LOW SEVERITY)
  Location: Lines 68-75
  Issue: "research + implement" ambiguity
  Example: "research patterns and implement authentication"
  Current: research-and-plan (correct - research THEN plan)
  Status: WORKING CORRECTLY


TEST COVERAGE ANALYSIS
----------------------

File 1: test_scope_detection.sh
  Pass Rate: 17/19 (89%)
  Failures: 
    - Test 4: "research auth and implement feature" → Got research-and-plan (expected full-implementation)
    - Test 5: "research and build authentication feature" → Got research-and-plan (expected full-implementation)
  Note: These may be intentional - "research + X" interpreted as "research then plan"

File 2: test_workflow_scope_detection.sh
  Pass Rate: 20/20 (100%)
  Coverage: All 5 scope types, plan paths, edge cases

File 3: test_supervise_scope_detection.sh
  Pass Rate: Expected 19/19 (uses fallback library)
  Note: Tests /supervise compatibility, different library


COVERAGE GAPS (High-Value Test Cases Missing)
----------------------------------------------

Gap 1: False Positives - Discussing Workflow Types
  Test Case: "research the output showing research-and-revise behavior"
  Current: Returns research-only (correct by accident)
  Risk: Pattern 1b could match if phrased differently

Gap 2: Pattern 1a with "for" Trigger
  Test Case: "revise implementation for new features"
  Status: Should match but needs explicit test

Gap 3: Mixed Keywords - Debug + Implement
  Test Case: "debug and implement new authentication"
  Current: Returns debug-only (pattern 85 wins via elif)
  Status: Needs explicit test to verify precedence

Gap 4: Plan Path Variations
  Test Case: "implement ../specs/042_auth/plans/001.md"
  Status: Parent directory traversal not tested

Gap 5: Create Keyword Ambiguity
  Test Case: "create a plan for auth" vs "create auth feature"
  Status: Both could match create patterns, precedence matters

Gap 6: Whitespace Edge Cases
  Test Case: "research  patterns  with   extra spaces"
  Status: Not tested with varied whitespace

Gap 7: Research-Only with Modifiers
  Test Case: "research patterns thoroughly"
  Status: Should stay research-only but not explicitly tested

Gap 8: Keyword Substrings
  Test Case: "updated system" (does "update" pattern match?)
  Status: Not tested with partial word matches

Gap 9: Research + "and then" Connector
  Test Case: "research patterns and then revise our approach"
  Status: Ambiguous - is "our approach" the plan or something else?

Gap 10: Case Insensitivity Boundaries
  Test Case: "RESEARCH all PATTERNS"
  Status: Not comprehensively tested with all-caps variants


IMPACT ANALYSIS - When WORKFLOW_SCOPE Is Wrong
----------------------------------------------

Impact 1: State Machine Terminal State (workflow-state-machine.sh:113)
  Wrong scope → Wrong terminal state → Workflow doesn't know when to stop

Impact 2: Coordinate Command Flow (coordinate.md:789+)
  Wrong scope → Entire workflow branches on this single variable
  Examples:
    - research-and-revise → Uses revise specialist agent
    - full-implementation → Uses implementer-coordinator agent
    - Others → Default research→plan→implement→test→document

Impact 3: Phase Behavior (coordinate.md:950-1040)
  Wrong scope → Skips wrong phases, invokes wrong agents
  Example: "implement <plan>" detected as research-and-plan
          → Skips implementation, tries to create new plan

Impact 4: Error Handling (coordinate.md:695, 1103)
  Invalid scope → Immediate termination with error


DOWNSTREAM DEPENDENCIES
-----------------------

Called From:
  1. workflow-state-machine.sh (sm_init function) - PRIMARY CALLER
  2. /coordinate command (80+ references)
  3. Test files

Used By:
  1. State machine initialization (determine terminal state)
  2. Coordinate workflow routing (research-and-revise vs standard)
  3. Phase execution logic (determine which agents to invoke)
  4. Validation (must be one of 5 valid scopes)


PATTERN PRECEDENCE CRITICAL BEHAVIORS
--------------------------------------

1. First match wins (elif chain) - ordering matters
2. Research-only has nested check for action keywords
3. Pattern 1a must match BEFORE Pattern 1b (more specific)
4. Plan path detection BEFORE research-only (avoid false negatives)
5. Revision patterns have HIGHEST priority (most specific)


CURRENT REGEX PATTERNS SUMMARY TABLE
------------------------------------

Priority | Pattern ID | Line | Start Anchor? | Scope | Key Keywords
---------|-----------|------|---------------|-------|---------------
1        | 1a        | 42   | YES (^)       | revise-plan | revise,update,modify
1        | 1b        | 54   | NO (✗)        | revise-plan | research,and,revise
2        | 2         | 60   | YES           | impl   | specs/.../plans/
3        | 3a        | 68   | YES (^)       | research-only | research
3        | 3b        | 69   | NO            | plan   | plan,implement,fix
4        | 4a        | 79   | YES           | impl   | implement,execute
4        | 4b        | 83   | NO            | plan   | plan,design,create
4        | 4c        | 85   | NO            | debug  | fix,debug,troubleshoot
4        | 4d        | 87   | NO            | impl   | build,add,create+feature


KEY FINDINGS
============

1. IMPLEMENTATION IS LARGELY CORRECT
   - Pattern priority is well-designed (specific → general)
   - Most patterns properly anchored (start or word boundary)
   - Default fallback (research-and-plan) is sensible

2. MAIN VULNERABILITY: Pattern 1b (Line 54) Missing Anchor
   - Could match discussion of workflow types
   - Protected by elif chain and nested checks
   - Low likelihood of causing issues in practice
   - Documented in code comments (lines 25-40)

3. TEST COVERAGE IS GOOD BUT HAS GAPS
   - 56/58 tests passing (96.5%)
   - Two intentional "failures" in test_scope_detection.sh tests 4-5
     (tests expect full-implementation, get research-and-plan)
   - 10+ high-value edge case tests missing

4. DOWNSTREAM IMPACT IS SIGNIFICANT
   - WORKFLOW_SCOPE determines entire workflow execution path
   - Wrong classification → Wrong agents invoked, wrong phases executed
   - Bug was fixed in commit 1984391a (plan path detection priority)

5. MOST RECENT FIX (Commit 1984391a)
   - Fixed "implement <plan>" being detected as research-and-plan
   - Added explicit plan path detection at PRIORITY 2
   - Moved plan path check BEFORE research-only check
   - This was a real bug with significant impact
