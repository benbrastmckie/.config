# Lean Metadata Phase Refactor Implementation Plan

## Metadata
- **Date**: 2025-12-04 (Revised)
- **Feature**: Refactor Lean plan metadata to specify target Lean files per-phase instead of globally
- **Status**: [COMPLETE]
- **Estimated Hours**: 5-8 hours
- **Standards File**: /home/benjamin/.config/CLAUDE.md
- **Research Reports**:
  - [Lean Metadata Phase Refactor Research](../reports/001-lean-metadata-phase-refactor-research.md)
  - [Phase Heading Format Analysis](../reports/002-phase-heading-format-analysis.md)

## Overview

This plan refactors Lean plan metadata to support per-phase Lean file specifications using Tier 1 discovery format (`lean_file:` after phase heading) instead of relying solely on global metadata (Tier 2 fallback). This enables multi-file Lean plans where different phases can target different .lean files, while maintaining backward compatibility with existing single-file plans.

**Key Insight from Research**: The /lean-build command already implements 2-tier discovery (phase-specific preferred, global fallback), and lean-coordinator already supports per-phase file handling through the `theorem_tasks` array. The missing piece is updating lean-plan-architect to generate the `lean_file:` field in phase templates.

## Research Summary

Key findings from the Lean Metadata Phase Refactor research:

1. **Tier 1 Discovery Already Implemented**: /lean-build searches for `lean_file:` after phase headings (lines 221-242) and prefers this over global metadata
2. **lean-coordinator Already Supports Per-Phase Files**: The coordinator delegates to lean-implementer with phase-specific file information via `theorem_tasks` array, enabling different phases to target different files
3. **Current Plans Use Global Metadata Only**: Existing plans generated by lean-plan-architect only include Tier 2 global `**Lean File**:` metadata - no phase-level examples exist
4. **Backward Compatibility Preserved**: Tier 2 fallback ensures existing plans with global metadata continue working without modification
5. **Phase Heading Format Already Compliant**: lean-plan-architect already uses `### Phase N:` (level 3 headings) matching the /create-plan standard - explicit documentation of this requirement should be added to ensure consistency is maintained

**Recommended Approach** (from research):
- Add `lean_file:` field immediately after phase heading (Tier 1 format) in lean-plan-architect phase template
- Keep Tier 2 global metadata as fallback for single-file plans
- No changes needed to /lean-build (discovery already implemented) or lean-coordinator (per-phase file support already exists)
- Primary implementation task: Update lean-plan-architect agent's phase format template to include `lean_file:` specification

## Success Criteria

- [ ] lean-plan-architect generates `lean_file:` field after each phase heading (Tier 1 format)
- [ ] lean-plan-architect uses `### Phase N:` heading format (level 3, matching /create-plan)
- [ ] Format requirements explicitly document both `lean_file:` and `###` heading level
- [ ] New multi-file plans specify different Lean files per phase
- [ ] Existing single-file plans continue working via Tier 2 fallback
- [ ] /lean-build correctly discovers phase-specific Lean files using Tier 1 mechanism
- [ ] lean-coordinator groups theorems by phase and file for efficient batch processing
- [ ] Documentation updated with Tier 1/Tier 2 format examples and migration guidance

## Technical Design

### Current Architecture

**2-Tier Discovery Mechanism** (already implemented in /lean-build):
1. **Tier 1 (Phase-Specific)**: Searches for `lean_file: /absolute/path` immediately after phase heading
2. **Tier 2 (Global Fallback)**: Searches for `- **Lean File**: /absolute/path` in metadata section
3. **Error Handling**: Clear error message with format examples if both tiers fail

**Agent Communication Flow**:
```
/lean-plan → lean-plan-architect → plan.md (with lean_file: per phase)
/lean-build → parse plan → extract lean_file (Tier 1 or Tier 2)
/lean-build → lean-coordinator → groups theorems by phase/file
lean-coordinator → lean-implementer (once per file with theorem batch)
```

### Proposed Changes

**Phase 1: lean-plan-architect Template Update**
- Add `lean_file:` field to phase template (after phase heading, before `dependencies:`)
- Include file selection logic in planning instructions (identify affected modules per phase)
- Generate absolute paths for `lean_file:` specifications
- Keep global `**Lean File**:` in metadata for backward compatibility

**Phase 2: Documentation Updates**
- Update lean-plan-command-guide.md with Tier 1/Tier 2 format comparison
- Add multi-file plan examples showing different files per phase
- Document migration path for existing plans (optional - no breaking changes)
- Add troubleshooting section for metadata extraction issues

**Phase 3: Integration Validation**
- Verify /lean-build Tier 1 discovery works with new phase format
- Test lean-coordinator file grouping with multi-file plans
- Validate backward compatibility with existing Tier 2 plans
- Confirm progress tracking updates correct phase markers

### Backward Compatibility Strategy

**No Breaking Changes**:
- Existing plans with global `**Lean File**:` continue working (Tier 2 fallback)
- /lean-build falls back to global metadata if phase-specific missing
- No immediate action required for existing plans
- Single-file workflow unchanged

**Optional Migration** (for multi-file needs):
1. Identify phases targeting different files
2. Add `lean_file:` after each phase heading (Tier 1)
3. Keep global `**Lean File**:` for backward compatibility
4. Test with /lean-build to verify Tier 1 discovery works

## Implementation Phases

### Phase 1: Update lean-plan-architect Phase Template [COMPLETE]
dependencies: []

**Objective**: Add `lean_file:` field to lean-plan-architect's phase format template and update planning instructions to generate phase-specific Lean file specifications

**Complexity**: Low

**File**: /home/benjamin/.config/.claude/agents/lean-plan-architect.md

**Tasks**:
- [x] Update phase format template (lines 300-330) to include `lean_file:` field
  - Goal: Add `lean_file: /absolute/path/to/file.lean` after phase heading, before `dependencies:`
  - Current template: Phase heading → dependencies → Objective → Theorems
  - New template: Phase heading → lean_file → dependencies → Objective → Theorems
  - Estimated: 0.5 hours

- [x] Update phase creation instructions (lines 124-179) to document `lean_file:` generation
  - Goal: Add guidance for selecting primary Lean file per phase based on theorem locations
  - Strategy: Update "Create Theorem-Level Phases" section with file selection logic
  - Estimated: 0.5 hours

- [x] Add file selection guidance to agent behavioral guidelines (lines 60-85)
  - Goal: Document how to analyze formalization goal and assign files per phase
  - Strategy: Add new section "Per-Phase File Targeting" with 5-step process
  - Content: Review goal → Identify affected modules → Assign one primary file per phase → Use absolute paths → Include relative path in phase body
  - Estimated: 0.5 hours

- [x] Update CRITICAL FORMAT REQUIREMENTS section to mandate `lean_file:` and `###` heading level
  - Goal: Ensure all new plans generated by lean-plan-architect include phase-level file specifications and use correct heading level
  - Strategy: Add bullet points to format requirements list (around line 170)
  - Content:
    - "- ALL phases MUST use `### Phase N:` heading format (level 3, matching /create-plan)"
    - "- ALL phases MUST have `lean_file:` field immediately after heading (Tier 1 format)"
  - Estimated: 0.5 hours

**Testing**:
```bash
# Verify template uses ### Phase heading level (level 3)
grep -q "^### Phase [0-9N]:" /home/benjamin/.config/.claude/agents/lean-plan-architect.md

# Verify template structure includes lean_file after phase heading
grep -A 5 "### Phase N:" /home/benjamin/.config/.claude/agents/lean-plan-architect.md | grep -q "lean_file:"

# Verify format requirements document both ### and lean_file:
grep -q "### Phase" /home/benjamin/.config/.claude/agents/lean-plan-architect.md
grep -q "lean_file:" /home/benjamin/.config/.claude/agents/lean-plan-architect.md

# Run lint validation for agent format compliance
bash /home/benjamin/.config/.claude/scripts/validate-all-standards.sh --staged
```

**Expected Duration**: 2.5 hours

---

### Phase 2: Update Documentation with Tier 1/Tier 2 Format Examples [COMPLETE]
dependencies: [1]

**Objective**: Update lean-plan command guide with Tier 1/Tier 2 discovery format comparison, multi-file plan examples, and migration guidance

**Complexity**: Low

**File**: /home/benjamin/.config/.claude/docs/guides/commands/lean-plan-command-guide.md

**Tasks**:
- [x] Add "Lean File Metadata Formats" section explaining Tier 1 vs Tier 2 discovery
  - Goal: Document both phase-specific (Tier 1) and global (Tier 2) metadata formats with discovery priority
  - Strategy: Create new section after command syntax, before usage examples
  - Content: Format specifications, discovery mechanism, when to use each tier
  - Estimated: 1 hour

- [x] Add multi-file plan example showing different files per phase
  - Goal: Demonstrate a plan with Phase 1 targeting TaskFrame.lean, Phase 2 targeting WorldHistory.lean, etc.
  - Strategy: Create "Multi-File Plan Example" subsection with 3-phase scenario
  - Example structure: Phase 1 (TaskFrame), Phase 2 (WorldHistory), Phase 3 (Truth)
  - Show `lean_file:` specification for each phase with absolute paths
  - Estimated: 0.5 hours

- [x] Document migration strategy for existing single-file plans
  - Goal: Explain optional migration path from Tier 2 to Tier 1 for plans needing multi-file support
  - Strategy: Add "Migrating to Per-Phase File Specifications" section
  - Content: Before/after examples, step-by-step migration process, validation steps
  - Note: Migration is optional - no breaking changes
  - Estimated: 0.5 hours

- [x] Add troubleshooting section for metadata extraction issues
  - Goal: Help users debug common Lean file discovery problems
  - Strategy: Add "Troubleshooting Lean File Discovery" subsection
  - Content: How to verify Tier 1 format (no blank lines after heading), how to verify Tier 2 format (markdown list syntax), absolute vs relative path issues
  - Estimated: 0.5 hours

**Testing**:
```bash
# Verify documentation structure includes new sections
grep -q "Lean File Metadata Formats" /home/benjamin/.config/.claude/docs/guides/commands/lean-plan-command-guide.md
grep -q "Multi-File Plan Example" /home/benjamin/.config/.claude/docs/guides/commands/lean-plan-command-guide.md
grep -q "Migrating to Per-Phase File Specifications" /home/benjamin/.config/.claude/docs/guides/commands/lean-plan-command-guide.md

# Verify Tier 1 and Tier 2 terms documented
grep -q "Tier 1" /home/benjamin/.config/.claude/docs/guides/commands/lean-plan-command-guide.md
grep -q "Tier 2" /home/benjamin/.config/.claude/docs/guides/commands/lean-plan-command-guide.md

# Run README validation
bash /home/benjamin/.config/.claude/scripts/validate-all-standards.sh --readme
```

**Expected Duration**: 2.5 hours

---

### Phase 3: Integration Testing and Validation [COMPLETE]
dependencies: [1, 2]

**Objective**: Validate that lean-plan-architect generates phase-level `lean_file:` specifications, /lean-build discovers them correctly via Tier 1, and backward compatibility with Tier 2 plans is preserved

**Complexity**: Medium

**Files**:
- /home/benjamin/.config/.claude/commands/lean-build.md (validation only - no changes)
- /home/benjamin/.config/.claude/agents/lean-coordinator.md (validation only - no changes)
- Test plans (create for validation)

**Tasks**:
- [x] Test lean-plan-architect generates `lean_file:` in phase headings
  - Goal: Verify new plans created by lean-plan-architect include Tier 1 format for each phase
  - Strategy: Run `/lean-plan "test formalization"` and inspect generated plan structure
  - Validation: Check each phase has `lean_file:` immediately after heading
  - Estimated: 0.5 hours

- [x] Test /lean-build Tier 1 discovery with new phase format
  - Goal: Verify /lean-build correctly extracts phase-specific `lean_file:` using Tier 1 mechanism
  - Strategy: Create test plan with phase-level `lean_file:` specifications and run /lean-build
  - Validation: Check LEAN_FILE_RAW extracted correctly from awk parsing (lines 206-242)
  - Estimated: 0.5 hours

- [x] Test lean-coordinator file grouping with multi-file plan
  - Goal: Verify coordinator groups theorems by file when different phases target different files
  - Strategy: Create multi-file test plan (Phase 1 → file1.lean, Phase 2 → file2.lean) and run /lean-build
  - Validation: Check coordinator invokes implementer once per distinct file with correct theorem batch
  - Estimated: 1 hour

- [x] Test backward compatibility with Tier 2 plans
  - Goal: Verify existing plans with only global `**Lean File**:` metadata still work via Tier 2 fallback
  - Strategy: Use existing single-file Lean plan (no phase-level metadata) and run /lean-build
  - Validation: Check Tier 2 discovery succeeds when Tier 1 returns empty (lines 244-256)
  - Estimated: 0.5 hours

- [x] Test progress tracking updates correct phase markers
  - Goal: Verify that when lean-implementer completes theorems, the correct phase heading status is updated
  - Strategy: Run /lean-build with multi-file plan and monitor phase marker transitions
  - Validation: Check `[NOT STARTED]` → `[IN PROGRESS]` → `[COMPLETE]` for correct phases
  - Estimated: 0.5 hours

**Testing**:
```bash
# Tier 1 discovery test - create test plan with phase-level lean_file
cat > /tmp/test_tier1_plan.md <<'EOF'
## Metadata
- **Date**: 2025-12-04
- **Feature**: Test Tier 1 Discovery
- **Lean File**: /tmp/fallback.lean

### Phase 1: Test Phase [COMPLETE]
lean_file: /tmp/test1.lean
dependencies: []

**Theorems**:
- [x] `test_theorem`: Test
  - Goal: `True`
  - Strategy: exact trivial
  - Complexity: Simple
EOF

# Extract Tier 1 (should return /tmp/test1.lean)
LEAN_FILE_RAW=$(awk -v target="1" '
  BEGIN { in_phase=0 }
  /^### Phase / {
    if (index($0, "Phase " target ":") > 0) {
      in_phase = 1
    } else {
      in_phase = 0
    }
    next
  }
  in_phase && /^lean_file:/ {
    sub(/^lean_file:[[:space:]]*/, "")
    print
    exit
  }
' /tmp/test_tier1_plan.md)

echo "Tier 1 result: $LEAN_FILE_RAW"
test "$LEAN_FILE_RAW" = "/tmp/test1.lean"

# Tier 2 fallback test - create plan with only global metadata
cat > /tmp/test_tier2_plan.md <<'EOF'
## Metadata
- **Date**: 2025-12-04
- **Feature**: Test Tier 2 Fallback
- **Lean File**: /tmp/fallback.lean

### Phase 1: Test Phase [COMPLETE]
dependencies: []

**Theorems**:
- [x] `test_theorem`: Test
EOF

# Extract Tier 2 (should return /tmp/fallback.lean)
LEAN_FILE_RAW_T2=$(grep "^- \*\*Lean File\*\*:" /tmp/test_tier2_plan.md | sed 's/^- \*\*Lean File\*\*:[[:space:]]*//')
echo "Tier 2 result: $LEAN_FILE_RAW_T2"
test "$LEAN_FILE_RAW_T2" = "/tmp/fallback.lean"

# Cleanup
rm -f /tmp/test_tier1_plan.md /tmp/test_tier2_plan.md
```

**Expected Duration**: 3 hours

---

## Testing Strategy

### Unit Testing
- **Tier 1 Discovery**: Verify /lean-build extracts `lean_file:` from phase headings using awk parser
- **Tier 2 Fallback**: Verify /lean-build falls back to global metadata when phase-specific missing
- **Template Validation**: Verify lean-plan-architect phase template includes `lean_file:` field

### Integration Testing
- **Full Workflow**: /lean-plan generates plan → /lean-build discovers files → lean-coordinator groups → lean-implementer processes
- **Multi-File Plan**: Create plan with different files per phase, verify correct file targeting
- **Backward Compatibility**: Use existing single-file plan, verify Tier 2 fallback works

### Validation Testing
- **Progress Tracking**: Verify phase markers update correctly for multi-file workflows
- **Error Handling**: Test error messages when both Tier 1 and Tier 2 discovery fail
- **Metadata Compliance**: Verify plan metadata validation passes for new format

## Documentation Requirements

**Files to Update**:
1. `/home/benjamin/.config/.claude/docs/guides/commands/lean-plan-command-guide.md`
   - Add Tier 1/Tier 2 format comparison section
   - Add multi-file plan example
   - Document migration strategy
   - Add troubleshooting for metadata discovery issues

2. `/home/benjamin/.config/.claude/agents/lean-plan-architect.md`
   - Update phase format template with `lean_file:` field
   - Add file selection guidance
   - Update format requirements to mandate `lean_file:` for new plans

**No Updates Needed**:
- `/home/benjamin/.config/.claude/commands/lean-build.md` (discovery already documented, lines 28-73)
- `/home/benjamin/.config/.claude/agents/lean-coordinator.md` (per-phase file handling already supported)

## Dependencies

**External Dependencies**:
- None (all infrastructure already implemented)

**Internal Dependencies**:
- /lean-build command Tier 1 discovery mechanism (already implemented, lines 206-242)
- lean-coordinator theorem_tasks array (already supports per-phase files)
- lean-implementer file processing (already receives single file per invocation)

**Standards Dependencies**:
- Plan Metadata Standard compliance (all required fields present)
- Lean 4 style guide (if exists in project)
- Documentation Standards (README format, link validity)

## Risk Analysis

**Risk 1: Existing Plans Break**
- **Likelihood**: Low
- **Impact**: High
- **Mitigation**: Tier 2 fallback maintains backward compatibility, existing plans work unchanged

**Risk 2: lean-plan-architect Doesn't Generate `lean_file:` Correctly**
- **Likelihood**: Low
- **Impact**: Medium
- **Mitigation**: Template update is straightforward (add one field), verification tests catch issues

**Risk 3: Documentation Lag Causes User Confusion**
- **Likelihood**: Medium
- **Impact**: Low
- **Mitigation**: Update documentation in Phase 2 before announcing feature, include migration examples

**Risk 4: Phase-File Mismatch in Complex Plans**
- **Likelihood**: Low
- **Impact**: Medium
- **Mitigation**: /lean-build validates file existence before coordinator invocation, clear error messages

## Completion Checklist

- [ ] lean-plan-architect phase template updated with `lean_file:` field
- [ ] lean-plan-architect format requirements explicitly mandate `### Phase N:` heading level
- [ ] lean-plan-architect instructions document file selection logic
- [ ] Documentation updated with Tier 1/Tier 2 format comparison
- [ ] Multi-file plan example added to command guide
- [ ] Migration strategy documented
- [ ] Troubleshooting section added
- [ ] Tier 1 discovery validated with test plans
- [ ] Tier 2 fallback validated with existing plans
- [ ] Multi-file workflow tested end-to-end
- [ ] Progress tracking validated for multi-file plans
- [ ] All standards validation checks pass
