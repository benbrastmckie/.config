# Fix coordinate.md Bash Execution Failures - Diagnostic & Resolution Plan

## Metadata
- **Date**: 2025-11-09
- **Feature**: Bug Fix - Mysterious "!: command not found" errors in coordinate.md execution
- **Scope**: Systematic diagnosis and resolution of bash execution failures
- **Estimated Phases**: 4 phases (diagnostic-first approach)
- **Estimated Hours**: 3-4 hours
- **Standards File**: /home/benjamin/.config/CLAUDE.md
- **Related Specs**:
  - 617 (Fixed ${!...} patterns in library files - completed and verified working)
  - 613 (Fixed coordinate.md state machine errors)
  - 602 (State-based orchestration refactor)
- **Related Research**:
  - [Coordinate Orchestration Best Practices Overview](../../623_coordinate_orchestration_best_practices/reports/001_coordinate_orchestration_best_practices/OVERVIEW.md) - Comprehensive research on bash execution patterns, error handling, state management, and diagnostic tooling supporting this fix
- **Related Documentation**:
  - `.claude/docs/guides/orchestration-troubleshooting.md` (existing troubleshooting infrastructure)
  - `.claude/docs/guides/coordinate-command-guide.md` (coordinate-specific documentation)
  - `.claude/docs/troubleshooting/` (troubleshooting directory structure)

## Problem Statement

### Error Evidence from coordinate_output.md (2025-11-09 18:33)

```
State machine initialized: scope=research-and-plan, terminal=plan
/run/current-system/sw/bin/bash: line 248: !: command not found
/run/current-system/sw/bin/bash: line 260: !: command not found

ERROR: TOPIC_PATH not set after workflow initialization
```

### Research Findings

**What We Know:**
1. ✅ Spec 617 fixed all `${!...}` patterns in library files (verified working)
2. ✅ Libraries (workflow-initialization.sh, context-pruning.sh) work correctly when tested directly
3. ✅ History expansion is OFF by default in non-interactive shells
4. ✅ `set +H` was previously tried and did NOT fix the issue
5. ✅ Error line numbers (248, 260) correspond to coordinate.md source lines
6. ✅ Lines 248/260 are inside bash blocks with no apparent `!` issues
7. ❌ Standard fixes (set +H, escaping, etc.) don't apply to this scenario

**What's Mysterious:**
- Error occurs during execution of first bash block
- But line numbers reference second bash block
- No bare `!` characters found at those lines
- Libraries work fine in isolation
- Issue is specific to coordinate.md execution through Claude's Bash tool

### Root Cause Hypothesis

The issue likely involves:
1. How Claude Code's Bash tool processes markdown and extracts bash blocks
2. Possible preprocessing/templating that introduces problematic characters
3. Interaction between bash block execution context and library sourcing
4. Potential line number reporting issues masking the true error location

## Success Criteria

- [ ] Understand exact mechanism causing "!: command not found" errors
- [ ] /coordinate executes successfully through complete workflows
- [ ] TOPIC_PATH and all workflow variables properly initialized
- [ ] Solution is robust and doesn't break other functionality
- [ ] Root cause documented per existing troubleshooting infrastructure
- [ ] Integration with `.claude/docs/guides/orchestration-troubleshooting.md`

## Implementation Phases

### Phase 1: Comprehensive Diagnostics & Root Cause Identification
**Objective**: Add extensive logging to understand exact execution flow and error source
**Complexity**: Medium
**Priority**: CRITICAL (must understand before fixing)

**Tasks:**

- [ ] **Add Debug Wrapper to First Bash Block**: Instrument coordinate.md initialization
  ```bash
  # At start of first bash block (after line 23 marker):
  set -x  # Enable xtrace for detailed execution log
  echo "DEBUG: Bash version: $BASH_VERSION"
  echo "DEBUG: Shell options:"
  set -o | grep -E "history|histexpand|interactive"
  echo "DEBUG: Starting coordinate initialization..."

  # ... existing code ...

  # At end of first bash block:
  echo "DEBUG: First bash block completed"
  set +x
  ```

- [ ] **Add Library Sourcing Diagnostics**: Track which libraries are loaded
  ```bash
  # Before each 'source' command:
  echo "DEBUG: Sourcing ${LIB_DIR}/workflow-state-machine.sh"
  source "${LIB_DIR}/workflow-state-machine.sh"
  echo "DEBUG: Sourced workflow-state-machine.sh successfully"

  # Repeat for each library
  ```

- [ ] **Add Function Call Tracing**: Log all major function invocations
  ```bash
  # Before initialize_workflow_paths:
  echo "DEBUG: Calling initialize_workflow_paths"
  echo "DEBUG: Args: WORKFLOW_DESCRIPTION='$WORKFLOW_DESCRIPTION', WORKFLOW_SCOPE='$WORKFLOW_SCOPE'"

  if ! initialize_workflow_paths "$WORKFLOW_DESCRIPTION" "$WORKFLOW_SCOPE"; then
    echo "DEBUG: initialize_workflow_paths FAILED with exit code $?"
    exit 1
  fi

  echo "DEBUG: initialize_workflow_paths succeeded"
  echo "DEBUG: TOPIC_PATH='${TOPIC_PATH:-NOT_SET}'"
  ```

- [ ] **Create Minimal Reproduction Test**: Isolate the issue
  ```bash
  # Use existing scripts directory: .claude/scripts/
  cat > .claude/scripts/diagnose-coordinate-bash-issue.sh << 'TESTSCRIPT'
  #!/usr/bin/env bash
  # Diagnostic tool for coordinate bash execution issues
  set -euo pipefail
  set -x

  # Simulate coordinate.md first bash block
  CLAUDE_PROJECT_DIR="/home/benjamin/.config"
  export CLAUDE_PROJECT_DIR

  WORKFLOW_DESCRIPTION="test workflow"
  export WORKFLOW_DESCRIPTION

  # Source libraries in same order as coordinate.md
  LIB_DIR="${CLAUDE_PROJECT_DIR}/.claude/lib"

  echo "Sourcing workflow-state-machine.sh..."
  source "${LIB_DIR}/workflow-state-machine.sh"

  echo "Sourcing state-persistence.sh..."
  source "${LIB_DIR}/state-persistence.sh"

  # Continue with initialization steps...
  echo "Test completed successfully"
  TESTSCRIPT

  chmod +x .claude/scripts/diagnose-coordinate-bash-issue.sh
  bash .claude/scripts/diagnose-coordinate-bash-issue.sh
  ```

- [ ] **Check for Hidden Characters**: Scan for non-printable characters
  ```bash
  # Check coordinate.md for hidden characters around error lines
  sed -n '245,265p' .claude/commands/coordinate.md | od -c

  # Check library files
  sed -n '245,265p' .claude/lib/workflow-initialization.sh | od -c
  ```

- [ ] **Capture Complete Error Context**: Get full error output
  ```bash
  # Run coordinate with full error capture
  # Store in specs directory per existing standards
  mkdir -p .claude/specs/620_fix_coordinate_bash_history_expansion_errors/diagnostics

  /coordinate "test" 2>&1 | tee .claude/specs/620_fix_coordinate_bash_history_expansion_errors/diagnostics/full_error_$(date +%Y%m%d_%H%M%S).log

  # Analyze the log
  grep -n "!:" .claude/specs/620_fix_coordinate_bash_history_expansion_errors/diagnostics/full_error_*.log
  grep -B5 -A5 "command not found" .claude/specs/620_fix_coordinate_bash_history_expansion_errors/diagnostics/full_error_*.log
  ```

**Expected Outputs:**
- Detailed execution trace showing exact failure point
- Identification of which library/function causes the error
- Understanding of line number discrepancy
- Minimal reproduction case in `.claude/scripts/` per existing infrastructure

**Files Modified:**
- `.claude/commands/coordinate.md` (temporary diagnostic additions)
- Create: `.claude/scripts/diagnose-coordinate-bash-issue.sh`
- Create: `.claude/specs/620_fix_coordinate_bash_history_expansion_errors/diagnostics/`

**Expected Duration**: 90-120 minutes

---

### Phase 2: Implement Targeted Fix Based on Diagnostics
**Objective**: Apply specific fix based on Phase 1 findings
**Complexity**: Medium (depends on root cause)
**Priority**: CRITICAL

**Conditional Fixes** (apply based on Phase 1 results):

#### Fix Option A: Library Sourcing Order Issue
**If diagnostics show**: Error occurs during specific library sourcing

```bash
# Reorder library sourcing
# Try loading workflow-initialization.sh earlier
source "${LIB_DIR}/workflow-initialization.sh"
source "${LIB_DIR}/workflow-state-machine.sh"
source "${LIB_DIR}/state-persistence.sh"
```

#### Fix Option B: Variable Expansion Context Issue
**If diagnostics show**: Error occurs during variable expansion

```bash
# Add explicit context control
(
  # Run initialization in subshell with controlled environment
  set +H 2>/dev/null || true  # Disable history if enabled
  shopt -u histexpand 2>/dev/null || true  # Alternative disable method

  initialize_workflow_paths "$WORKFLOW_DESCRIPTION" "$WORKFLOW_SCOPE"

  # Export results back to parent
  echo "TOPIC_PATH=$TOPIC_PATH"
) | while IFS='=' read -r var val; do
  export "$var=$val"
done
```

#### Fix Option C: Bash Block Separation Issue
**If diagnostics show**: Problem with how bash blocks are executed

```bash
# Add explicit state preservation between blocks
# At end of first bash block:
declare -p > /tmp/coordinate_state_block1.sh

# At start of second bash block:
source /tmp/coordinate_state_block1.sh
```

#### Fix Option D: Character Encoding Issue
**If diagnostics show**: Hidden characters causing problems

```bash
# Re-save coordinate.md with clean encoding
iconv -f UTF-8 -t UTF-8 -c .claude/commands/coordinate.md > /tmp/coordinate_clean.md
mv /tmp/coordinate_clean.md .claude/commands/coordinate.md
```

#### Fix Option E: Function Definition Issue
**If diagnostics show**: Problem with how functions are exported

```bash
# Explicitly re-export functions after sourcing
export -f initialize_workflow_paths
export -f reconstruct_report_paths_array
export -f display_brief_summary
export -f handle_state_error
```

**Tasks:**
- [ ] Analyze Phase 1 diagnostic output
- [ ] Select appropriate fix option(s)
- [ ] Implement chosen fix
- [ ] Test with minimal reproduction case (`.claude/scripts/diagnose-coordinate-bash-issue.sh`)
- [ ] Test with full /coordinate workflow
- [ ] Document why this fix addresses the root cause

**Files Modified:**
- `.claude/commands/coordinate.md` (apply fix)
- Possibly `.claude/lib/*.sh` (if library changes needed)

**Expected Duration**: 45-60 minutes

---

### Phase 3: Comprehensive Testing & Validation
**Objective**: Verify fix works across all scenarios
**Complexity**: Medium
**Priority**: HIGH

**Tasks:**

- [ ] **Test Minimal Cases**:
  ```bash
  # Test 1: Simple research workflow
  /coordinate "Research bash execution issues"
  # Expected: No errors, TOPIC_PATH set

  # Test 2: Research and plan workflow
  /coordinate "Research and plan a simple feature"
  # Expected: Research completes, plan created
  ```

- [ ] **Test Complex Cases**:
  ```bash
  # Test 3: Full workflow with multiple reports
  /coordinate "Research, plan, and implement authentication system"
  # Expected: All phases complete successfully

  # Test 4: Workflow with special characters in description
  /coordinate "Fix bug: handle !important CSS rules correctly"
  # Expected: Handles ! in description without errors
  ```

- [ ] **Test Error Conditions**:
  ```bash
  # Test 5: Invalid workflow description
  /coordinate ""
  # Expected: Graceful error message

  # Test 6: Missing dependencies
  # Temporarily rename a library file
  mv .claude/lib/workflow-initialization.sh .claude/lib/workflow-initialization.sh.bak
  /coordinate "test"
  # Expected: Clear error about missing library (per orchestration-troubleshooting.md Section 1)
  mv .claude/lib/workflow-initialization.sh.bak .claude/lib/workflow-initialization.sh
  ```

- [ ] **Regression Testing**:
  ```bash
  # Run existing test suite per CLAUDE.md testing protocols
  bash .claude/tests/test_coordinate_*.sh 2>/dev/null || echo "No coordinate tests found"

  # Verify no new failures
  ```

- [ ] **Performance Validation**:
  ```bash
  # Test 7: Measure execution time
  time /coordinate "Quick research task"
  # Compare with existing performance baselines
  ```

**Expected Outcomes:**
- All test cases pass
- No regressions in existing functionality
- Clear error messages for edge cases (consistent with orchestration-troubleshooting.md)
- Consistent performance

**Files Modified:** None (testing only)

**Expected Duration**: 60-90 minutes

---

### Phase 4: Documentation Integration & Prevention
**Objective**: Integrate findings into existing troubleshooting infrastructure
**Complexity**: Low
**Priority**: MEDIUM

**Documentation Strategy**: Integrate with existing `.claude/docs/` structure rather than creating redundant guides

**Tasks:**

- [ ] **Update Orchestration Troubleshooting Guide**: Add this case to existing infrastructure
  - Location: `.claude/docs/guides/orchestration-troubleshooting.md`
  - Add new section (Section 6): "Bash Execution Context Issues"
  - Follow existing format (Symptom → Root Cause → Diagnostic → Solution → Prevention)
  - Cross-reference from existing Section 1 (Bootstrap Failures)
  - Content:
    ```markdown
    ## Section 6: Bash Execution Context Issues

    ### Symptom: "!: command not found" in Coordinate Execution

    **Error Pattern**:
    ```
    /run/current-system/sw/bin/bash: line NNN: !: command not found
    ERROR: TOPIC_PATH not set after workflow initialization
    ```

    **Root Cause**: [Document findings from Phase 1]

    **Diagnostic Commands**:
    ```bash
    # Run diagnostic script
    bash .claude/scripts/diagnose-coordinate-bash-issue.sh

    # Check for hidden characters
    sed -n 'NNN,MMM p' .claude/commands/coordinate.md | od -c
    ```

    **Solution**: [Document fix from Phase 2]

    **Prevention**: [Reference command development best practices]
    ```

- [ ] **Create Root Cause Analysis Report**: Document for future reference
  - Location: `.claude/specs/620_fix_coordinate_bash_history_expansion_errors/reports/001_root_cause_analysis.md`
  - Follow existing report structure per directory-protocols.md
  - Content:
    - Initial hypothesis vs actual cause
    - Why standard fixes didn't work
    - Mechanism of failure (technical details)
    - How fix addresses root cause
    - Lessons learned
  - **Note**: This is a debug report, should be committed per directory protocols

- [ ] **Update Command Development Guide**: Add bash execution best practices
  - Location: `.claude/docs/guides/command-development-guide.md`
  - Add to existing "Best Practices" section (don't create redundant section)
  - Content:
    ```markdown
    ### Bash Block Execution Considerations

    When creating bash blocks in command files:

    - Add debug logging for complex initialization
    - Test bash blocks in isolation before integration
    - Verify library sourcing order
    - Check for character encoding issues
    - Reference troubleshooting guide for common issues

    See: `.claude/docs/guides/orchestration-troubleshooting.md` Section 6
    ```

- [ ] **Update Coordinate Command Guide**: Add execution context notes
  - Location: `.claude/docs/guides/coordinate-command-guide.md`
  - Add note to troubleshooting section (if exists) or architecture section
  - Cross-reference orchestration-troubleshooting.md Section 6

- [ ] **Maintain Diagnostic Script**: Keep script in scripts directory
  - Location: `.claude/scripts/diagnose-coordinate-bash-issue.sh`
  - Add header documentation
  - Make it a general-purpose diagnostic tool
  - Reference from orchestration-troubleshooting.md

**Integration Points:**
- `.claude/docs/guides/orchestration-troubleshooting.md` (primary documentation)
- `.claude/docs/guides/command-development-guide.md` (prevention)
- `.claude/docs/guides/coordinate-command-guide.md` (coordinate-specific reference)
- `.claude/scripts/diagnose-coordinate-bash-issue.sh` (diagnostic tool)
- Spec 620 reports directory (detailed analysis per directory protocols)

**Files Created/Modified:**
- `.claude/docs/guides/orchestration-troubleshooting.md` (update - add Section 6)
- `.claude/specs/620_fix_coordinate_bash_history_expansion_errors/reports/001_root_cause_analysis.md` (create)
- `.claude/docs/guides/command-development-guide.md` (update - add bash execution notes)
- `.claude/docs/guides/coordinate-command-guide.md` (update - add cross-reference)
- `.claude/scripts/diagnose-coordinate-bash-issue.sh` (already created in Phase 1, document here)

**Expected Duration**: 45-60 minutes

---

## Testing Strategy

### Diagnostic Testing (Phase 1)
- Capture complete execution traces
- Test in isolation vs integrated contexts
- Compare working vs failing scenarios
- Document all findings in diagnostics directory

### Fix Validation (Phase 2)
- Test chosen fix with minimal case (diagnostic script)
- Gradually increase complexity
- Verify no side effects
- Confirm error is resolved

### Comprehensive Testing (Phase 3)
- Integration tests (full workflows)
- Regression tests (existing functionality per test suite)
- Edge case testing
- Performance validation

## Risk Assessment

### Low Risk
- Diagnostic additions are temporary and can be removed
- Testing is non-destructive
- Changes are localized to coordinate.md

### Medium Risk
- Fix may require library modifications
- Potential for introducing new issues
- May affect other orchestration commands (orchestrate, supervise)

### Mitigation Strategies
- Keep all diagnostic output in specs/620_*/diagnostics/
- Make atomic commits for easy rollback
- Test each change incrementally
- Document all changes per existing standards
- Follow orchestration-troubleshooting.md patterns

### Rollback Plan
```bash
# If fix causes issues:
git log --oneline --grep="620" | head -5
git revert <commit-hash>

# Or restore from backup:
ls .claude/specs/620_fix_coordinate_bash_history_expansion_errors/plans/*.backup-*
cp [backup-file] .claude/commands/coordinate.md
```

## Dependencies

### Prerequisites
- Spec 617 completed (verified working in isolation)
- Access to test /coordinate command
- Ability to add temporary diagnostic code
- Bash 4.3+ for testing

### Integration with Existing Infrastructure
- Uses existing `.claude/scripts/` directory for diagnostic tools
- Follows `.claude/docs/guides/orchestration-troubleshooting.md` structure
- Follows `.claude/docs/concepts/directory-protocols.md` for artifact organization
- Integrates with `.claude/docs/guides/command-development-guide.md` patterns

### No Breaking Changes Expected
- Fixes should be additive or corrective
- No API changes required
- Library interfaces remain stable

## Expected Outcomes

### Phase 1 Outcomes
- Clear understanding of failure mechanism
- Identification of exact error source
- Minimal reproduction case in `.claude/scripts/`
- Diagnostic output in spec directory

### Phase 2 Outcomes
- Targeted fix that addresses root cause
- Verification using existing diagnostic script
- No introduction of new problems

### Phase 3 Outcomes
- Comprehensive test coverage
- Confidence in fix robustness
- Performance validation against existing metrics

### Phase 4 Outcomes
- Integration with existing troubleshooting infrastructure
- Root cause analysis report per directory protocols
- Prevention guidelines in command development guide
- Reusable diagnostic tool in scripts directory

## Notes for Implementation

### Why This Approach is Different

**Previous Attempt** (didn't work):
- Applied `set +H` based on history expansion hypothesis
- Standard fix for standard problem

**This Approach** (diagnostic-first with infrastructure integration):
- Acknowledges this is NOT a standard issue
- Requires understanding before fixing
- Systematic, evidence-based approach
- Integrates with existing troubleshooting infrastructure
- Avoids redundant documentation
- Multiple fix options based on findings

### Key Insights from Research

1. **History expansion is already OFF** - This is not the issue
2. **Libraries work in isolation** - Problem is integration/context
3. **Line numbers are mysterious** - Suggests execution context issue
4. **Standard fixes failed** - Confirms this needs deeper investigation
5. **Existing infrastructure available** - Use `.claude/docs/guides/orchestration-troubleshooting.md` structure

### Implementation Philosophy

**Measure twice, cut once:**
- Phase 1 is diagnostic heavy (intentionally)
- Don't guess at fixes
- Let evidence guide the solution
- Use existing diagnostic patterns

**Integrate, don't duplicate:**
- Leverage existing `.claude/docs/guides/orchestration-troubleshooting.md`
- Add to existing sections rather than creating new files
- Follow established documentation patterns
- Use existing directory structure (scripts/, docs/, specs/)

## Success Metrics

- [ ] `/coordinate` executes without "!: command not found" errors
- [ ] TOPIC_PATH initialized successfully
- [ ] All workflow types functional (research-only, research-and-plan, full)
- [ ] No regressions in existing functionality
- [ ] Root cause documented in existing troubleshooting guide
- [ ] Diagnostic tool available in `.claude/scripts/`
- [ ] Prevention guidelines integrated with command development guide

---

## Revision History

### 2025-11-09 - Revision 1
**Changes**: Integrated with existing .claude/docs/ infrastructure
**Reason**: Avoid redundancy and ensure consistency with established patterns
**Modified Sections**:
- Phase 4: Changed from creating new standalone guides to integrating with existing documentation
- Documentation locations updated to use existing files
- Added cross-references to orchestration-troubleshooting.md
- Aligned diagnostic script location with existing .claude/scripts/ directory
- Added integration points with directory-protocols.md for artifact organization

**Key Integration Points**:
- Primary documentation: `.claude/docs/guides/orchestration-troubleshooting.md` (add Section 6)
- Prevention: `.claude/docs/guides/command-development-guide.md` (add notes to existing section)
- Reference: `.claude/docs/guides/coordinate-command-guide.md` (add cross-reference)
- Diagnostic tool: `.claude/scripts/` (existing infrastructure)
- Reports: Follow directory-protocols.md structure

---

## Summary

This plan takes a **diagnostic-first approach integrated with existing infrastructure** to resolve the mysterious bash execution failures in coordinate.md. Rather than applying standard fixes that have already failed or creating redundant documentation, we systematically:

1. **Diagnose** with extensive logging and testing using existing diagnostic patterns
2. **Fix** based on evidence from diagnostics, with multiple options prepared
3. **Validate** comprehensively across all use cases
4. **Document** by integrating with existing troubleshooting infrastructure

**Estimated Total Time**: 3.5-5 hours across 4 phases
**Risk Level**: Low-Medium (diagnostic approach minimizes risk)
**Impact**: Unblocks /coordinate and integrates findings into existing troubleshooting methodology

**Critical Success Factor**: Phase 1 must reveal the true root cause before proceeding to Phase 2. Documentation integrates with existing `.claude/docs/guides/orchestration-troubleshooting.md` rather than creating redundant files.
