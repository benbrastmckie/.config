# Plan Command Format Fix Implementation Plan

## Metadata
- **Date**: 2025-12-03
- **Feature**: Fix /plan command to produce correctly formatted plans
- **Status**: [COMPLETE]
- **Estimated Hours**: 2-3 hours
- **Standards File**: /home/benjamin/.config/CLAUDE.md
- **Research Reports**: none
- **Scope**: Update plan.md Task invocation to explicitly enforce critical format constraints (Status: [NOT STARTED], phase markers: [NOT STARTED], unchecked checkboxes)
- **Complexity Score**: 15.0
- **Structure Level**: 0

## Overview

The /plan command is producing plans with incorrect format violations:
- Metadata Status set to `[IN PROGRESS]` instead of required `[NOT STARTED]`
- Phase headers showing `[COMPLETE]` or `[PARTIAL]` instead of `[NOT STARTED]`
- Success Criteria and tasks pre-marked with `[x]` or `[~]` (completed/superseded)
- Extra non-standard metadata fields appearing in output

**Root Cause**: The plan-architect Task invocation in plan.md (lines 1201-1231) doesn't explicitly reinforce the critical format constraints that distinguish "research findings" (what exists) from "plan status" (what needs to be done). The agent conflates these concepts when it finds partial implementations during research.

**Solution**: Enhance the Task invocation prompt with explicit format enforcement instructions that prevent the agent from pre-populating completion status based on research findings.

## Success Criteria

- [ ] All new plans generated by /plan have Status: [NOT STARTED] in metadata
- [ ] All phase headings include [NOT STARTED] marker in new plans
- [ ] All Success Criteria use unchecked `- [ ]` format in new plans
- [ ] All task checkboxes use unchecked `- [ ]` format in new plans
- [ ] No extra non-standard metadata fields appear in output
- [ ] Existing plan-architect behavioral guidelines remain unchanged
- [ ] Plan metadata validation passes for newly generated plans

## Technical Design

### Architecture Overview

The fix operates at the **orchestration layer** (plan.md) rather than the **agent layer** (plan-architect.md) because:

1. **Separation of Concerns**: The agent behavioral file defines general planning capabilities; the command defines workflow-specific constraints
2. **Minimal Disruption**: Changing the Task invocation prompt is less risky than modifying the 1282-line agent behavioral file
3. **Context Locality**: The format requirements are specific to NEW plan creation, not plan revision (which has different rules)

### Task Invocation Enhancement

**Current Structure** (lines 1203-1231):
```markdown
Task {
  subagent_type: "general-purpose"
  description: "Create implementation plan for ${FEATURE_DESCRIPTION} with mandatory file creation"
  prompt: "
    Read and follow ALL behavioral guidelines from:
    ${CLAUDE_PROJECT_DIR}/.claude/agents/plan-architect.md

    You are creating an implementation plan for: plan workflow

    **Workflow-Specific Context**:
    - Feature Description: ${FEATURE_DESCRIPTION}
    - Output Path: ${PLAN_PATH}
    - Research Reports: ${REPORT_PATHS_LIST}
    - Workflow Type: research-and-plan
    - Operation Mode: new plan creation
    ...

    Execute planning according to behavioral guidelines and return completion signal:
    PLAN_CREATED: ${PLAN_PATH}
  "
}
```

**Enhanced Structure** (proposed):
```markdown
Task {
  subagent_type: "general-purpose"
  description: "Create implementation plan for ${FEATURE_DESCRIPTION} with mandatory file creation"
  prompt: "
    Read and follow ALL behavioral guidelines from:
    ${CLAUDE_PROJECT_DIR}/.claude/agents/plan-architect.md

    You are creating an implementation plan for: plan workflow

    **Workflow-Specific Context**:
    - Feature Description: ${FEATURE_DESCRIPTION}
    - Output Path: ${PLAN_PATH}
    - Research Reports: ${REPORT_PATHS_LIST}
    - Workflow Type: research-and-plan
    - Operation Mode: new plan creation
    ...

    **CRITICAL FORMAT REQUIREMENTS FOR NEW PLANS**:
    This is a NEW plan creation (not revision). You MUST follow these format rules:

    1. Metadata Status Field:
       - MUST be exactly: **Status**: [NOT STARTED]
       - Do NOT use [IN PROGRESS], [COMPLETE], or [BLOCKED]

    2. Phase Heading Format:
       - ALL phases MUST include [NOT STARTED] marker
       - Format: ### Phase N: Name [NOT STARTED]
       - Do NOT use [COMPLETE], [PARTIAL], or [IN PROGRESS]

    3. Checkbox Format:
       - ALL Success Criteria MUST use: - [ ] (unchecked)
       - ALL tasks MUST use: - [ ] (unchecked)
       - Do NOT pre-mark checkboxes as [x] or [~]

    4. Status vs Findings Distinction:
       - Research findings describe WHAT EXISTS in the codebase
       - Plan status describes WHAT NEEDS TO BE DONE
       - Even if research shows partial implementation, the plan status is [NOT STARTED]
       - The plan tracks future work, not past accomplishments

    5. Metadata Field Restriction:
       - Only use standard metadata fields from plan-architect.md template
       - Do NOT add workflow-specific fields (e.g., **Lean File**)
       - Required fields: Date, Feature, Status, Estimated Hours, Standards File, Research Reports

    **WHY THIS MATTERS**:
    - /implement depends on [NOT STARTED] markers to track progress
    - Pre-completed checkboxes break automated task tracking
    - Invalid status markers confuse progress detection
    - This is a plan for FUTURE work, not a report of PAST work

    Execute planning according to behavioral guidelines and return completion signal:
    PLAN_CREATED: ${PLAN_PATH}
  "
}
```

### Key Changes

1. **Explicit Format Section**: Add "CRITICAL FORMAT REQUIREMENTS FOR NEW PLANS" section with 5 numbered rules
2. **Status vs Findings Distinction**: Clarify that research findings (what exists) are different from plan status (what needs to be done)
3. **Rationale Explanation**: Explain WHY these rules matter (automated tracking, progress detection)
4. **Concrete Examples**: Show exact format strings to prevent ambiguity

### Why This Works

- **Explicit Constraints**: The agent receives unambiguous format requirements before it starts planning
- **Context Separation**: Distinguishes "research mode" (observing what exists) from "planning mode" (defining what's needed)
- **Rationale Clarity**: Explains the automation dependency so the agent understands the consequences of violations
- **Non-Intrusive**: Doesn't modify agent behavioral file, only adds orchestration-layer constraints

## Implementation Phases

### Phase 1: Update Task Invocation Prompt [COMPLETE]
dependencies: []

**Objective**: Add explicit format enforcement to plan-architect Task invocation in plan.md

**Complexity**: Low

**Tasks**:
- [x] Read current Task invocation (lines 1201-1231 in plan.md)
- [x] Add "CRITICAL FORMAT REQUIREMENTS FOR NEW PLANS" section to prompt
- [x] Include 5 numbered format rules (Status, Phase markers, Checkboxes, Distinction, Metadata)
- [x] Add "WHY THIS MATTERS" rationale section
- [x] Preserve existing prompt structure and variable references
- [x] Verify prompt formatting (indentation, quote escaping)

**Testing**:
```bash
# Verify syntax (no bash parsing errors)
bash -n /home/benjamin/.config/.claude/commands/plan.md

# Test with simple feature
cd /home/benjamin/.config
/plan "test feature for format validation"

# Verify output format
PLAN_FILE=$(find .claude/specs -name "*-plan.md" -type f | head -1)
grep -q "Status\]: \[NOT STARTED\]" "$PLAN_FILE" || echo "FAIL: Status not [NOT STARTED]"
grep -c "### Phase [0-9].*\[NOT STARTED\]" "$PLAN_FILE" || echo "FAIL: Phase markers missing"
grep -c "^- \[ \]" "$PLAN_FILE" || echo "PASS: Unchecked checkboxes found"
```

**Expected Duration**: 1 hour

### Phase 2: Validation and Testing [COMPLETE]
dependencies: [1]

**Objective**: Verify the fix resolves the format violations across different scenarios

**Complexity**: Medium

**Tasks**:
- [x] Test with simple feature description (single-phase plan)
- [x] Test with complex feature description (multi-phase plan)
- [x] Test with research reports containing partial implementation findings
- [x] Verify all generated plans pass validate-plan-metadata.sh
- [x] Check for regression: no unintended changes to other plan formats
- [x] Verify plan-architect behavioral file unchanged

**Testing**:
```bash
# Test 1: Simple feature
/plan "add logging utility function"
PLAN=$(find .claude/specs -name "*-plan.md" -mmin -5 | head -1)
bash .claude/scripts/lint/validate-plan-metadata.sh "$PLAN"

# Test 2: Complex feature with partial implementation
/plan "extend JWT authentication with refresh token support"
PLAN=$(find .claude/specs -name "*-plan.md" -mmin -5 | head -1)
bash .claude/scripts/lint/validate-plan-metadata.sh "$PLAN"
grep -q "Status\]: \[NOT STARTED\]" "$PLAN" || echo "FAIL: Status incorrect"
PHASE_COUNT=$(grep -c "^### Phase" "$PLAN")
NOT_STARTED_COUNT=$(grep -c "\[NOT STARTED\]" "$PLAN")
[ "$PHASE_COUNT" -eq "$NOT_STARTED_COUNT" ] || echo "FAIL: Not all phases marked [NOT STARTED]"

# Test 3: Verify no regressions in /revise workflow
# (Revisions should still preserve [COMPLETE] phases)
```

**Expected Duration**: 1.5 hours

### Phase 3: Documentation Update [COMPLETE]
dependencies: [2]

**Objective**: Document the fix and update relevant guides

**Complexity**: Low

**Tasks**:
- [x] Update plan-command-guide.md with format enforcement explanation
- [x] Add troubleshooting entry for format violations
- [x] Document the "Status vs Findings" distinction concept
- [x] Update command development standards if needed

**Testing**:
```bash
# Verify documentation links valid
bash .claude/scripts/validate-links-quick.sh .claude/docs/guides/commands/plan-command-guide.md

# Verify no broken cross-references
bash .claude/scripts/validate-readmes.sh .claude/docs/guides/commands/
```

**Expected Duration**: 0.5 hours

## Testing Strategy

### Format Validation Tests

1. **Metadata Status Check**: Verify Status field is exactly `[NOT STARTED]`
2. **Phase Marker Check**: Count phase headers and [NOT STARTED] markers (must equal)
3. **Checkbox Check**: Verify all checkboxes are `- [ ]` (not `- [x]` or `- [~]`)
4. **Metadata Field Check**: Verify no non-standard fields present

### Regression Tests

1. **Plan Revision**: Verify /revise workflow still preserves [COMPLETE] phases
2. **Other Commands**: Verify /implement, /debug workflows unaffected
3. **Agent Behavioral File**: Verify plan-architect.md unchanged (git diff)

### Integration Tests

1. **End-to-End**: Run full /plan workflow and validate output with validate-plan-metadata.sh
2. **Cross-Workflow**: Verify /implement can parse generated plans correctly
3. **Error Handling**: Verify agent errors still logged correctly

## Documentation Requirements

### Files to Update

1. **plan-command-guide.md**: Add section on format enforcement
   - Location: `.claude/docs/guides/commands/plan-command-guide.md`
   - Content: Explain the Task invocation enhancement and format requirements

2. **Troubleshooting**: Add format violation troubleshooting
   - Location: `.claude/docs/troubleshooting/plan-format-issues.md` (new file)
   - Content: Common format violations and how to diagnose them

### Documentation Standards

- Follow output formatting standards (WHAT not WHY in comments)
- Use concrete examples with actual file paths
- Include validation commands for self-verification
- Cross-reference plan metadata standard

## Dependencies

### Internal Dependencies

- plan-architect.md: Behavioral file must remain unchanged
- validate-plan-metadata.sh: Validation script for format checking
- workflow-state-machine.sh: State transitions unaffected
- /implement command: Must successfully parse enhanced plan format

### External Dependencies

None

### Prerequisite Knowledge

- Understanding of Task tool invocation pattern
- Familiarity with plan metadata standard
- Knowledge of plan-architect completion criteria (44 criteria)

## Risk Assessment

### Low Risk

- **Scope**: Changes are confined to single Task invocation prompt
- **Reversibility**: Easy to revert by removing added section
- **Testing**: Can validate with synthetic test plans before production use

### Potential Issues

1. **Prompt Length**: Adding format section increases prompt tokens by ~200
   - Mitigation: Still well below model context limits

2. **Agent Compliance**: Agent might ignore new instructions if behavioral file takes precedence
   - Mitigation: Use "CRITICAL" and "MUST" language to establish priority

3. **Interaction with Standards Divergence**: Phase 0 detection might be affected
   - Mitigation: Format rules explicitly state they apply to phases 1+, not Phase 0

## Rollback Plan

If format violations persist after implementation:

1. **Immediate Rollback**: Remove "CRITICAL FORMAT REQUIREMENTS" section from Task invocation
2. **Root Cause Analysis**: Review plan-architect agent output to identify why instructions were ignored
3. **Alternative Approach**: Consider post-creation validation/correction in Block 3 (fallback option)

## Alternative Approaches Considered

### Option A: Modify plan-architect.md (Rejected)

**Pros**: Single source of truth for format rules
**Cons**: High risk (1282-line file), affects all invocations (including revisions), harder to test

### Option B: Post-Creation Format Correction (Rejected)

**Pros**: Guaranteed correct output
**Cons**: Doesn't address root cause, adds complexity, harder to maintain

### Option C: Enhanced Task Invocation (Selected)

**Pros**: Low risk, context-specific, easy to test and revert
**Cons**: Relies on agent compliance with prompt instructions

## Success Metrics

1. **Format Compliance**: 100% of new plans pass validate-plan-metadata.sh
2. **Status Accuracy**: 0 plans with Status != [NOT STARTED]
3. **Phase Markers**: All phases in new plans have [NOT STARTED] marker
4. **Checkbox Format**: All checkboxes in new plans are unchecked `- [ ]`
5. **No Regressions**: /revise workflow still preserves [COMPLETE] phases

## Implementation Notes

- Test with multiple feature descriptions (simple, complex, partial implementation)
- Monitor plan-architect agent output for compliance with new instructions
- Verify /implement can still parse enhanced plans correctly
- Document the "Status vs Findings" distinction for future reference
