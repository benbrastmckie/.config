# Error Repair Implementation Plan

## Metadata
- **Date**: 2025-11-30
- **Feature**: Error Log Analysis and Repair
- **Scope**: Fix 140 logged errors across 7 error patterns affecting 10 commands
- **Estimated Phases**: 7
- **Estimated Hours**: 24
- **Standards File**: /home/benjamin/.config/CLAUDE.md
- **Status**: [IN PROGRESS]
- **Research Reports**:
  - [Error Analysis Report](../reports/001_error_analysis.md)
- **Structure Level**: 0
- **Complexity Score**: 156.0

## Overview

This plan addresses 140 logged errors identified through error log analysis spanning 2025-11-21 to 2025-11-30. The errors are concentrated in 7 patterns affecting 10 commands, with execution errors (51%), state management issues (20%), and agent failures (15%) representing the majority. The repair focuses on systemic fixes that will resolve multiple error instances through architectural improvements rather than individual error patching.

Key repair objectives:
1. Fix library sourcing issues causing exit code 127 errors (31 errors, 22%)
2. Refactor state machine initialization pattern (37 errors, 26%)
3. Implement agent timeout and retry strategy (18 errors, 13%)
4. Add comprehensive input validation (13 errors, 9%)
5. Increase test agent timeouts (7 errors, 5%)

## Research Summary

The error analysis report reveals that exit code 127 ("command not found") errors represent the most frequent execution failure pattern, indicating missing function definitions or incomplete library sourcing. State machine transition errors and STATE_FILE initialization issues constitute 26% of all errors, pointing to systemic initialization order problems. Agent failures are split between production (topic naming, 11 errors) and test scenarios (agent tests, 7 errors), with different root causes requiring distinct fixes.

Root cause analysis identified four systemic issues:
1. **Library Sourcing**: Functions like `save_completed_states_to_state`, `append_workflow_state`, and `initialize_workflow_paths` not available in execution context
2. **State Machine Initialization**: Commands attempting transitions before STATE_FILE is set, and invalid transition paths
3. **Agent Reliability**: Topic naming agent not producing output files, test agents failing 1-second timeout
4. **Input Validation**: User-provided paths and configuration arrays not validated before use

The recommended fix strategy prioritizes high-impact, systemic fixes (library sourcing and state machine refactoring) over low-effort individual fixes (test timeouts and validation).

## Success Criteria

- [ ] Exit code 127 errors reduced to zero (31 errors resolved)
- [ ] State machine transition errors reduced to zero (37 errors resolved)
- [ ] Agent timeout errors reduced by 90% (16+ of 18 errors resolved)
- [ ] Input validation errors reduced to zero (13 errors resolved)
- [ ] Test agent timeout errors reduced to zero (7 errors resolved)
- [ ] All error log entries marked RESOLVED (106 total errors targeted)
- [ ] Pre-commit validation prevents library sourcing regressions
- [ ] State machine initialization documented with valid transition paths
- [ ] Agent timeout configuration exposed for tuning
- [ ] Error monitoring dashboard operational

## Technical Design

### Architecture Changes

**1. Library Sourcing Validation Layer**
- Create `lib/core/sourcing-validation.sh` library with function availability checks
- Add sourcing validation script for pre-commit hooks
- Document library dependency manifest in `.claude/docs/reference/standards/library-dependencies.md`

**2. State Machine Initialization Wrapper**
- Create `initialize_workflow_state_machine` function in `lib/core/workflow-state-machine.sh`
- Enforce proper setup order (load_workflow_state → STATE_FILE validation → sm_transition)
- Add state transition validation with clear error messages

**3. Agent Timeout Configuration**
- Add `AGENT_TIMEOUT` and `AGENT_TEST_TIMEOUT` environment variables
- Implement retry logic with exponential backoff in agent invocation utilities
- Create agent health check function

**4. Input Validation Library**
- Create `lib/utils/input-validation.sh` with validation functions for paths, arrays, configuration
- Add validation examples to command documentation

### Component Interactions

```
Command Entry Point
  ↓
Input Validation Layer (new)
  ↓
State Machine Initialization Wrapper (new)
  ↓
Library Sourcing Validation (new)
  ↓
Existing Command Logic
  ↓
Agent Invocation with Timeout/Retry (enhanced)
  ↓
Error Logging (existing)
```

### File Modifications

Commands requiring library sourcing fixes:
- `.claude/commands/build.md` (6 errors)
- `.claude/commands/plan.md` (8 errors)
- `.claude/commands/debug.md` (4 errors)
- `.claude/commands/research.md` (2 errors)
- `.claude/commands/revise.md` (2 errors)
- `.claude/commands/errors.md` (1 error)

Commands requiring state machine initialization fixes:
- `.claude/commands/repair.md` (9 errors)
- `.claude/commands/revise.md` (4 errors)
- `.claude/commands/build.md` (3 errors)
- `.claude/commands/research.md` (2 errors)
- `.claude/commands/plan.md` (1 error)

New libraries to create:
- `.claude/lib/core/sourcing-validation.sh`
- `.claude/lib/utils/input-validation.sh`

Libraries to enhance:
- `.claude/lib/core/workflow-state-machine.sh`
- `.claude/lib/utils/agent-utils.sh` (if exists, or create)

## Implementation Phases

### Phase 1: Library Sourcing Audit and Fix [IN PROGRESS]
dependencies: []

**Objective**: Resolve exit code 127 errors by ensuring all required libraries are sourced before function calls

**Complexity**: High

Tasks:
- [ ] Audit all commands for library sourcing patterns (file: `.claude/commands/*.md`)
- [ ] Create library dependency manifest documenting function-to-library mappings (file: `.claude/docs/reference/standards/library-dependencies.md`)
- [ ] Create sourcing validation script for pre-commit hooks (file: `.claude/scripts/validate-library-sourcing.sh`)
- [ ] Add defensive function availability checks to affected commands
- [ ] Update `.claude/commands/build.md` to source state management libraries before function calls (lines using `save_completed_states_to_state`, `append_workflow_state`)
- [ ] Update `.claude/commands/plan.md` to source required libraries (8 exit code 127 errors)
- [ ] Update `.claude/commands/debug.md` to source required libraries (4 exit code 127 errors)
- [ ] Update `.claude/commands/research.md` to source required libraries (2 exit code 127 errors)
- [ ] Update `.claude/commands/revise.md` to source required libraries (2 exit code 127 errors)
- [ ] Update `.claude/commands/errors.md` to source required libraries (1 exit code 127 error)
- [ ] Add library sourcing validation to pre-commit hooks (file: `.git/hooks/pre-commit`)

Testing:
```bash
# Test library sourcing validation script
bash .claude/scripts/validate-library-sourcing.sh --all

# Test affected commands with library sourcing fixes
bash .claude/commands/build.md --dry-run
bash .claude/commands/plan.md "test feature" --dry-run
bash .claude/commands/debug.md "test issue" --dry-run

# Verify no exit code 127 errors generated
/errors --type execution_error --since 1h | jq -r 'select(.context.exit_code == 127) | .error_message'
```

**Expected Duration**: 6 hours

### Phase 2: State Machine Initialization Refactor [NOT STARTED]
dependencies: [1]

**Objective**: Create standardized state machine initialization wrapper and refactor commands to use it

**Complexity**: High

Tasks:
- [ ] Create `initialize_workflow_state_machine` function in `lib/core/workflow-state-machine.sh`
- [ ] Add STATE_FILE validation before sm_transition calls
- [ ] Add state transition validation with valid path documentation
- [ ] Document state transition paths for each command workflow type (file: `.claude/docs/reference/standards/state-machine-transitions.md`)
- [ ] Add state machine diagnostics mode (--debug-state flag support)
- [ ] Refactor `/repair` command to use initialization wrapper (9 state errors)
- [ ] Refactor `/revise` command to use initialization wrapper (4 STATE_FILE errors)
- [ ] Refactor `/build` command to use initialization wrapper (3 state transition errors)
- [ ] Refactor `/research` command to use initialization wrapper (2 STATE_FILE errors)
- [ ] Refactor `/plan` command to use initialization wrapper (1 state transition error)
- [ ] Add state machine initialization tests (file: `.claude/tests/state-machine-initialization-test.sh`)

Testing:
```bash
# Test state machine initialization wrapper
source .claude/lib/core/workflow-state-machine.sh
initialize_workflow_state_machine "/tmp/test-state"
echo "STATE_FILE: $STATE_FILE"

# Test affected commands with state machine fixes
/repair --since 1h --dry-run
/revise .claude/specs/001_test/plans/001_test.md "test revision" --dry-run
/build .claude/specs/001_test/plans/001_test.md --dry-run

# Verify no state errors generated
/errors --type state_error --since 1h
```

**Expected Duration**: 8 hours

### Phase 3: Agent Timeout and Retry Strategy [NOT STARTED]
dependencies: [1]

**Objective**: Implement tiered timeout configuration and retry logic for agent invocations

**Complexity**: Medium

Tasks:
- [ ] Create or enhance `lib/utils/agent-utils.sh` with timeout configuration
- [ ] Add AGENT_TIMEOUT environment variable (default: 30s for production)
- [ ] Add AGENT_TEST_TIMEOUT environment variable (default: 3s for tests)
- [ ] Implement retry logic with exponential backoff for topic naming agent (3 attempts)
- [ ] Add agent health check function before invocation
- [ ] Improve agent artifact validation with structured output format
- [ ] Update topic naming agent invocations to use retry logic
- [ ] Update agent invocation documentation (file: `.claude/docs/guides/development/topic-naming-with-llm.md`)
- [ ] Increase test agent timeout from 1s to 3s in test harness

Testing:
```bash
# Test agent timeout configuration
export AGENT_TIMEOUT=30
export AGENT_TEST_TIMEOUT=3
bash .claude/scripts/some-agent-invoker.sh

# Test topic naming agent with retry
/research "test feature requiring topic naming" --dry-run

# Test agent test timeouts
/test-agent research-specialist --timeout 3

# Verify agent errors reduced
/errors --type agent_error --since 1h
```

**Expected Duration**: 4 hours

### Phase 4: Input Validation Layer [NOT STARTED]
dependencies: [1]

**Objective**: Add comprehensive input validation with actionable error messages

**Complexity**: Low

Tasks:
- [ ] Create `lib/utils/input-validation.sh` library
- [ ] Add `validate_path_exists` function with permission checks
- [ ] Add `validate_directory_exists` function
- [ ] Add `validate_array_not_empty` function for configuration arrays
- [ ] Add `validate_required_config` function
- [ ] Improve error messages to include expected format and remediation steps
- [ ] Update `/convert-docs` command to validate input directory before processing (5 validation errors)
- [ ] Update `/plan` command to validate research topics array (3 validation errors)
- [ ] Update `/research` command to validate configuration (2 validation errors)
- [ ] Add validation examples to command documentation

Testing:
```bash
# Test validation library functions
source .claude/lib/utils/input-validation.sh
validate_path_exists "/nonexistent/path" || echo "Expected failure"
validate_array_not_empty "$(echo '[]')" || echo "Expected failure"

# Test commands with input validation
/convert-docs /nonexistent/dir || echo "Should show clear error message"
/plan "test feature" || echo "Should validate research topics array"

# Verify validation errors reduced
/errors --type validation_error --since 1h
```

**Expected Duration**: 3 hours

### Phase 5: Test Agent Timeout Fix [NOT STARTED]
dependencies: [3]

**Objective**: Increase test agent timeout from 1s to 3s

**Complexity**: Low

Tasks:
- [ ] Update test harness to use 3-second default timeout (file: location TBD - find test harness)
- [ ] Add AGENT_TEST_TIMEOUT environment variable support to test harness
- [ ] Document timeout configuration in testing documentation (file: `.claude/docs/reference/standards/testing-protocols.md`)
- [ ] Consider async test patterns for long-running agents (research task)
- [ ] Run all agent tests to verify timeout fix

Testing:
```bash
# Test agent test timeout increase
export AGENT_TEST_TIMEOUT=3
/test-agent research-specialist
/test-agent plan-architect

# Verify no test agent timeout errors
/errors --command /test-agent --since 1h
```

**Expected Duration**: 1 hour

### Phase 6: Verification and Error Log Update [NOT STARTED]
dependencies: [1, 2, 3, 4, 5]

**Objective**: Verify all fixes are working and error counts have decreased as expected

**Complexity**: Low

Tasks:
- [ ] Run comprehensive test suite to verify no new errors introduced
- [ ] Query error log to verify error reduction matches expectations
- [ ] Generate error summary report comparing before/after error counts
- [ ] Verify exit code 127 errors reduced to zero (31 errors targeted)
- [ ] Verify state machine errors reduced to zero (37 errors targeted)
- [ ] Verify agent timeout errors reduced by 90% (16+ of 18 errors targeted)
- [ ] Verify input validation errors reduced to zero (13 errors targeted)
- [ ] Verify test agent timeout errors reduced to zero (7 errors targeted)
- [ ] Document any remaining errors and create follow-up issues if needed

Testing:
```bash
# Generate before/after error summary
/errors --summary > /tmp/errors-after-repair.txt

# Compare error counts by pattern
echo "Exit code 127 errors (before: 31):"
/errors --type execution_error | jq -r 'select(.context.exit_code == 127)' | wc -l

echo "State machine errors (before: 37):"
/errors --type state_error | wc -l

echo "Agent timeout errors (before: 18):"
/errors --type agent_error | jq -r 'select(.error_message | contains("timeout"))' | wc -l

echo "Validation errors (before: 13):"
/errors --type validation_error | wc -l

echo "Test agent timeout errors (before: 7):"
/errors --command /test-agent --type agent_error | wc -l

# Verify overall error reduction
echo "Total errors before: 140"
echo "Total errors after:"
/errors --status ERROR | wc -l
```

**Expected Duration**: 2 hours

### Phase 7: Update Error Log Status [NOT STARTED]
dependencies: [1, 2, 3, 4, 5, 6]

**Objective**: Update error log entries from FIX_PLANNED to RESOLVED

**Complexity**: Low

Tasks:
- [ ] Verify all fixes are working (tests pass, no new errors generated)
- [ ] Update error log entries to RESOLVED status:
  ```bash
  source .claude/lib/core/error-handling.sh
  RESOLVED_COUNT=$(mark_errors_resolved_for_plan "/home/benjamin/.config/.claude/specs/983_repair_20251130_100233/plans/001-repair-20251130-100233-plan.md")
  echo "Resolved $RESOLVED_COUNT error log entries"
  ```
- [ ] Verify no FIX_PLANNED errors remain for this plan:
  ```bash
  REMAINING=$(query_errors --status FIX_PLANNED | jq -r '.repair_plan_path' | grep -c "983_repair_20251130_100233" || echo "0")
  [ "$REMAINING" -eq 0 ] && echo "All errors resolved" || echo "WARNING: $REMAINING errors still FIX_PLANNED"
  ```

Testing:
```bash
# Verify error log status updates
/errors --status RESOLVED | jq -r 'select(.repair_plan_path | contains("983_repair_20251130_100233")) | .workflow_id' | wc -l

# Verify no FIX_PLANNED errors remain for this plan
/errors --status FIX_PLANNED | jq -r 'select(.repair_plan_path | contains("983_repair_20251130_100233"))'
```

**Expected Duration**: 1 hour

## Testing Strategy

### Unit Testing
- Test library sourcing validation script with various sourcing patterns
- Test state machine initialization wrapper with different initialization states
- Test agent timeout and retry logic with simulated failures
- Test input validation functions with valid and invalid inputs

### Integration Testing
- Test affected commands end-to-end with fixes applied
- Verify error log entries are no longer generated for fixed patterns
- Test pre-commit hooks with library sourcing violations
- Test state machine transitions with diagnostic mode enabled

### Regression Testing
- Run comprehensive test suite to ensure no new errors introduced
- Compare error log before/after to verify expected error reduction
- Test commands not directly modified to ensure no unintended side effects

### Test Coverage Requirements
- 100% coverage of new validation functions
- 100% coverage of state machine initialization wrapper
- Integration tests for all 8 commands with library sourcing fixes
- Integration tests for all 5 commands with state machine fixes

## Documentation Requirements

### New Documentation
- Create `.claude/docs/reference/standards/library-dependencies.md` documenting function-to-library mappings
- Create `.claude/docs/reference/standards/state-machine-transitions.md` documenting valid state transition paths
- Create agent timeout configuration section in `.claude/docs/guides/development/topic-naming-with-llm.md`

### Updated Documentation
- Update `.claude/docs/reference/standards/testing-protocols.md` with agent test timeout configuration
- Update `.claude/docs/reference/standards/code-standards.md` with library sourcing requirements
- Update command guides for affected commands (build, plan, debug, research, revise, errors, repair)

### Inline Documentation
- Add comments to `initialize_workflow_state_machine` function explaining setup order
- Add comments to agent retry logic explaining exponential backoff strategy
- Add comments to validation functions explaining error message format

## Dependencies

### External Dependencies
- Bash 4.0+ (for associative arrays in validation)
- jq (for error log querying)
- Error handling library (existing: `.claude/lib/core/error-handling.sh`)
- Workflow state machine library (existing: `.claude/lib/core/workflow-state-machine.sh`)

### Internal Dependencies
- Phase 2 depends on Phase 1 (state machine initialization requires sourcing fixes)
- Phase 3 can proceed in parallel with Phase 2 (agent timeout is independent)
- Phase 4 can proceed in parallel with Phases 2-3 (validation is independent)
- Phase 5 depends on Phase 3 (uses AGENT_TEST_TIMEOUT from Phase 3)
- Phase 6 depends on all previous phases (verification requires all fixes)
- Phase 7 depends on Phase 6 (error log update requires verification)

### Prerequisites
- Error analysis report (completed: `/home/benjamin/.config/.claude/specs/983_repair_20251130_100233/reports/001_error_analysis.md`)
- Error log with 140 logged errors (existing: `/home/benjamin/.config/.claude/data/logs/errors.jsonl`)
- Working error handling library with `mark_errors_resolved_for_plan` function

## Risk Management

### Technical Risks
- **Risk**: Refactoring state machine initialization may introduce new state transition errors
  - **Mitigation**: Create comprehensive state machine tests before refactoring
  - **Rollback**: Preserve original state machine functions during transition period

- **Risk**: Library sourcing changes may break commands in edge cases
  - **Mitigation**: Add defensive function availability checks before invocation
  - **Rollback**: Pre-commit validation prevents broken sourcing from being committed

- **Risk**: Agent timeout increases may mask underlying performance issues
  - **Mitigation**: Monitor agent performance metrics to identify slow agents
  - **Rollback**: Timeout configuration is environment variable-based for easy adjustment

### Process Risks
- **Risk**: 140 errors is a large number to verify manually
  - **Mitigation**: Automated verification queries in Phase 6
  - **Rollback**: Error log preserves original error context for re-analysis

- **Risk**: Fixes may not resolve all error instances (edge cases remain)
  - **Mitigation**: Phase 6 includes explicit verification of error counts
  - **Rollback**: Document remaining errors and create follow-up issues

## Notes

### Complexity Score Calculation
```
Score = (tasks × 1.0) + (phases × 5.0) + (hours × 0.5) + (dependencies × 2.0)
Score = (56 × 1.0) + (7 × 5.0) + (24 × 0.5) + (10 × 2.0)
Score = 56 + 35 + 12 + 20
Score = 123.0
```

Note: Complexity score of 123.0 indicates this is a Tier 2 (Phase Directory) level plan. Since this is a single-file Level 0 structure, consider using `/expand` during implementation if phase complexity grows.

### Implementation Notes
- Library sourcing fixes should be applied incrementally per command with testing after each change
- State machine refactoring requires coordination across multiple commands - consider phased rollout
- Agent timeout configuration should be exposed via environment variables for easy tuning
- Error log status updates should be atomic to prevent partial updates on failure
- Pre-commit hooks should be added last to avoid blocking development during implementation

### Expansion Hints
If this plan becomes too complex during implementation, consider using `/expand phase <path> <phase-number>` to break down complex phases into detailed stage files. Phase 2 (State Machine Initialization Refactor) is a candidate for expansion given its high complexity and cross-command coordination requirements.
