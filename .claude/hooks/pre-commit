#!/usr/bin/env bash
# pre-commit - Unified pre-commit hook for standards enforcement
# Version: 2.0.0
#
# Runs comprehensive standards validation on staged files:
# - Library sourcing pattern validation
# - Error suppression anti-pattern detection
# - Bash conditional safety checks
# - Task invocation pattern validation
# - Plan metadata compliance validation
# - README structure validation (warnings only)
# - Internal link validation (warnings only)
#
# Installation:
#   Option 1 (Symlink): ln -sf ../../.claude/hooks/pre-commit .git/hooks/pre-commit
#   Option 2 (Direct):  cp .claude/hooks/pre-commit .git/hooks/pre-commit
#
# Bypass: git commit --no-verify
#
# Exit codes:
#   0 - No blocking errors (warnings may be present)
#   1 - ERROR-level violations detected, commit blocked
#
# See: .claude/docs/reference/standards/enforcement-mechanisms.md

set -eo pipefail

# Colors for output
if [ -t 1 ]; then
  RED='\033[0;31m'
  GREEN='\033[0;32m'
  YELLOW='\033[0;33m'
  NC='\033[0m'
else
  RED=''
  GREEN=''
  YELLOW=''
  NC=''
fi

echo "=========================================="
echo "Pre-commit Standards Validation"
echo "=========================================="

# Detect project directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Check for staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM || true)

if [ -z "$STAGED_FILES" ]; then
  echo "No staged files, skipping validation"
  exit 0
fi

# Check for staged .claude/ files (only validate if relevant files staged)
STAGED_CLAUDE_FILES=$(echo "$STAGED_FILES" | grep '^\\.claude/' || true)
STAGED_COMMANDS=$(echo "$STAGED_FILES" | grep '^\\.claude/commands/.*\\.md$' || true)

if [ -z "$STAGED_CLAUDE_FILES" ]; then
  echo "No .claude/ files staged, skipping standards validation"
  exit 0
fi

echo "Validating staged files in .claude/..."
echo ""

# Track exit status
FINAL_EXIT=0

# Validator 1: Library sourcing (ERROR level - blocking)
LINTER_PATH="$PROJECT_DIR/.claude/scripts/lint/check-library-sourcing.sh"
if [ -n "$STAGED_COMMANDS" ] && [ -f "$LINTER_PATH" ]; then
  echo -e "Running: library-sourcing linter"

  # Convert to absolute paths
  STAGED_CMD_FILES=""
  for file in $STAGED_COMMANDS; do
    STAGED_CMD_FILES="$STAGED_CMD_FILES $PROJECT_DIR/$file"
  done

  LINTER_OUTPUT=$(bash "$LINTER_PATH" $STAGED_CMD_FILES 2>&1) || {
    echo -e "  ${RED}FAIL${NC}: Library sourcing violations detected"
    echo ""
    echo "$LINTER_OUTPUT" | sed 's/^/    /'
    echo ""
    FINAL_EXIT=1
  }

  if [ $? -eq 0 ] && [ -z "${LINTER_OUTPUT:-}" ] || echo "$LINTER_OUTPUT" | grep -q "PASSED"; then
    echo -e "  ${GREEN}PASS${NC}"
  fi
else
  echo -e "Skipping: library-sourcing (no command files staged)"
fi

# Validator 2: Error suppression (ERROR level - blocking)
SUPPRESSION_PATH="$PROJECT_DIR/.claude/tests/utilities/lint_error_suppression.sh"
if [ -n "$STAGED_COMMANDS" ] && [ -f "$SUPPRESSION_PATH" ]; then
  echo -e "Running: error-suppression linter"

  SUPPRESSION_OUTPUT=$(bash "$SUPPRESSION_PATH" 2>&1) || {
    echo -e "  ${RED}FAIL${NC}: Error suppression anti-patterns detected"
    echo ""
    echo "$SUPPRESSION_OUTPUT" | sed 's/^/    /'
    echo ""
    FINAL_EXIT=1
  }

  if echo "$SUPPRESSION_OUTPUT" | grep -q "PASS"; then
    echo -e "  ${GREEN}PASS${NC}"
  fi
else
  echo -e "Skipping: error-suppression (no command files staged)"
fi

# Validator 3: Bash conditionals (ERROR level - blocking)
CONDITIONALS_PATH="$PROJECT_DIR/.claude/tests/utilities/lint_bash_conditionals.sh"
if [ -f "$CONDITIONALS_PATH" ]; then
  echo -e "Running: bash-conditionals linter"

  CONDITIONALS_OUTPUT=$(bash "$CONDITIONALS_PATH" 2>&1) || {
    echo -e "  ${RED}FAIL${NC}: Preprocessing-unsafe conditionals detected"
    echo ""
    echo "$CONDITIONALS_OUTPUT" | sed 's/^/    /'
    echo ""
    FINAL_EXIT=1
  }

  if echo "$CONDITIONALS_OUTPUT" | grep -q "No violations found"; then
    echo -e "  ${GREEN}PASS${NC}"
  fi
fi

# Validator 4: Task invocation pattern (ERROR level - blocking)
TASK_INVOCATION_PATH="$PROJECT_DIR/.claude/scripts/lint-task-invocation-pattern.sh"
if [ -n "$STAGED_COMMANDS" ] && [ -f "$TASK_INVOCATION_PATH" ]; then
  echo -e "Running: task-invocation linter"

  # Convert to absolute paths
  STAGED_CMD_FILES=""
  for file in $STAGED_COMMANDS; do
    STAGED_CMD_FILES="$STAGED_CMD_FILES $PROJECT_DIR/$file"
  done

  TASK_OUTPUT=$(bash "$TASK_INVOCATION_PATH" --staged 2>&1) || {
    echo -e "  ${RED}FAIL${NC}: Task invocation pattern violations detected"
    echo ""
    echo "$TASK_OUTPUT" | sed 's/^/    /'
    echo ""
    FINAL_EXIT=1
  }

  if [ $? -eq 0 ]; then
    echo -e "  ${GREEN}PASS${NC}"
  fi
else
  echo -e "Skipping: task-invocation (no command files staged)"
fi

# Validator 5: Plan metadata validation (ERROR level - blocking)
STAGED_PLANS=$(echo "$STAGED_FILES" | grep '^\\.claude/specs/.*/plans/.*\\.md$' || true)
PLAN_METADATA_PATH="$PROJECT_DIR/.claude/scripts/lint/validate-plan-metadata.sh"

if [ -n "$STAGED_PLANS" ] && [ -f "$PLAN_METADATA_PATH" ]; then
  echo -e "Running: plan-metadata validator"

  # Validate each staged plan file
  PLAN_VALIDATION_FAILED=false
  for plan_file in $STAGED_PLANS; do
    PLAN_FULL_PATH="$PROJECT_DIR/$plan_file"
    PLAN_OUTPUT=$(bash "$PLAN_METADATA_PATH" "$PLAN_FULL_PATH" 2>&1) || {
      echo -e "  ${RED}FAIL${NC}: $plan_file"
      echo "$PLAN_OUTPUT" | sed 's/^/    /'
      echo ""
      PLAN_VALIDATION_FAILED=true
      FINAL_EXIT=1
    }
  done

  if [ "$PLAN_VALIDATION_FAILED" = false ]; then
    echo -e "  ${GREEN}PASS${NC}"
  fi
else
  echo -e "Skipping: plan-metadata (no plan files staged)"
fi

echo ""

# Summary
if [ $FINAL_EXIT -ne 0 ]; then
  echo "=========================================="
  echo -e "${RED}COMMIT BLOCKED${NC}: Standards violations detected"
  echo "=========================================="
  echo ""
  echo "Options:"
  echo "  1. Fix the violations listed above"
  echo "  2. Use 'git commit --no-verify' to bypass"
  echo "     (Document justification in commit message)"
  echo ""
  echo "See: .claude/docs/reference/standards/enforcement-mechanisms.md"
  exit 1
else
  echo "=========================================="
  echo -e "${GREEN}VALIDATION PASSED${NC}"
  echo "=========================================="
fi

exit 0
