# Himalaya Manual Setup Guide

**Purpose**: Manual configuration steps for completing Himalaya dual-account setup (Protonmail + Gmail).

---

## Overview

The Nix configuration in `home.nix` provides automated setup for:
- mbsync configuration (logos account)
- Himalaya CLI configuration (logos account)
- Maildir directory creation

This guide covers the manual steps you must complete:

1. **Install and configure Protonmail Bridge**
2. **Store Bridge password in keyring**

These steps require manual intervention because:
- Protonmail Bridge requires interactive login with your credentials
- Bridge password must be stored manually in the system keyring

---

## Prerequisites

Before starting:
- [ ] You have access to your Protonmail account credentials (benjamin@logos-labs.ai)
- [ ] You have access to your NixOS/home-manager configuration
- [ ] You can rebuild your system (`home-manager switch` or `nixos-rebuild switch`)
- [ ] GNOME keyring is installed and running (for storing passwords)

---

## Phase 2: Install and Configure Protonmail Bridge

### Step 1: Install Protonmail Bridge

**Option A: Via NixOS/home-manager (Recommended)**

Add to your Nix configuration:

```nix
# In configuration.nix or home.nix
environment.systemPackages = with pkgs; [
  protonmail-bridge
  # ... other packages
];

# Or for home-manager:
home.packages = with pkgs; [
  protonmail-bridge
];
```

Rebuild:
```bash
# For home-manager:
home-manager switch

# For NixOS system config:
sudo nixos-rebuild switch
```

**Option B: Manual Installation**

Download from: https://proton.me/mail/bridge

```bash
# Download and install
wget https://proton.me/download/bridge/protonmail-bridge_<version>_amd64.deb
# Or use the appropriate package for your system
```

**Verification**:
```bash
which protonmail-bridge
# Should output: /nix/store/.../bin/protonmail-bridge or similar
```

---

### Step 2: Start Protonmail Bridge

Launch the Bridge application:

```bash
protonmail-bridge
```

This opens the Bridge GUI.

**First-time setup**:
1. Bridge will ask you to log in
2. Click "Sign in" or "Add account"

---

### Step 3: Log In to Protonmail

In the Bridge GUI:

1. **Enter email**: `benjamin@logos-labs.ai`
2. **Enter password**: Your Protonmail password
3. **Two-factor authentication** (if enabled): Enter your 2FA code
4. Bridge will sync and set up the account

**Expected Result**: Account appears in Bridge with status "Connected"

---

### Step 4: Get Bridge Password

The Bridge password is NOT your Protonmail password - it's a separate password generated by Bridge for IMAP/SMTP access.

In the Bridge GUI:

1. Click on your account (`benjamin@logos-labs.ai`)
2. Go to **Settings** or **Account Settings**
3. Find **Mailbox password** section
4. Click **Copy** or **Show** to reveal the bridge password
5. **Copy this password** - you'll need it in the next step

**Important**: This password is auto-generated and looks like: `abc123def456ghi789jkl012mno345`

---

### Step 5: Store Bridge Password in Keyring

Open a terminal and run:

```bash
secret-tool store --label="Protonmail Bridge - Logos Labs" \
  service protonmail-bridge \
  username benjamin@logos-labs.ai
```

When prompted, **paste the bridge password** from Step 4.

**Verification**:
```bash
secret-tool lookup service protonmail-bridge username benjamin@logos-labs.ai
```

Should output the bridge password you just stored.

---

### Step 6: Verify Bridge is Running

Check that Bridge is listening on the correct ports:

```bash
ss -tlnp | grep -E '1143|1025'
```

**Expected Output**:
```
LISTEN    0    128    127.0.0.1:1143    0.0.0.0:*
LISTEN    0    128    127.0.0.1:1025    0.0.0.0:*
```

**Troubleshooting**:
- If ports aren't listening: Ensure Bridge is running and account is connected
- If ports are in use: Check for conflicts with `sudo lsof -i :1143` and `sudo lsof -i :1025`

---

### Step 7: Make Bridge Start Automatically (Optional)

To ensure Bridge starts on login:

**Option A: Via systemd user service**

Create `~/.config/systemd/user/protonmail-bridge.service`:

```ini
[Unit]
Description=Protonmail Bridge
After=network.target

[Service]
ExecStart=/nix/store/.../bin/protonmail-bridge --noninteractive
Restart=on-failure
RestartSec=10

[Install]
WantedBy=default.target
```

Enable and start:
```bash
systemctl --user enable protonmail-bridge.service
systemctl --user start protonmail-bridge.service
```

**Option B: Add to startup applications** (desktop environment)

Add `protonmail-bridge --noninteractive` to your desktop environment's startup applications.

---

## Phase 3: Nix Configuration for mbsync

**Note**: This configuration is already present in `home.nix`. The steps below are for reference only.

### Current State

Your `~/.mbsyncrc` is a Nix-managed symlink:
```
~/.mbsyncrc -> /nix/store/.../home-manager-files/.mbsyncrc
```

You cannot edit this file directly. You must update your Nix configuration.

---

### Step 1: Locate Your Nix mbsync Configuration

Find where your mbsync config is defined. Common locations:

```bash
# Check home-manager config
grep -r "mbsync" ~/.config/home-manager/ ~/.config/nixpkgs/

# Check NixOS config
grep -r "mbsync" /etc/nixos/
```

Likely location: `~/.config/home-manager/home.nix` or similar

---

### Step 2: Add Protonmail Account Configuration

Add this to your Nix mbsync configuration (e.g., in `programs.mbsync.accounts` or similar):

```nix
# In your home-manager configuration
programs.mbsync = {
  enable = true;
  # ... existing config ...

  extraConfig = ''
    # Existing Gmail config should already be here

    # Logos Labs IMAP account (via Protonmail Bridge)
    IMAPAccount logos
    Host 127.0.0.1
    Port 1143
    User benjamin@logos-labs.ai
    PassCmd "secret-tool lookup service protonmail-bridge username benjamin@logos-labs.ai"
    SSLType None
    AuthMechs LOGIN

    IMAPStore logos-remote
    Account logos

    MaildirStore logos-local
    Inbox ~/Mail/Logos/
    SubFolders Maildir++

    Channel logos-inbox
    Far :logos-remote:INBOX
    Near :logos-local:
    Create Both
    Expunge Both
    SyncState *

    Channel logos-sent
    Far :logos-remote:Sent
    Near :logos-local:Sent
    Create Both
    Expunge Both
    SyncState *

    Channel logos-drafts
    Far :logos-remote:Drafts
    Near :logos-local:Drafts
    Create Both
    Expunge Both
    SyncState *

    Channel logos-trash
    Far :logos-remote:Trash
    Near :logos-local:Trash
    Create Both
    Expunge Both
    SyncState *

    Channel logos-archive
    Far :logos-remote:Archive
    Near :logos-local:Archive
    Create Both
    Expunge Both
    SyncState *

    Group logos
    Channel logos-inbox
    Channel logos-sent
    Channel logos-drafts
    Channel logos-trash
    Channel logos-archive
  '';
};
```

**Alternative**: If you're using declarative account configuration:

```nix
programs.mbsync.accounts.logos = {
  host = "127.0.0.1";
  port = 1143;
  user = "benjamin@logos-labs.ai";
  passCmd = "secret-tool lookup service protonmail-bridge username benjamin@logos-labs.ai";
  ssl = false;
  authMechs = [ "LOGIN" ];

  imap = {
    host = "127.0.0.1";
    port = 1143;
  };

  maildir = {
    path = "~/Mail/Logos/";
    subFolders = "Maildir++";
  };

  # ... additional channel configuration
};
```

---

### Step 3: Rebuild Home-Manager

After adding the configuration:

```bash
home-manager switch
```

**Expected Output**:
- Home-manager rebuilds
- New symlink created for ~/.mbsyncrc
- No errors

**Verification**:
```bash
# Check that new config is in the symlinked file
grep -A 5 "IMAPAccount logos" ~/.mbsyncrc
```

Should show the Protonmail configuration.

---

### Step 4: Create Maildir Structure

Before syncing, create the local maildir directories:

```bash
mkdir -p ~/Mail/Logos/{INBOX,Sent,Drafts,Trash,Archive}/{cur,new,tmp}
```

**Verification**:
```bash
ls -la ~/Mail/Logos/
```

Should show: INBOX, Sent, Drafts, Trash, Archive directories

---

### Step 5: Test mbsync with Protonmail

**IMPORTANT**: Ensure Protonmail Bridge is running before testing!

Test individual channel:
```bash
mbsync -V logos-inbox
```

**Expected Output**:
```
C: 0/1  B: 0/1  M: +0/0 *0/0 #0/0  S: +0/0 *0/0 #0/0
Opening master box INBOX...
Opening slave box INBOX...
...
```

If successful, test full sync:
```bash
mbsync logos
```

**Troubleshooting**:
- **Authentication failed**: Check bridge password in keyring
- **Connection refused**: Ensure Bridge is running on port 1143
- **Unknown mailbox**: Protonmail folder names might differ (Sent vs "Sent Mail")

---

## Phase 4: Nix Configuration for Himalaya CLI

**Note**: This configuration is already present in `home.nix`. The steps below are for reference only.

### Current State

Your `~/.config/himalaya/config.toml` is also Nix-managed:
```
~/.config/himalaya/config.toml -> /nix/store/.../home-manager-files/.config/himalaya/config.toml
```

---

### Step 1: Locate Your Nix Himalaya Configuration

Find where your Himalaya config is defined:

```bash
# Check home-manager config
grep -r "himalaya" ~/.config/home-manager/ ~/.config/nixpkgs/

# Check NixOS config
grep -r "himalaya" /etc/nixos/
```

Likely location: `~/.config/home-manager/home.nix` or similar

---

### Step 2: Add Protonmail Account to Himalaya

Add this to your Nix Himalaya configuration:

```nix
programs.himalaya = {
  enable = true;
  # ... existing config ...

  accounts = {
    # Existing gmail account should already be here
    gmail = {
      # ... existing gmail config ...
    };

    # New Protonmail account
    logos = {
      default = false;
      email = "benjamin@logos-labs.ai";
      display-name = "Benjamin Brast-McKie";
      downloads-dir = "/home/benjamin/Downloads";

      # Maildir backend (synced by mbsync)
      backend = {
        type = "maildir";
        root-dir = "/home/benjamin/Mail/Logos";
        maildirpp = true;
      };

      # SMTP via Protonmail Bridge
      message = {
        send = {
          backend = {
            type = "smtp";
            host = "127.0.0.1";
            port = 1025;
            encryption = "none";
            auth = {
              type = "password";
              login = "benjamin@logos-labs.ai";
              password = {
                keyring = "protonmail-bridge benjamin@logos-labs.ai";
              };
            };
          };
        };
      };
    };
  };
};
```

**Alternative Raw TOML** (if using `programs.himalaya.extraConfig`):

```nix
programs.himalaya = {
  enable = true;
  extraConfig = ''
    # Existing gmail config should be here

    [accounts.logos]
    default = false
    email = "benjamin@logos-labs.ai"
    display-name = "Benjamin Brast-McKie"
    downloads-dir = "/home/benjamin/Downloads"

    backend.type = "maildir"
    backend.root-dir = "/home/benjamin/Mail/Logos"
    backend.maildirpp = true

    message.send.backend.type = "smtp"
    message.send.backend.host = "127.0.0.1"
    message.send.backend.port = 1025
    message.send.backend.encryption = "none"
    message.send.backend.auth.type = "password"
    message.send.backend.auth.login = "benjamin@logos-labs.ai"
    message.send.backend.auth.password.keyring = "protonmail-bridge benjamin@logos-labs.ai"
  '';
};
```

---

### Step 3: Rebuild Home-Manager

```bash
home-manager switch
```

**Expected Output**:
- Home-manager rebuilds successfully
- New symlink for ~/.config/himalaya/config.toml

**Verification**:
```bash
# Check that logos account is in config
grep -A 10 "\[accounts.logos\]" ~/.config/himalaya/config.toml
```

Should show the Protonmail account configuration.

---

### Step 4: Test Himalaya CLI with Protonmail

List accounts:
```bash
himalaya account list
```

**Expected Output**:
```
NAME   │ DEFAULT │ EMAIL
───────┼─────────┼──────────────────────────
gmail  │ yes     │ benbrastmckie@gmail.com
logos  │ no      │ benjamin@logos-labs.ai
```

Check account status:
```bash
himalaya check -a logos
```

**Expected Output**: No errors, account status OK

List emails from Protonmail:
```bash
himalaya list -a logos
```

**Expected Output**: List of emails from your Protonmail inbox

**Troubleshooting**:
- **Mailbox not found**: Ensure mbsync has synced emails to ~/Mail/Logos/
- **SMTP error**: Check Bridge is running, password is correct in keyring

---

## Post-Setup Verification

After completing all manual steps, verify the full setup:

### 1. Check Both Accounts

```bash
# List Gmail emails
himalaya list -a gmail

# List Protonmail emails
himalaya list -a logos
```

Both should work without errors.

---

### 2. Test Email Sync

```bash
# Sync all accounts
mbsync -a
```

Should sync both Gmail and Protonmail without authentication errors.

---

### 3. Test Neovim Integration

If you have Himalaya Neovim plugin configured, test account switching:

```vim
# Switch to Protonmail account
:HimalayaAccountSwitch logos

# List emails
:HimalayaListEmails

# Switch back to Gmail
:HimalayaAccountSwitch gmail
```

---

## Troubleshooting

### Protonmail Bridge Issues

**Bridge won't start**:
- Check logs: `~/.cache/protonmail/bridge/logs/`
- Try: `protonmail-bridge --cli` for CLI mode

**Can't log in**:
- Verify credentials on proton.me website
- Check 2FA is working
- Try clearing Bridge cache: `rm -rf ~/.cache/protonmail/bridge/`

**Ports already in use**:
```bash
# Find what's using the ports
sudo lsof -i :1143
sudo lsof -i :1025

# Kill if necessary or configure Bridge to use different ports
```

---

### mbsync Issues

**Authentication failed**:
```bash
# Verify password is stored correctly
secret-tool lookup service protonmail-bridge username benjamin@logos-labs.ai

# Re-store if needed (see Phase 2, Step 5)
```

**Connection refused**:
- Ensure Bridge is running: `ps aux | grep protonmail-bridge`
- Check ports: `ss -tlnp | grep -E '1143|1025'`

**SSL/TLS errors**:
- Verify `SSLType None` in mbsync config (Bridge runs locally without TLS)

---

### Himalaya Issues

**Account not found**:
```bash
# Verify config was updated
cat ~/.config/himalaya/config.toml | grep -A 10 logos
```

**Mailbox errors**:
```bash
# Check maildir exists and has emails
ls -la ~/Mail/Logos/INBOX/cur/
ls -la ~/Mail/Logos/INBOX/new/
```

**SMTP send errors**:
- Verify Bridge SMTP port (1025) is listening
- Check password in keyring matches Bridge password

---

## Next Steps

After completing this manual setup:

1. Test email sync with both accounts: `mbsync -a`
2. Verify Himalaya can access both accounts: `himalaya account list`
3. Configure Neovim Himalaya plugin if desired
4. Set up automatic Bridge startup (optional)

---

## Reference

### Key Files and Locations

| Purpose | Path | Type |
|---------|------|------|
| mbsync config | `~/.mbsyncrc` | Nix-managed symlink |
| Himalaya config | `~/.config/himalaya/config.toml` | Nix-managed symlink |
| Gmail maildir | `~/Mail/Gmail/` | Directory |
| Protonmail maildir | `~/Mail/Logos/` | Directory |
| Bridge logs | `~/.cache/protonmail/bridge/logs/` | Directory |
| Keyring passwords | GNOME keyring (secret-tool) | System service |

### Important Commands

```bash
# Start Protonmail Bridge
protonmail-bridge

# Rebuild home-manager
home-manager switch

# Sync all email
mbsync -a

# Sync specific account
mbsync logos
mbsync gmail

# Himalaya commands
himalaya account list
himalaya list -a logos
himalaya check -a logos

# Keyring management
secret-tool store service <service> username <username>
secret-tool lookup service <service> username <username>
```

---

## Completion Checklist

Verify the setup is complete:

- [ ] Protonmail Bridge installed
- [ ] Logged in to benjamin@logos-labs.ai via Bridge
- [ ] Bridge password stored in keyring
- [ ] Bridge running and listening on ports 1143/1025
- [ ] Home-manager configuration includes Protonmail account
- [ ] Home-manager rebuilt successfully
- [ ] Maildir structure created at ~/Mail/Logos/
- [ ] mbsync syncs Protonmail without errors
- [ ] Himalaya lists emails from both accounts
- [ ] (Optional) Bridge starts automatically on login
